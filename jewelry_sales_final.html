<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theia Jewelz - Sales Management System</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366F1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Theia Jewelz">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Theia Jewelz">

    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192x192.png">

    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- Modern Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* ======== MODERN DESIGN SYSTEM ======== */
        :root {
            /* Enhanced Color Palette */
            --primary-600: #6366F1;
            --primary-500: #8B5CF6;
            --primary-400: #A78BFA;
            --primary-300: #C4B5FD;
            --primary-100: #EDE9FE;
            --primary-50: #F5F3FF;

            --secondary-600: #DB2777;
            --secondary-500: #EC4899;
            --secondary-400: #F472B6;
            --secondary-300: #F9A8D4;
            --secondary-100: #FCE7F3;

            --accent-600: #059669;
            --accent-500: #10B981;
            --accent-400: #34D399;
            --accent-300: #6EE7B7;
            --accent-100: #D1FAE5;

            --neutral-900: #111827;
            --neutral-800: #1F2937;
            --neutral-700: #374151;
            --neutral-600: #4B5563;
            --neutral-500: #6B7280;
            --neutral-400: #9CA3AF;
            --neutral-300: #D1D5DB;
            --neutral-200: #E5E7EB;
            --neutral-100: #F3F4F6;
            --neutral-50: #F9FAFB;

            --error-600: #DC2626;
            --error-500: #EF4444;
            --error-100: #FEE2E2;

            --warning-600: #D97706;
            --warning-500: #F59E0B;
            --warning-100: #FEF3C7;

            --success-600: #059669;
            --success-500: #10B981;
            --success-100: #D1FAE5;

            /* Interactive Colors */
            --interactive-hover: #4F46E5;
            --interactive-active: #3730A3;
            --interactive-focus: #6366F1;
            --interactive-disabled: #9CA3AF;

            /* Glass Effect */
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: rgba(0, 0, 0, 0.1);

            /* Animations */
            --bounce-scale: 1.05;
            --slide-distance: 10px;

            /* Typography */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-secondary: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            --space-20: 5rem;

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 300ms ease-in-out;
            --transition-slow: 500ms ease-in-out;
        }

        /* ======== RESET & BASE STYLES ======== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *:focus {
            outline: 2px solid var(--primary-600);
            outline-offset: 2px;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-primary);
            font-size: 16px;
            line-height: 1.6;
            color: var(--neutral-800);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 35%, #f093fb 70%, #f5576c 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            padding: var(--space-4);
            overflow-x: hidden;
            position: relative;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="white" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
            pointer-events: none;
            z-index: 0;
        }

        /* ======== LOADING SPINNER ======== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--neutral-300);
            border-radius: 50%;
            border-top-color: var(--primary-600);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ======== STATUS DISPLAY ======== */
        .database-status, .save-status {
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            transition: all var(--transition-normal);
        }

        .database-status.success {
            background: var(--success-100);
            color: var(--success-600);
        }

        .database-status.warning {
            background: var(--warning-100);
            color: var(--warning-600);
        }

        .database-status.error {
            background: var(--error-100);
            color: var(--error-600);
        }

        .save-status.loading {
            background: var(--primary-100);
            color: var(--primary-600);
        }

        .save-status.success {
            background: var(--success-100);
            color: var(--success-600);
        }

        .save-status.error {
            background: var(--error-100);
            color: var(--error-600);
        }

        /* ======== MAIN CONTAINER ======== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--glass-bg);
            border-radius: var(--radius-2xl);
            box-shadow:
                var(--shadow-2xl),
                0 0 0 1px var(--glass-border),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.5);
            overflow: hidden;
            backdrop-filter: blur(20px);
            animation: slideInUp 0.6s ease-out;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
            z-index: 1;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 30px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        /* Sales table animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced table styling */
        .sales-table tbody tr:hover {
            background: #e3f2fd !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .sales-table {
            transition: all 0.3s ease;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ======== HEADER ======== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            text-align: center;
            padding: var(--space-8) var(--space-6);
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-content {
            flex: 1;
            text-align: center;
        }

        .settings-btn {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            backdrop-filter: blur(10px);
            font-size: 1.2rem;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.05"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .header h1 {
            font-family: var(--font-secondary);
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            font-weight: 800;
            margin: 0;
            position: relative;
            z-index: 1;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            animation: headerPulse 3s ease-in-out infinite;
        }

        .app-title {
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .app-title:hover {
            transform: scale(1.02);
            text-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        @keyframes headerPulse {
            0%, 100% {
                transform: scale(1);
                text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }
            50% {
                transform: scale(1.02);
                text-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.2);
            }
        }

        .header .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: var(--space-2);
            position: relative;
            z-index: 1;
        }

        /* ======== NAVIGATION TABS ======== */
        .tabs {
            display: flex;
            background: var(--glass-bg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(20px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: var(--space-4) var(--space-3);
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-family: var(--font-primary);
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--neutral-600);
            transition: all var(--transition-normal);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            min-height: 60px;
            overflow: hidden;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            margin: 0 2px;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .tab:hover {
            color: var(--primary-700);
            transform: translateY(-2px);
        }

        .tab:hover::before {
            opacity: 0.05;
        }

        .tab.active {
            color: white;
            font-weight: 600;
            transform: translateY(-1px);
        }

        .tab.active::before {
            opacity: 1;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-500);
            z-index: 1;
            box-shadow: 0 0 10px var(--accent-500);
        }

        .tab span, .tab i {
            position: relative;
            z-index: 1;
        }

        .tab i {
            font-size: 1.1rem;
        }

        /* ======== SETTINGS MODAL ======== */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100000;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease-out;
            overflow: hidden;
        }

        .settings-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: var(--radius-xl);
            width: 90vw;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            z-index: 100001;
        }

        .settings-header {
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            color: white;
            padding: var(--space-6);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-settings {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .close-settings:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .settings-body {
            padding: var(--space-6);
            max-height: calc(90vh - 120px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .settings-section {
            margin-bottom: var(--space-8);
            padding: var(--space-5);
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .settings-section h3 {
            margin: 0 0 var(--space-4) 0;
            color: var(--primary-600);
            font-weight: 600;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .settings-tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            background: rgba(255, 255, 255, 0.3);
            padding: var(--space-1);
            border-radius: var(--radius-md);
        }

        .settings-tab {
            flex: 1;
            padding: var(--space-3);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-weight: 500;
            color: var(--neutral-600);
        }

        .settings-tab.active {
            background: white;
            color: var(--primary-600);
            box-shadow: var(--shadow-sm);
        }

        .settings-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }

        .custom-field {
            display: flex;
            gap: var(--space-3);
            align-items: center;
            padding: var(--space-3);
            background: white;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            border: 1px solid var(--neutral-200);
        }

        .custom-field input, .custom-field select {
            flex: 1;
            padding: var(--space-2);
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .delete-field-btn {
            background: var(--error-500);
            color: white;
            border: none;
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .delete-field-btn:hover {
            background: var(--error-600);
            transform: scale(1.05);
        }

        .add-field-btn {
            background: var(--accent-500);
            color: white;
            border: none;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .add-field-btn:hover {
            background: var(--accent-600);
            transform: translateY(-2px);
        }

        .settings-input {
            width: 100%;
            padding: var(--space-3);
            border: 2px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all var(--transition-fast);
        }

        .settings-input:focus {
            border-color: var(--primary-600);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .help-content {
            background: var(--primary-50);
            border: 1px solid var(--primary-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-top: var(--space-3);
        }

        .help-content h4 {
            color: var(--primary-600);
            margin: 0 0 var(--space-2) 0;
            font-size: 1rem;
        }

        .help-content p {
            margin: 0 0 var(--space-2) 0;
            color: var(--neutral-700);
            font-size: 0.9rem;
        }

        .help-content ul {
            margin: 0;
            padding-left: var(--space-4);
            color: var(--neutral-700);
            font-size: 0.9rem;
        }

        .save-settings-btn {
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            color: white;
            border: none;
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin: var(--space-6) auto 0;
        }

        .save-settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .custom-fields-container {
            margin-top: var(--space-4);
            padding: var(--space-4);
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .custom-fields-container h4 {
            margin: 0 0 var(--space-4) 0;
            color: var(--primary-600);
            font-weight: 600;
        }

        .field-placement-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 20000;
            backdrop-filter: blur(5px);
            overflow: hidden;
        }

        .field-placement-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            width: 90vw;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            z-index: 20001;
        }

        .field-placement-header {
            text-align: center;
            margin-bottom: var(--space-6);
        }

        .field-placement-header h3 {
            margin: 0 0 var(--space-2) 0;
            color: var(--primary-600);
            font-size: 1.4rem;
        }

        .field-placement-header p {
            margin: 0;
            color: var(--neutral-600);
            font-size: 0.9rem;
        }

        .placement-options {
            display: grid;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
        }

        .placement-option {
            display: flex;
            align-items: center;
            padding: var(--space-4);
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--neutral-50);
        }

        .placement-option:hover {
            border-color: var(--primary-400);
            background: var(--primary-50);
        }

        .placement-option.selected {
            border-color: var(--primary-600);
            background: var(--primary-100);
        }

        .placement-option input[type="radio"] {
            margin-right: var(--space-3);
            scale: 1.2;
        }

        .placement-option-content {
            flex: 1;
        }

        .placement-option-title {
            font-weight: 600;
            color: var(--neutral-800);
            margin-bottom: var(--space-1);
        }

        .placement-option-desc {
            font-size: 0.85rem;
            color: var(--neutral-600);
        }

        .field-config-section {
            margin-bottom: var(--space-6);
            padding: var(--space-4);
            background: var(--neutral-50);
            border-radius: var(--radius-md);
            border: 1px solid var(--neutral-200);
        }

        .field-config-section h4 {
            margin: 0 0 var(--space-3) 0;
            color: var(--primary-600);
            font-size: 1.1rem;
        }

        .field-config-row {
            display: grid;
            grid-template-columns: 1fr 120px 80px;
            gap: var(--space-3);
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .field-config-row:last-child {
            margin-bottom: 0;
        }

        .placement-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }

        .placement-btn {
            padding: var(--space-3) var(--space-5);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .placement-btn.cancel {
            background: var(--neutral-200);
            color: var(--neutral-700);
        }

        .placement-btn.cancel:hover {
            background: var(--neutral-300);
        }

        .placement-btn.confirm {
            background: var(--primary-600);
            color: white;
        }

        .placement-btn.confirm:hover {
            background: var(--primary-700);
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive adjustments for settings modal */
        @media (max-width: 768px) {
            .settings-content {
                width: 95vw;
                max-height: 95vh;
                margin: 0;
            }

            .settings-body {
                padding: var(--space-4);
                max-height: calc(95vh - 100px);
            }

            .settings-header {
                padding: var(--space-4);
            }

            .settings-header h2 {
                font-size: 1.2rem;
            }

            .field-placement-content {
                width: 95vw;
                padding: var(--space-4);
            }

            .field-config-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
            }

            .placement-actions {
                flex-direction: column;
            }

            .placement-btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .settings-tabs {
                flex-direction: column;
            }

            .settings-tab {
                text-align: center;
            }
        }

        /* ======== TAB CONTENT ======== */
        .tab-content {
            display: none;
            padding: var(--space-8) var(--space-6);
            min-height: 600px;
            animation: fadeIn 0.4s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ======== MOBILE NAVIGATION ======== */
        .mobile-tabs-container {
            margin-bottom: var(--space-4);
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--space-2);
            box-shadow: var(--shadow-md);
        }

        .mobile-tabs-wrapper {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: var(--space-1);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .mobile-tabs-wrapper::-webkit-scrollbar {
            display: none;
        }

        .mobile-tab {
            flex: 1;
            min-width: 80px;
            background: none;
            border: none;
            color: var(--neutral-600);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-3) var(--space-2);
            border-radius: var(--radius-sm);
            white-space: nowrap;
        }

        .mobile-tab i {
            font-size: 1.1rem;
        }

        .mobile-tab:hover {
            color: var(--primary-600);
            background: rgba(255, 255, 255, 0.1);
        }

        .mobile-tab.active {
            color: white;
            background: var(--primary-600);
            box-shadow: var(--shadow-sm);
        }



        /* ======== RESPONSIVE DESIGN ======== */
        @media (max-width: 768px) {
            .mobile-tabs-container {
                margin-bottom: var(--space-3);
            }

            .mobile-tab {
                font-size: 0.8rem;
                padding: var(--space-2);
            }

            .mobile-tab i {
                font-size: 1rem;
            }

            .tab-content {
                padding: var(--space-4);
            }
        }

        @media (max-width: 480px) {
            .mobile-tabs-container {
                display: block;
            }

            .tab-content {
                padding: var(--space-3);
            }
        }

        /* ======== FORM COMPONENTS ======== */
        .form-section {
            background: var(--glass-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all var(--transition-normal);
            position: relative;
            overflow: visible;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.2);
        }

        .form-section h3 {
            font-family: var(--font-secondary);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--neutral-800);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .form-section h3 i {
            color: var(--primary-600);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-4);
        }

        .form-group {
            margin-bottom: var(--space-5);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: 500;
            color: var(--neutral-700);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group label.required::after {
            content: '*';
            color: var(--error-500);
            margin-left: var(--space-1);
        }

        .form-control {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: var(--font-primary);
            transition: all var(--transition-normal);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
            color: var(--neutral-800);
            backdrop-filter: blur(10px);
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow:
                0 0 0 4px rgba(102, 126, 234, 0.2),
                0 8px 16px -4px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.5);
            transform: translateY(-3px) scale(1.01);
            background: rgba(255, 255, 255, 0.98);
            animation: inputFocus 0.3s ease;
        }

        @keyframes inputFocus {
            0% {
                transform: translateY(0) scale(1);
                box-shadow: none;
            }
            50% {
                transform: translateY(-1px) scale(1.005);
            }
            100% {
                transform: translateY(-3px) scale(1.01);
                box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2), 0 8px 16px -4px rgba(0, 0, 0, 0.15);
            }
        }

        .form-control:hover {
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .form-control:invalid {
            border-color: var(--error-500);
        }

        .form-control:disabled {
            background: var(--neutral-100);
            color: var(--neutral-500);
            cursor: not-allowed;
        }

        .form-control::placeholder {
            color: var(--neutral-400);
        }

        .form-error {
            display: none;
            color: var(--error-600);
            font-size: 0.875rem;
            margin-top: var(--space-1);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .form-error i {
            font-size: 0.8rem;
        }

        .form-success {
            display: none;
            color: var(--success-600);
            font-size: 0.875rem;
            margin-top: var(--space-1);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .form-success i {
            font-size: 0.8rem;
        }

        /* ======== PURCHASE FORM STYLES ======== */
        #add-purchase-form input:focus,
        #add-purchase-form textarea:focus {
            border-color: var(--primary-600) !important;
            box-shadow: 0 0 0 3px var(--primary-100) !important;
            outline: none !important;
        }

        #add-purchase-form input:hover,
        #add-purchase-form textarea:hover {
            border-color: var(--neutral-400) !important;
        }

        #add-purchase-form .required-field {
            position: relative;
        }

        #add-purchase-form .required-field::after {
            content: '*';
            color: var(--error-500);
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
        }

        /* ======== BUTTON COMPONENTS ======== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-primary);
            font-size: 0.95rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            user-select: none;
            min-height: 44px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-normal);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px) scale(var(--bounce-scale));
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.2);
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn.loading {
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Button Variants */
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow:
                var(--shadow-md),
                0 0 25px rgba(102, 126, 234, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover::after {
            left: 100%;
        }

        .btn-primary::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--interactive-hover), var(--primary-600));
            transform: translateY(-3px) scale(var(--bounce-scale));
            box-shadow:
                var(--shadow-xl),
                0 0 30px rgba(99, 102, 241, 0.5);
        }

        /* Special styling for Add Sale Record button - no hover color change */
        .btn-primary.add-sale-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            transform: none;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-600), var(--secondary-500));
            color: white;
            box-shadow:
                var(--shadow-md),
                0 0 20px rgba(219, 39, 119, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--secondary-700), var(--secondary-600));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent-600), var(--accent-500));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-accent:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--accent-700), var(--accent-600));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-600);
            color: var(--primary-600);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--primary-600);
            color: white;
            transform: translateY(-1px);
        }

        .btn-ghost {
            background: transparent;
            color: var(--neutral-600);
            box-shadow: none;
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--neutral-100);
            color: var(--neutral-800);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-600), var(--error-500));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--error-700), var(--error-600));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Button Sizes */
        .btn-sm {
            padding: var(--space-2) var(--space-4);
            font-size: 0.875rem;
            min-height: 36px;
        }

        .btn-lg {
            padding: var(--space-4) var(--space-8);
            font-size: 1.1rem;
            min-height: 52px;
        }

        .btn-full {
            width: 100%;
        }

        /* Button Groups */
        .btn-group {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-4);
        }

        .btn-group .btn {
            flex: 1;
        }

        /* ======== CARD COMPONENTS ======== */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            overflow: hidden;
            transition: var(--transition-normal);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--neutral-200);
            background: var(--neutral-50);
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--neutral-800);
        }

        .card-body {
            padding: var(--space-5);
        }

        .card-footer {
            padding: var(--space-4) var(--space-5);
            background: var(--neutral-50);
            border-top: 1px solid var(--neutral-200);
        }

        /* Sales Item Cards */
        .sales-item {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid var(--neutral-200);
            border-left: 6px solid #667eea;
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            position: relative;
            transition: all var(--transition-normal);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .sales-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(240, 147, 251, 0.1));
            border-radius: 50%;
            transform: translate(50%, -50%);
            transition: all var(--transition-normal);
        }

        .sales-item:hover {
            border-left-color: #f093fb;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            transform: translateX(8px) translateY(-2px);
        }

        .sales-item:hover::before {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(240, 147, 251, 0.2));
        }

        .sales-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-3);
        }

        .sales-item h4 {
            color: var(--neutral-800);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .sales-item-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .sales-item-info-item {
            display: flex;
            flex-direction: column;
        }

        .sales-item-info-label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--neutral-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-1);
        }

        .sales-item-info-value {
            font-size: 0.95rem;
            color: var(--neutral-700);
            font-weight: 500;
        }

        .sales-item-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-600);
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-5);
            margin-bottom: var(--space-8);
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: all var(--transition-normal);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
            animation: statCardGlow 2s ease-in-out infinite;
        }

        @keyframes statCardGlow {
            0%, 100% {
                box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 20px 40px rgba(102, 126, 234, 0.6), 0 0 30px rgba(240, 147, 251, 0.3);
            }
        }

        .stat-card-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-3);
            opacity: 0.9;
        }

        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--space-2);
            position: relative;
            z-index: 1;
        }

        .stat-card p {
            font-size: 0.95rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            height: 450px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--neutral-200);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--neutral-800);
        }

        /* Customer Item Cards */
        .customer-item {
            background: white;
            border: 1px solid var(--neutral-200);
            border-left: 4px solid var(--secondary-600);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            position: relative;
            transition: var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .customer-item:hover {
            border-left-color: var(--accent-500);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        /* Empty State */
        .no-data {
            text-align: center;
            color: var(--neutral-500);
            font-style: italic;
            padding: var(--space-16);
            font-size: 1.1rem;
            background: var(--neutral-50);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--neutral-300);
        }

        .no-data i {
            font-size: 3rem;
            color: var(--neutral-400);
            margin-bottom: var(--space-4);
            display: block;
        }

        /* Action Buttons */
        .action-buttons {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            display: flex;
            gap: var(--space-2);
            z-index: 2;
        }

        .edit-btn, .delete-btn {
            padding: var(--space-2) var(--space-3);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .edit-btn {
            background: var(--primary-600);
            color: white;
        }

        .edit-btn:hover {
            background: var(--primary-700);
            transform: translateY(-1px);
        }

        .delete-btn {
            background: var(--error-600);
            color: white;
        }

        .delete-btn:hover {
            background: var(--error-700);
            transform: translateY(-1px);
        }

        /* ======== SCROLLABLE CONTAINERS ======== */
        .scrollable-container {
            max-height: 650px;
            overflow-y: auto;
            padding-right: var(--space-2);
            scroll-behavior: smooth;
        }

        .scrollable-container::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-container::-webkit-scrollbar-track {
            background: var(--neutral-200);
            border-radius: var(--radius-lg);
        }

        .scrollable-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            border-radius: var(--radius-lg);
            border: 2px solid var(--neutral-200);
        }

        .scrollable-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
        }

        /* ======== SEARCH AND FILTER ======== */
        .filter-section {
            background: var(--neutral-50);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-6);
        }

        .filter-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .filter-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--neutral-800);
            margin: 0;
        }

        .search-input {
            position: relative;
        }

        .search-input input {
            width: 100%;
            padding: var(--space-3) var(--space-4) var(--space-3) var(--space-12);
            border: 2px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: var(--transition-normal);
            background: white;
        }

        .search-input input:focus {
            outline: none;
            border-color: var(--primary-600);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .search-input i {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--neutral-400);
            font-size: 1.1rem;
        }

        /* ======== NOTIFICATIONS & TOASTS ======== */
        .toast {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            background: var(--glass-bg);
            border-radius: var(--radius-lg);
            box-shadow:
                var(--shadow-xl),
                0 0 30px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: var(--space-4);
            max-width: 400px;
            z-index: 1000;
            transform: translateX(calc(100% + var(--space-4)));
            opacity: 0;
            transition: all var(--transition-normal);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            0% {
                transform: translateX(calc(100% + var(--space-4))) scale(0.9);
                opacity: 0;
            }
            50% {
                transform: translateX(-10px) scale(1.02);
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .toast-success {
            border-left: 4px solid var(--success-500);
            background: linear-gradient(135deg,
                rgba(16, 185, 129, 0.1) 0%,
                rgba(255, 255, 255, 0.95) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .toast-success::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--success-400), var(--success-600));
            box-shadow: 0 0 10px var(--success-500);
        }

        .toast-error {
            border-left: 4px solid var(--error-500);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-500);
        }

        .toast-info {
            border-left: 4px solid var(--primary-500);
        }

        /* ======== RESPONSIVE DESIGN ======== */
        /* Tablet Styles */
        @media (max-width: 768px) {
            body {
                padding: var(--space-2);
                font-size: 15px;
            }

            .container {
                margin: 0;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
            }

            .header {
                padding: var(--space-5) var(--space-4);
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header .subtitle {
                font-size: 0.9rem;
            }

            .tabs {
                flex-wrap: wrap;
                position: relative;
            }

            .tab {
                flex: 1;
                min-width: 120px;
                font-size: 0.85rem;
                padding: var(--space-3) var(--space-2);
            }

            .tab i {
                font-size: 1rem;
            }

            .tab-content {
                padding: var(--space-5) var(--space-4);
                min-height: 500px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }

            .form-section {
                padding: var(--space-5);
                margin-bottom: var(--space-5);
            }

            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-3);
            }

            .btn-group {
                flex-direction: column;
                gap: var(--space-2);
            }

            .sales-item-info {
                grid-template-columns: 1fr;
            }

            /* Make buttons more touch-friendly */
            .btn {
                min-height: 48px;
                padding: var(--space-3) var(--space-4);
                font-size: 1rem;
            }

            /* Customer search results */
            #customer-search-results {
                max-height: 250px;
            }

            /* Toast notifications positioning */
            .toast {
                top: var(--space-2);
                right: var(--space-2);
                left: var(--space-2);
                max-width: none;
            }
        }

        /* Mobile Styles */
        @media (max-width: 480px) {
            body {
                padding: var(--space-1);
                font-size: 14px;
            }

            .container {
                margin: 0;
                border-radius: var(--radius-md);
            }

            .header {
                padding: var(--space-4) var(--space-3);
            }

            .header h1 {
                font-size: 1.5rem;
                line-height: 1.2;
            }

            .header .subtitle {
                font-size: 0.85rem;
                margin-top: var(--space-1);
            }

            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding-bottom: 2px;
                background: var(--neutral-50);
                border-bottom: 1px solid var(--neutral-200);
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                min-width: 100px;
                font-size: 0.8rem;
                padding: var(--space-3) var(--space-2);
                white-space: nowrap;
                flex-shrink: 0;
                gap: var(--space-1);
                min-height: 65px;
                flex-direction: column;
                line-height: 1.1;
                text-align: center;
            }

            .tab span {
                display: block;
                margin-top: var(--space-1);
                font-size: 0.75rem;
                line-height: 1.1;
                text-align: center;
            }

            .tab i {
                font-size: 0.9rem;
            }

            .tab-content {
                padding: var(--space-4) var(--space-3);
                min-height: 400px;
            }

            .form-section {
                padding: var(--space-4);
                margin-bottom: var(--space-4);
                border-radius: var(--radius-md);
            }

            .form-section h3 {
                font-size: 1.1rem;
                margin-bottom: var(--space-3);
            }

            .form-group {
                margin-bottom: var(--space-4);
            }

            .form-control {
                padding: var(--space-3);
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: var(--radius-md);
                min-height: 44px; /* iOS touch target minimum */
            }

            .form-control:focus {
                border-width: 2px;
                transform: none; /* Removes transform to prevent layout issues */
            }

            /* Buttons optimized for mobile */
            .btn {
                min-height: 50px;
                padding: var(--space-4);
                font-size: 1rem;
                font-weight: 600;
                border-radius: var(--radius-md);
                width: 100%;
                margin-bottom: var(--space-2);
            }

            .btn-group {
                flex-direction: column;
                width: 100%;
            }

            .btn-group .btn {
                margin-bottom: var(--space-2);
            }

            /* Dashboard stats */
            .dashboard-stats {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }

            .stat-card {
                padding: var(--space-4);
                text-align: center;
            }

            .stat-card h3 {
                font-size: 1.8rem;
            }

            .stat-card p {
                font-size: 0.9rem;
            }

            /* Search input mobile optimization */
            .search-input input {
                padding: var(--space-3) var(--space-4) var(--space-3) var(--space-10);
                font-size: 16px;
                min-height: 44px;
            }

            .search-input i {
                left: var(--space-3);
                font-size: 1rem;
            }

            /* Customer search results */
            #customer-search-results {
                max-height: 200px;
                border-radius: var(--radius-md);
            }

            .customer-search-result {
                padding: var(--space-4);
            }

            .customer-name {
                font-size: 1rem;
            }

            .customer-details {
                font-size: 0.85rem;
            }

            /* Filter section */
            .filter-section {
                padding: var(--space-4);
                margin-bottom: var(--space-4);
                border-radius: var(--radius-md);
            }

            .filter-header h3 {
                font-size: 1rem;
            }

            /* Sales records table/list mobile view */
            .sales-item {
                flex-direction: column;
                padding: var(--space-4);
                border-radius: var(--radius-md);
                margin-bottom: var(--space-3);
            }

            .sales-item-info {
                grid-template-columns: 1fr;
                gap: var(--space-2);
                margin-bottom: var(--space-3);
            }

            .sales-item-actions {
                justify-content: stretch;
                gap: var(--space-2);
            }

            .edit-btn, .delete-btn {
                flex: 1;
                min-height: 40px;
                font-size: 0.85rem;
            }

            /* Toast notifications for mobile */
            .toast {
                top: var(--space-2);
                right: var(--space-2);
                left: var(--space-2);
                max-width: none;
                padding: var(--space-3);
                font-size: 0.9rem;
                border-radius: var(--radius-md);
            }

            /* Charts container */
            .chart-container {
                margin: var(--space-3) 0;
                padding: var(--space-3);
            }

            /* Make scrollable containers touch-friendly */
            .scrollable-container {
                max-height: 400px;
                -webkit-overflow-scrolling: touch;
            }

            .scrollable-container::-webkit-scrollbar {
                width: 94px;
            }
        }

        /* Extra small devices */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.35rem;
            }

            .tab {
                min-width: 90px;
                font-size: 0.7rem;
                line-height: 1;
            }

            .tab i {
                font-size: 0.9rem;
                padding: var(--space-2) var(--space-2);
            }

            .tab span {
                font-size: 0.7rem;
                line-height: 1;
            }

        /* Very small screens - Show abbreviated text */
        @media (max-width: 320px) {
            .tab {
                min-width: 75px;
                padding: var(--space-2) var(--space-1);
            }

            .tab span {
                font-size: 0.65rem;
                line-height: 0.9;
            }

            /* Abbreviate long tab names for very small screens */
            .tab:nth-child(1) span::after { content: "Entry"; }
            .tab:nth-child(1) span { font-size: 0; }
            .tab:nth-child(1) span::after { font-size: 0.65rem; }

            .tab:nth-child(2) span::after { content: "Recent"; }
            .tab:nth-child(2) span { font-size: 0; }
            .tab:nth-child(2) span::after { font-size: 0.65rem; }

            .tab:nth-child(3) span::after { content: "Stats"; }
            .tab:nth-child(3) span { font-size: 0; }
            .tab:nth-child(3) span::after { font-size: 0.65rem; }

            .tab:nth-child(4) span::after { content: "Contacts"; }
            .tab:nth-child(4) span { font-size: 0; }
            .tab:nth-child(4) span::after { font-size: 0.65rem; }

            .tab:nth-child(5) span::after { content: "Charts"; }
            .tab:nth-child(5) span { font-size: 0; }
            .tab:nth-child(5) span::after { font-size: 0.65rem; }
        }

            .tab i {
                font-size: 0.9rem;
            }

            .form-section {
                padding: var(--space-3);
            }

            .btn {
                min-height: 48px;
                font-size: 0.9rem;
            }

            .dashboard-stats {
                gap: var(--space-2);
            }

            .stat-card {
                padding: var(--space-3);
            }

            .stat-card h3 {
                font-size: 1.5rem;
            }
        }

        /* Very small screens - Show abbreviated text */
        @media (max-width: 320px) {
            .tab {
                min-width: 75px;
                padding: var(--space-2) var(--space-1);
            }

            .tab span {
                font-size: 0.65rem;
                line-height: 0.9;
            }

            /* Abbreviate long tab names for very small screens */
            .tab:nth-child(1) span::after { content: "Entry"; }
            .tab:nth-child(1) span { font-size: 0; }
            .tab:nth-child(1) span::after { font-size: 0.65rem; }

            .tab:nth-child(2) span::after { content: "Recent"; }
            .tab:nth-child(2) span { font-size: 0; }
            .tab:nth-child(2) span::after { font-size: 0.65rem; }

            .tab:nth-child(3) span::after { content: "Stats"; }
            .tab:nth-child(3) span { font-size: 0; }
            .tab:nth-child(3) span::after { font-size: 0.65rem; }

            .tab:nth-child(4) span::after { content: "Contacts"; }
            .tab:nth-child(4) span { font-size: 0; }
            .tab:nth-child(4) span::after { font-size: 0.65rem; }

            .tab:nth-child(5) span::after { content: "Charts"; }
            .tab:nth-child(5) span { font-size: 0; }
            .tab:nth-child(5) span::after { font-size: 0.65rem; }
        }

        /* Enhanced mobile navigation */
        @media (max-width: 480px) {
            /* Add horizontal scroll indicator */
            .tabs::after {
                content: '';
                position: absolute;
                bottom: 0;
                right: 0;
                width: 20px;
                height: 100%;
                background: linear-gradient(to right, transparent, var(--neutral-50));
                pointer-events: none;
                z-index: 1;
            }

            /* Better visual feedback for active tab */
            .tab.active {
                box-shadow: 0 -3px 0 var(--accent-500) inset;
                background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-500) 100%);
            }

            /* Improve readability */
            .tab {
                border-right: 1px solid var(--neutral-200);
            }

            .tab:last-child {
                border-right: none;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .header {
                padding: var(--space-3) var(--space-4);
            }

            .header h1 {
                font-size: 1.4rem;
            }

            .header .subtitle {
                font-size: 0.8rem;
            }

            .tab-content {
                padding: var(--space-4);
            }

            .form-section {
                padding: var(--space-4);
                margin-bottom: var(--space-3);
            }
        }

        /* ======== MOBILE-SPECIFIC ENHANCEMENTS ======== */
        /* Touch-friendly interactions */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 48px;
                padding: var(--space-4);
                font-size: 1rem;
                font-weight: 600;
            }

            .form-control {
                min-height: 48px;
                padding: var(--space-4);
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .tab {
                min-height: 48px;
                padding: var(--space-3) var(--space-2);
            }

            /* Remove hover effects on touch devices */
            .btn:hover,
            .form-control:hover,
            .tab:hover {
                transform: none;
            }

            /* Enhanced tap targets */
            .customer-search-result {
                min-height: 60px;
                padding: var(--space-4);
            }

            .edit-btn, .delete-btn {
                min-height: 44px;
                min-width: 80px;
            }
        }

        /* Enhanced mobile navigation */
        @media (max-width: 480px) {
            /* Add horizontal scroll indicator */
            .tabs::after {
                content: '';
                position: absolute;
                bottom: 0;
                right: 0;
                width: 20px;
                height: 100%;
                background: linear-gradient(to right, transparent, var(--neutral-50));
                pointer-events: none;
                z-index: 1;
            }

            /* Better visual feedback for active tab */
            .tab.active {
                box-shadow: 0 -3px 0 var(--accent-500) inset;
                background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-500) 100%);
            }

            /* Improve readability */
            .tab {
                border-right: 1px solid var(--neutral-200);
            }

            .tab:last-child {
                border-right: none;
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-appearance: none) {
            .form-control {
                -webkit-appearance: none;
                border-radius: var(--radius-md);
            }

            select.form-control {
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right var(--space-3) center;
                background-size: 20px;
                padding-right: var(--space-12);
            }
        }

        /* Android Chrome specific optimizations */
        @media screen and (-webkit-min-device-pixel-ratio: 1) {
            .form-control:focus {
                zoom: 1; /* Prevent zoom on Android */
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .btn, .form-control, .tab {
                border-width: 0.5px;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                color: black;
                font-size: 12pt;
                line-height: 1.4;
            }

            .header {
                background: none;
                color: black;
                border-bottom: 2px solid black;
            }

            .tabs, .btn {
                display: none;
            }

            .tab-content {
                display: block !important;
                padding: 0;
            }

            .form-section {
                border: 1px solid black;
                margin-bottom: 20pt;
                page-break-inside: avoid;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }
        }

        /* ======== UTILITY CLASSES ======== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }

        .fw-bold { font-weight: 700; }
        .fw-semibold { font-weight: 600; }
        .fw-medium { font-weight: 500; }
        .fw-normal { font-weight: 400; }

        .text-primary { color: var(--primary-600); }
        .text-secondary { color: var(--secondary-600); }
        .text-success { color: var(--success-600); }
        .text-error { color: var(--error-600); }
        .text-warning { color: var(--warning-600); }
        .text-muted { color: var(--neutral-500); }

        .bg-primary { background-color: var(--primary-600); }
        .bg-secondary { background-color: var(--secondary-600); }
        .bg-success { background-color: var(--success-600); }
        .bg-error { background-color: var(--error-600); }
        .bg-warning { background-color: var(--warning-600); }

        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }

        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }

        .edit-form {
            background: #fff;
            border: 2px solid #4ecdc4;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .edit-form h4 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .edit-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .edit-form-group {
            margin-bottom: 10px;
        }

        .edit-form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            color: #333;
            font-size: 12px;
        }

        .edit-form-group input,
        .edit-form-group select,
        .edit-form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 14px;
        }

        .edit-form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .edit-form-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .save-edit-btn {
            background: #28a745;
            color: white;
        }

        .save-edit-btn:hover {
            background: #218838;
        }

        .cancel-edit-btn {
            background: #6c757d;
            color: white;
        }

        .cancel-edit-btn:hover {
            background: #5a6268;
        }

        /* Customer search styles */
        .customer-search-result {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .customer-search-result:hover {
            background-color: #f8f9fa;
            border-left-color: #4ecdc4;
            transform: translateX(2px);
        }

        .customer-search-result:last-child {
            border-bottom: none;
        }

        .customer-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .customer-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .customer-stats {
            font-size: 11px;
            color: #4ecdc4;
            margin-top: 8px;
            font-weight: 600;
        }

        .customer-source-badge {
            font-size: 10px;
            color: #999;
            padding: 2px 6px;
            background: #f0f0f0;
            border-radius: 10px;
        }

        .customer-last-purchase {
            font-size: 10px;
            color: #999;
            font-style: italic;
        }

        /* Enhanced search results container */
        #customer-search-results {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            max-height: 300px;
            overflow-y: auto;
        }

        #customer-search-results::-webkit-scrollbar {
            width: 6px;
        }

        #customer-search-results::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #customer-search-results::-webkit-scrollbar-thumb {
            background: #4ecdc4;
            border-radius: 3px;
        }

        #customer-search-results::-webkit-scrollbar-thumb:hover {
            background: #45b7b8;
        }

        /* Section headers */
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-icon {
            margin-right: 8px;
            font-size: 18px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
            display: none;
            font-weight: bold;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
            display: none;
            font-weight: bold;
        }

        /* Additional mobile-specific styles for components */
        @media (max-width: 600px) {
            /* Import section responsive */
            .import-section {
                flex-direction: column !important;
                gap: var(--space-3) !important;
            }

            .import-section button {
                width: 100% !important;
                margin-bottom: var(--space-2);
                min-height: 48px;
            }

            /* Customer database responsive design */
            .customer-info-grid {
                grid-template-columns: 1fr !important;
                gap: var(--space-2) !important;
            }

            .customer-purchase-stats {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: var(--space-2) !important;
            }

            .customer-card {
                padding: var(--space-4) !important;
                margin-bottom: var(--space-3) !important;
                border-radius: var(--radius-md);
            }

            .enhanced-customers-container {
                max-height: 400px !important;
                -webkit-overflow-scrolling: touch;
            }

            /* Sales items mobile layout */
            .customer-item,
            .sale-item {
                padding: var(--space-4);
                margin-bottom: var(--space-3);
                border-radius: var(--radius-md);
                border: 1px solid var(--neutral-200);
                background: white;
            }
        }

        /* PWA Specific Styles */
        @media (display-mode: standalone) {
            .header {
                padding-top: 40px; /* Account for status bar */
            }

            body {
                -webkit-user-select: none;
                -webkit-touch-callout: none;
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* Touch-friendly improvements */
        .btn, .tab, button {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
        }

        /* ======== MOBILE-FRIENDLY MODAL/ALERT SYSTEM ======== */
        .mobile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }

        .mobile-modal.show {
            display: flex;
        }

        .mobile-modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            text-align: center;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .mobile-modal-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--space-4);
            color: var(--neutral-800);
        }

        .mobile-modal-body {
            margin-bottom: var(--space-6);
            color: var(--neutral-700);
            line-height: 1.5;
            text-align: left;
        }

        .mobile-modal-buttons {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
        }

        .mobile-modal-buttons .btn {
            flex: 1;
            max-width: 120px;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Multi-Select Category Styles */
        .multi-select-display:hover {
            border-color: var(--primary-600);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .multi-select-display:focus-within {
            border-color: var(--primary-600);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .multi-select-display.active {
            border-color: var(--primary-600);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .multi-select-display.active #category-arrow {
            transform: rotate(180deg);
        }

        .category-option:hover {
            background-color: var(--primary-50) !important;
        }

        .category-option input[type="checkbox"] {
            accent-color: var(--primary-600);
        }

        .category-tag {
            background: var(--primary-600);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .category-tag .remove-tag {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            margin-left: 4px;
            transition: background-color 0.2s;
        }

        .category-tag .remove-tag:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Enhanced Multi-Select Dropdown Styles */
        .multi-select-container {
            position: relative;
            z-index: 100;
        }

        .multi-select-display {
            position: relative !important;
            z-index: 101 !important;
            pointer-events: auto !important;
        }

        .multi-select-display:hover {
            border-color: var(--primary-600) !important;
            box-shadow: 0 0 0 3px var(--primary-100) !important;
        }

        .multi-select-display:active {
            transform: scale(0.98);
        }

        /* Create stacking context for dropdown */
        .form-section:has(.multi-select-container) {
            z-index: 100 !important;
        }

        .multi-select-dropdown {
            animation: fadeInDown 0.3s ease-out;
            z-index: 99999 !important;
            position: absolute !important;
            width: 100% !important;
            box-shadow:
                0 20px 25px -5px rgba(0, 0, 0, 0.3),
                0 10px 10px -5px rgba(0, 0, 0, 0.1) !important;
            border: 2px solid var(--primary-600) !important;
            background: white !important;
        }

        .multi-select-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .multi-select-dropdown::-webkit-scrollbar-track {
            background: var(--neutral-100);
        }

        .multi-select-dropdown::-webkit-scrollbar-thumb {
            background: var(--primary-600);
            border-radius: 3px;
        }

        /* Additional dropdown positioning fixes */
        .multi-select-dropdown[style*="display: block"],
        .multi-select-dropdown[style*="display: flex"] {
            position: fixed !important;
            z-index: 99999 !important;
            transform: translateZ(0) !important;
            will-change: transform !important;
        }

        /* Prevent other elements from overlapping */
        .form-section:not(:has(.multi-select-container)) {
            z-index: 1 !important;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Sales Container Scrolling */
        .enhanced-sales-container {
            position: relative !important;
            max-height: 600px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            border: 1px solid #e9ecef !important;
            border-radius: 8px !important;
            background: #fafafa !important;
            scrollbar-width: thin;
            scrollbar-color: #4ecdc4 #f1f1f1;
        }

        .enhanced-sales-container::-webkit-scrollbar {
            width: 8px;
        }

        .enhanced-sales-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .enhanced-sales-container::-webkit-scrollbar-thumb {
            background: #4ecdc4;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .enhanced-sales-container::-webkit-scrollbar-thumb:hover {
            background: #44a08d;
        }

        /* Purchase History Container */
        .enhanced-purchase-container {
            position: relative !important;
            max-height: 500px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            border: 1px solid #e9ecef !important;
            border-radius: 8px !important;
            background: #f8f9fa !important;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }

        .enhanced-purchase-container::-webkit-scrollbar {
            width: 8px;
        }

        .enhanced-purchase-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .enhanced-purchase-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .enhanced-purchase-container::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Ensure sales records have proper layout */
        #sales-records, #purchase-records {
            padding: 10px !important;
            min-height: 100px !important;
            height: auto !important;
            overflow: visible !important;
        }

        /* Sales Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sales-table, .customer-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
        }

        .sales-table th, .customer-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sales-table td, .customer-table td {
            padding: 12px 8px;
            border-right: 1px solid #f0f0f0;
            font-size: 12px;
            vertical-align: middle;
        }

        .sales-table tr:hover, .customer-table tr:hover {
            background: #e3f2fd !important;
        }

        /* Customer Table Specific Styles */
        .customer-table {
            min-width: 1200px; /* Ensure table doesn't get too compressed */
        }

        .customer-table .status-active {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .customer-table .status-inactive {
            background: #f44336;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Mobile responsive table */
        @media (max-width: 768px) {
            .sales-table, .customer-table {
                font-size: 11px;
            }

            .sales-table th, .customer-table th,
            .sales-table td, .customer-table td {
                padding: 8px 4px;
                font-size: 11px;
            }

            .sales-table th, .customer-table th {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .sales-table, .customer-table {
                font-size: 10px;
            }

            .sales-table th, .customer-table th,
            .sales-table td, .customer-table td {
                padding: 6px 3px;
                font-size: 10px;
            }

            .sales-table th, .customer-table th {
                font-size: 10px;
            }
        }

        /* Sales and Purchase record items */
        .sale-record-item, .purchase-record-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
            position: relative;
        }

        .sale-record-item:hover, .purchase-record-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .purchase-record-item {
            border-left: 4px solid #667eea;
        }

        /* Fix for parent containers that might affect scrolling */
        #sales-content-container, #purchase-content-container {
            overflow: visible !important;
            height: auto !important;
            max-height: none !important;
        }

        .tab-content {
            overflow: visible !important;
            height: auto !important;
            max-height: none !important;
        }

        /* Collapsible sections */
        .collapsible-section {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .collapsible-section.collapsed {
            max-height: 0;
            padding: 0;
            margin: 0;
        }

        .collapsible-section.expanded {
            max-height: 2000px;
        }

        /* Toggle buttons */
        .toggle-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .toggle-btn.collapsed {
            transform: rotate(-90deg);
        }

        /* Ensure proper scrolling behavior on mobile */
        @media (max-width: 768px) {
            .enhanced-sales-container, .enhanced-purchase-container {
                max-height: 400px !important;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* ======== ENHANCED VISUAL ELEMENTS ======== */
        .form-section h3 i {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.2em;
            margin-right: 8px;
            animation: iconShine 3s ease-in-out infinite;
        }

        /* Enhanced form section styling */
        .form-section {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            opacity: 0.8;
        }

        .form-section h3 {
            color: var(--neutral-800);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            padding-bottom: var(--space-3);
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        @keyframes iconShine {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }



        /* Progress indicators */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            background-size: 200% 100%;
            animation: progressShine 2s linear infinite;
            transition: width 0.5s ease;
        }

        @keyframes progressShine {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Enhanced form labels */
        .form-group label {
            position: relative;
        }

        .form-group label::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .form-group:focus-within label::before {
            opacity: 1;
        }
        /* ======== USER-FRIENDLY ENHANCEMENTS ======== */

        /* Keyboard Shortcuts Help */
        .shortcuts-help {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--neutral-800);
            color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            display: none;
            max-width: 300px;
        }

        .shortcuts-help h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: var(--primary-400);
        }

        .shortcuts-help ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .shortcuts-help li {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .shortcuts-help .key {
            background: var(--neutral-700);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* Enhanced Quick Actions */
        .quick-action-btn:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Better Form Validation */
        .form-control.error {
            border-color: var(--error-500);
            background-color: var(--error-100);
        }

        .form-control.success {
            border-color: var(--success-500);
            background-color: var(--success-100);
        }



        /* Enhanced Search Results */
        .search-suggestion {
            padding: 12px;
            border-bottom: 1px solid var(--neutral-200);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-suggestion:hover {
            background-color: var(--primary-50);
        }

        .search-suggestion:last-child {
            border-bottom: none;
        }

        /* Smart Input Enhancements */
        .smart-input {
            position: relative;
        }

        .smart-input .input-hint {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neutral-400);
            font-size: 12px;
            pointer-events: none;
        }

        /* Enhanced Mobile Experience */
        @media (max-width: 768px) {
            .quick-actions-panel {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .quick-actions-panel > div:first-child {
                justify-content: center;
            }

            .container {
                margin: 10px;
                padding: 15px;
            }

            .shortcuts-help {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --glass-bg: rgba(30, 30, 30, 0.95);
                --neutral-50: #1f2937;
                --neutral-100: #374151;
                --neutral-200: #4b5563;
            }
        }

        /* Focus Management */
        .focus-trap {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            pointer-events: none;
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Success Animations */
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>


    <div class="container">
        <header class="header">
            <button class="settings-btn" onclick="openSettings()" title="Settings">
                <i class="fas fa-cog"></i>
            </button>


            <div class="header-content">
                <h1 class="app-title" id="app-title"> Theia Jewelz</h1>
                <p class="subtitle">Modern Sales Management System</p>
            </div>
        </header>

        <!-- Database Status Display -->
        <div class="status-bar" style="background: var(--glass-bg); border-bottom: 1px solid var(--glass-border); padding: 8px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; backdrop-filter: blur(10px);">
            <div id="database-status" class="database-status"></div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="save-status" class="save-status"></div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="settings-modal" id="settings-modal">
            <div class="settings-content">
                <div class="settings-header">
                    <h2><i class="fas fa-cog"></i> Application Settings</h2>
                    <button class="close-settings" onclick="closeSettings()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="settings-body">
                    <div class="settings-tabs">
                        <button class="settings-tab active" onclick="switchSettingsTab('general')">
                            <i class="fas fa-home"></i> General
                        </button>
                        <button class="settings-tab" onclick="switchSettingsTab('fields')">
                            <i class="fas fa-plus-square"></i> Custom Fields
                        </button>
                        <button class="settings-tab" onclick="switchSettingsTab('database')">
                            <i class="fas fa-database"></i> Database
                        </button>
                        <button class="settings-tab" onclick="switchSettingsTab('help')">
                            <i class="fas fa-question-circle"></i> Help
                        </button>
                    </div>

                    <!-- General Settings -->
                    <div id="general-settings" class="settings-section">
                        <h3><i class="fas fa-home"></i> General Settings</h3>
                        <div class="form-group">
                            <label for="app-name-input">Application Name</label>
                            <input type="text" id="app-name-input" class="settings-input" value=" Theia Jewelz" placeholder="Enter app name">
                        </div>
                        <div class="form-group">
                            <label for="company-name">Company Name</label>
                            <input type="text" id="company-name" class="settings-input" placeholder="Enter your company name">
                        </div>
                        <div class="form-group">
                            <label for="currency-symbol">Currency Symbol</label>
                            <input type="text" id="currency-symbol" class="settings-input" value="" placeholder="Enter currency symbol">
                        </div>
                    </div>

                    <!-- Custom Fields Settings -->
                    <div id="fields-settings" class="settings-section" style="display: none;">
                        <h3><i class="fas fa-plus-square"></i> Custom Fields Management</h3>

                        <div class="settings-tabs">
                            <button class="settings-tab active" onclick="switchFieldsTab('sales')">Sales Fields</button>
                            <button class="settings-tab" onclick="switchFieldsTab('customers')">Customer Fields</button>
                            <button class="settings-tab" onclick="switchFieldsTab('inventory')">Inventory Fields</button>
                            <button class="settings-tab" onclick="switchFieldsTab('purchases')">Purchase Fields</button>
                        </div>

                        <div id="sales-fields" class="custom-fields-container">
                            <h4>Sales Entry Fields</h4>
                            <div id="custom-sales-fields"></div>
                            <button class="add-field-btn" onclick="addCustomField('sales')">
                                <i class="fas fa-plus"></i> Add Sales Field
                            </button>
                        </div>

                        <div id="customers-fields" class="custom-fields-container" style="display: none;">
                            <h4>Customer Management Fields</h4>
                            <div id="custom-customers-fields"></div>
                            <button class="add-field-btn" onclick="addCustomField('customers')">
                                <i class="fas fa-plus"></i> Add Customer Field
                            </button>
                        </div>

                        <div id="inventory-fields" class="custom-fields-container" style="display: none;">
                            <h4>Inventory Management Fields</h4>
                            <div id="custom-inventory-fields"></div>
                            <button class="add-field-btn" onclick="addCustomField('inventory')">
                                <i class="fas fa-plus"></i> Add Inventory Field
                            </button>
                        </div>

                        <div id="purchases-fields" class="custom-fields-container" style="display: none;">
                            <h4>Purchase Management Fields</h4>
                            <div id="custom-purchases-fields"></div>
                            <button class="add-field-btn" onclick="addCustomField('purchases')">
                                <i class="fas fa-plus"></i> Add Purchase Field
                            </button>
                        </div>
                    </div>

                    <!-- Database Settings -->
                    <div id="database-settings" class="settings-section" style="display: none;">
                        <h3><i class="fas fa-database"></i> Database Settings</h3>

                        <div class="form-group">
                            <label for="database-method">Database Method</label>
                            <select id="database-method" class="settings-input" onchange="changeDatabaseMethod()">
                                <option value="firebase"> Firebase Firestore (Recommended)</option>
                                <option value="google-sheets"> Google Sheets</option>
                                <option value="local"> Local Storage Only</option>
                            </select>
                            <small style="color: var(--neutral-500); font-size: 12px; margin-top: 5px; display: block;">
                                Choose how you want to store your sales data
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="auto-save-toggle">Auto-save Sales</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="auto-save-toggle" checked onchange="toggleAutoSave()">
                                <span>Automatically save sales to database</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="show-status-toggle">Show Status</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="show-status-toggle" checked onchange="toggleShowStatus()">
                                <span>Show database connection and save status</span>
                            </div>
                        </div>

                        <div class="database-status-info" style="background: var(--neutral-100); padding: 12px; border-radius: 6px; margin-top: 15px;">
                            <h4 style="margin: 0 0 8px 0; color: var(--neutral-700);"><i class="fas fa-info-circle"></i> Current Status</h4>
                            <p style="margin: 0; font-size: 13px; color: var(--neutral-600);">
                                <strong>Method:</strong> <span id="current-db-method">Firebase Firestore</span><br>
                                <strong>Connection:</strong> <span id="current-db-status">Connected</span><br>
                                <strong>Auto-save:</strong> <span id="current-auto-save">Enabled</span><br>
                                <strong>Domain:</strong> <span id="current-domain">Loading...</span>
                            </p>
                            <button class="btn btn-primary" onclick="runConnectionTest()" style="margin-top: 10px; padding: 8px 16px; font-size: 13px;">
                                <i class="fas fa-vial"></i> Test Firebase Connection
                            </button>
                            </p>
                        </div>

                        <div class="database-actions" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="syncLocalData()">
                                <i class="fas fa-sync"></i> Sync Local Data
                            </button>
                            <button class="btn btn-info" onclick="downloadBackup()">
                                <i class="fas fa-download"></i> Download JSON Backup
                            </button>
                            <button class="btn btn-success" onclick="downloadExcelBackup()">
                                <i class="fas fa-file-excel"></i> Download Excel Backup
                            </button>
                        </div>

                        <div class="database-help" style="margin-top: 20px; padding: 12px; background: var(--primary-50); border-radius: 6px;">
                            <h4 style="margin: 0 0 8px 0; color: var(--primary-700);"><i class="fas fa-lightbulb"></i> Database Options</h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--neutral-600);">
                                <li><strong>Firebase:</strong> Free up to 50K reads/20K writes per day. Real-time sync.</li>
                                <li><strong>Google Sheets:</strong> Completely free. Easy to view/edit data.</li>
                                <li><strong>Local Storage:</strong> Stores data only in your browser. No internet required.</li>
                            </ul>

                            <h4 style="margin: 15px 0 8px 0; color: var(--primary-700);"><i class="fas fa-download"></i> Backup Options</h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--neutral-600);">
                                <li><strong>JSON Backup:</strong> Complete database backup in JSON format for technical use.</li>
                                <li><strong>Excel Backup:</strong> User-friendly Excel file with separate sheets for Sales, Customers, and Purchase History.</li>
                                <li><strong>Excel includes:</strong> Summary sheet, Sales Records, Customer Database, Purchase History.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Help Section -->
                    <div id="help-settings" class="settings-section" style="display: none;">
                        <h3><i class="fas fa-question-circle"></i> Help & Documentation</h3>

                        <div class="help-content">
                            <h4><i class="fas fa-plus-circle"></i> Sales Entry Tab</h4>
                            <p>This tab allows you to record new jewelry sales transactions.</p>
                            <ul>
                                <li><strong>Customer Details:</strong> Enter customer name, phone, and address</li>
                                <li><strong>Product Details:</strong> Specify jewelry type, weight, rate, and total amount</li>
                                <li><strong>Categories:</strong> Select multiple categories for combination items</li>
                                <li><strong>Payment:</strong> Record payment method and any advance received</li>
                            </ul>
                        </div>

                        <div class="help-content">
                            <h4><i class="fas fa-list"></i> Recent Sales Tab</h4>
                            <p>View and manage all recorded sales transactions.</p>
                            <ul>
                                <li><strong>Search & Filter:</strong> Find specific sales by customer name or date</li>
                                <li><strong>Export:</strong> Download sales data as Excel files</li>
                                <li><strong>Edit/Delete:</strong> Modify or remove existing sales records</li>
                            </ul>
                        </div>

                        <div class="help-content">
                            <h4><i class="fas fa-chart-pie"></i> Dashboard Tab</h4>
                            <p>Visual analytics and insights about your business performance.</p>
                            <ul>
                                <li><strong>Sales Analytics:</strong> View daily, monthly, and yearly sales trends</li>
                                <li><strong>Category Performance:</strong> See which jewelry types sell best</li>
                                <li><strong>Revenue Tracking:</strong> Monitor total revenue and profit margins</li>
                            </ul>
                        </div>

                        <div class="help-content">
                            <h4><i class="fas fa-users"></i> Customers Tab</h4>
                            <p>Manage your customer database and relationships.</p>
                            <ul>
                                <li><strong>Customer Profiles:</strong> Store detailed customer information</li>
                                <li><strong>Purchase History:</strong> Track all purchases by each customer</li>
                                <li><strong>Contact Management:</strong> Maintain phone numbers and addresses</li>
                            </ul>
                        </div>

                        <div class="help-content">
                            <h4><i class="fas fa-boxes"></i> Inventory Tab</h4>
                            <p>Track and manage your jewelry stock and inventory.</p>
                            <ul>
                                <li><strong>Stock Levels:</strong> Monitor current inventory quantities</li>
                                <li><strong>Low Stock Alerts:</strong> Get notified when items are running low</li>
                                <li><strong>Product Catalog:</strong> Manage your jewelry product listings</li>
                            </ul>
                        </div>

                        <div class="help-content">
                            <h4><i class="fas fa-shopping-cart"></i> Purchases Tab</h4>
                            <p>Record and track inventory purchases from suppliers.</p>
                            <ul>
                                <li><strong>Supplier Management:</strong> Maintain supplier contact information</li>
                                <li><strong>Purchase Orders:</strong> Create and track purchase orders</li>
                                <li><strong>Cost Tracking:</strong> Monitor purchase costs and profit margins</li>
                            </ul>
                        </div>
                    </div>

                    <button class="save-settings-btn" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Field Placement Modal -->
        <div class="field-placement-modal" id="field-placement-modal">
            <div class="field-placement-content">
                <div class="field-placement-header">
                    <h3><i class="fas fa-map-marker-alt"></i> Where do you want to add this field?</h3>
                    <p>Choose the specific location where the new field should appear</p>
                </div>

                <div id="placement-options-container" class="placement-options">
                    <!-- Options will be populated based on selected tab -->
                </div>

                <div class="field-config-section">
                    <h4><i class="fas fa-cog"></i> Field Configuration</h4>
                    <div class="field-config-row">
                        <input type="text" id="new-field-label" placeholder="Field Label (e.g., 'Special Instructions')" style="padding: var(--space-2); border: 1px solid var(--neutral-300); border-radius: var(--radius-sm);">
                        <select id="new-field-type" style="padding: var(--space-2); border: 1px solid var(--neutral-300); border-radius: var(--radius-sm);">
<!--                            <option value="text">Text</option>-->
                            <option value="number">Number</option>
                            <option value="email">Email</option>
                            <option value="phone">Phone</option>
                            <option value="date">Date</option>
                            <option value="select">Dropdown</option>
                            <option value="textarea">Text Area</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem;">
                            <input type="checkbox" id="new-field-required">
                            Required
                        </label>
                    </div>
                </div>

                <div class="placement-actions">
                    <button class="placement-btn cancel" onclick="closeFieldPlacementModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="placement-btn confirm" onclick="confirmFieldPlacement()">
                        <i class="fas fa-plus"></i> Add Field
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile-Friendly Tab Navigation -->
        <div class="mobile-tabs-container">
            <div class="mobile-tabs-wrapper">
                <button class="mobile-tab active" onclick="showTab('sales')" data-tab="sales">
                    <i class="fas fa-plus-circle"></i>
                    <span>Add Sale</span>
                </button>
                <button class="mobile-tab" onclick="showTab('recent-sales')" data-tab="recent-sales">
                    <i class="fas fa-list"></i>
                    <span>Recent</span>
                </button>
                <button class="mobile-tab" onclick="showTab('dashboard')" data-tab="dashboard">
                    <i class="fas fa-chart-pie"></i>
                    <span>Dashboard</span>
                </button>
                <button class="mobile-tab" onclick="showTab('customers')" data-tab="customers">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </button>
                <button class="mobile-tab" onclick="showTab('analytics')" data-tab="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </button>
            </div>
        </div>



        <!-- Quick Actions Panel -->
        <div class="quick-actions-panel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; margin-bottom: 20px; border-radius: 12px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="showLastSales()" class="quick-action-btn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: all 0.2s;">
                    <i class="fas fa-history"></i> Last 5 Sales
                </button>
                <button onclick="showTodaysSummary()" class="quick-action-btn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: all 0.2s;">
                    <i class="fas fa-calendar-day"></i> Today's Summary
                </button>
            </div>
            <div style="color: white; font-size: 14px; font-weight: 500;">
                <span id="current-time"></span>
            </div>
        </div>

        <!-- Sales Entry Tab -->
        <div id="sales" class="tab-content active" role="tabpanel" aria-labelledby="sales-tab">
            <!-- Auto-Save Status -->
            <div id="autosave-status" style="display: none; background: var(--success-100); color: var(--success-600); padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;">
                <i class="fas fa-save"></i> Draft saved automatically
            </div>

            <div class="filter-section">
                <div class="filter-header">
                    <i class="fas fa-search"></i>
                    <h3>Search Existing Customer</h3>
                </div>
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" id="customerSearch" placeholder="Type customer name, phone, or email to search..."
                           oninput="searchCustomers()" onkeydown="handleSearchKeydown(event)" autocomplete="off"
                           class="form-control">
                    <div id="customer-search-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0;
                         background: white; border: 1px solid var(--neutral-300); border-top: none; border-radius: 0 0 var(--radius-md) var(--radius-md);
                         max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: var(--shadow-lg);">
                    </div>
                </div>
                <p class="text-muted" style="font-size: 0.875rem; margin-top: var(--space-2);">
                    <i class="fas fa-info-circle"></i>
                    Search from <span id="total-customers" class="fw-semibold">0</span> customers - includes database & sales records
                </p>
            </div>

            <!-- Success/Error Messages -->
            <div id="success-toast" class="toast toast-success" style="display: none;">
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fas fa-check-circle"></i>
                    <span id="success-message"></span>
                </div>
            </div>
            <div id="error-toast" class="toast toast-error" style="display: none;">
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="error-message"></span>
                </div>
            </div>

            <form id="sales-form" style="position: relative; z-index: 1;">
                <!-- Customer Information Section -->
                <div class="form-section">
                    <h3><i class="fas fa-user"></i> Customer Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName" class="required">Customer Name</label>
                            <input type="text" id="customerName" class="form-control" required
                                   placeholder="Enter customer name">
                            <div class="form-error" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Customer name is required</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="customerPhone">Phone Number</label>
                            <input type="tel" id="customerPhone" class="form-control"
                                   placeholder="Enter phone number">
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="customerAddress">Address</label>
                            <textarea id="customerAddress" class="form-control" rows="2"
                                      placeholder="Enter customer address (optional)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Item Information & Pricing Section -->
                <div class="form-section" style="z-index: 10; position: relative;">
                    <h3><i class="fas fa-gem"></i> Item Information & Pricing</h3>
                    <div class="form-grid">
                        <!-- Item Details -->
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="itemName" class="required">Item Name</label>
                            <div style="position: relative;">
                                <input type="text" id="itemName" class="form-control" required
                                       placeholder="e.g., Gold Plated Necklace"
                                       oninput="showItemSuggestions(this.value)"
                                       onkeydown="handleItemKeydown(event)"
                                       autocomplete="off">
                                <div id="item-suggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--neutral-300); border-top: none; border-radius: 0 0 var(--radius-md) var(--radius-md); max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: var(--shadow-lg);">
                                </div>
                            </div>
                            <div class="form-error" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Item name is required</span>
                            </div>
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="category" class="required">Categories</label>
                            <div class="multi-select-container" style="position: relative;">
                                <div class="multi-select-display" id="category-display" onclick="Event.stopPropagation(); toggleCategoryDropdown();" onkeydown="if(Event.key==='Enter'||Event.key===' '){Event.stopPropagation(); toggleCategoryDropdown();}"
                                     style="border: 2px solid var(--neutral-300); border-radius: var(--radius-md); padding: var(--space-3) var(--space-4);
                                            background: white; cursor: pointer; min-height: 48px; display: flex; align-items: center;
                                            justify-content: space-between; transition: var(--transition-normal); user-select: none;"
                                     tabindex="0" role="button" aria-expanded="false" aria-haspopup="listbox" aria-label="Select categories">
                                    <span id="category-placeholder" style="color: var(--neutral-400); pointer-events: none;">Select categories...</span>
                                    <span id="category-selected" style="display: none; flex-wrap: wrap; gap: 6px; flex: 1; pointer-events: none;"></span>
                                    <i class="fas fa-chevron-down" id="category-arrow" style="transition: transform 0.3s ease; pointer-events: none;"></i>
                                </div>

                                <div class="multi-select-dropdown" id="category-dropdown"
                                     style="display: none; position: absolute; top: 100%; left: 0; right: 0;
                                            background: white !important; border: 2px solid var(--primary-600) !important; border-top: none;
                                            border-radius: 0 0 var(--radius-md) var(--radius-md); max-height: 250px;
                                            overflow-y: auto; z-index: 99999 !important;
                                            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1) !important;
                                            transform: translateZ(0) !important;">

                                    <div style="padding: 12px; border-bottom: 1px solid var(--neutral-200); background: var(--neutral-50);">
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <button type="button" onclick="selectAllCategories()"
                                                    style="background: var(--primary-600); color: white; border: none; padding: 4px 8px;
                                                           border-radius: 4px; font-size: 12px; cursor: pointer;">Select All</button>
                                            <button type="button" onclick="clearAllCategories()"
                                                    style="background: var(--neutral-400); color: white; border: none; padding: 4px 8px;
                                                           border-radius: 4px; font-size: 12px; cursor: pointer;">Clear All</button>
                                        </div>
                                    </div>

                                    <div class="category-options" style="padding: 8px;">
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Necklaces" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Necklaces</span>
                                        </label>
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Earrings" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Earrings</span>
                                        </label>
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Bracelets" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Bracelets</span>
                                        </label>
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Rings" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Rings</span>
                                        </label>
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Anklets" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Anklets</span>
                                        </label>
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Sets" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Sets</span>
                                        </label>
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Bangles" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Bangles</span>
                                        </label>
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Chains" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Chains</span>
                                        </label>
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Pendants" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Pendants</span>
                                        </label>
                                        <label class="category-option" style="display: flex; align-items: center; padding: 8px; cursor: pointer;
                                                                            border-radius: 4px; transition: background-color 0.2s;">
                                            <input type="checkbox" value="Brooches" onchange="updateSelectedCategories()"
                                                   style="margin-right: 10px;">
                                            <span> Brooches</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-error" id="category-error" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Please select at least one category</span>
                            </div>
                            <p style="font-size: 12px; color: var(--neutral-500); margin-top: 5px;">
                                 You can select multiple categories for combination items (e.g., Necklace + Earrings set)
                            </p>



                        </div>

                        <div class="form-group">
                            <label for="saleDate" class="required">Sale Date</label>
                            <input type="date" id="saleDate" class="form-control" required>
                            <div class="form-error" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Sale date is required</span>
                            </div>
                        </div>

                        <!-- Pricing Information Separator -->
                        <div style="grid-column: 1 / -1; margin: var(--space-4) 0; padding: var(--space-3) 0;
                             border-top: 2px solid rgba(102, 126, 234, 0.1); position: relative;">
                            <div style="position: absolute; top: -1px; left: 50%; transform: translateX(-50%);
                                 background: white; padding: 0 var(--space-3); color: #667eea; font-weight: 600; font-size: 0.9rem;">
                                <i class="fas fa-money-bill-wave" style="margin-right: 6px;"></i>
                                Pricing Details
                            </div>
                        </div>

                        <!-- Pricing Information -->
                        <div class="form-group">
                            <label for="costPrice">Cost Price () *</label>
                            <input type="number" id="costPrice" class="form-control" required placeholder="Enter cost price" min="0" step="0.01" oninput="calculateProfit()">
                        </div>

                        <div class="form-group">
                            <label for="sellingPrice">Selling Price () *</label>
                            <input type="number" id="sellingPrice" class="form-control" required placeholder="Enter selling price" min="0" step="0.01" oninput="calculateProfit()">
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="profit"> Profit ()</label>
                            <input type="number" id="profit" class="form-control" readonly placeholder="Auto-calculated"
                                   style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); cursor: not-allowed; font-weight: 600; color: #065f46;">
                            <div id="profit-display" style="margin-top: 8px; padding: 12px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
                                 border-radius: 8px; border-left: 4px solid #0ea5e9; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-chart-line" style="color: #0ea5e9;"></i>
                                        <span style="font-weight: 600; color: #0c4a6e;">Profit Margin:</span>
                                        <span id="profit-margin" style="font-weight: 700; color: #065f46; font-size: 1.1em;">0%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #64748b;">
                                        Higher margin = Better profitability 
                                    </div>
                                </div>
                            </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; grid-column: 1 / -1;">
                            <div class="form-group">
                                <label for="shippingAmount"> Shipping Amount ()</label>
                                <input type="number" id="shippingAmount" class="form-control" placeholder="Enter shipping amount"
                                       min="0" step="0.01" value="0" oninput="calculateTotal()">
                                <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
                                    <i class="fas fa-info-circle"></i> Enter 0 for free shipping
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="paymentMode"> Payment Mode</label>
                                <select id="paymentMode" class="form-control">
                                    <option value="UPI" selected>UPI (PhonePe/GPay/Paytm)</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Debit Card">Debit Card</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                                <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
                                    <i class="fas fa-info-circle"></i> Select payment method used
                                </small>
                            </div>
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="trackingId"> Tracking ID (Optional)</label>
                            <div style="position: relative;">
                                <input type="text" id="trackingId" class="form-control" placeholder="Enter or scan tracking ID (optional)"
                                       style="padding-right: 50px;">
                                <button type="button" onclick="scanBarcode()"
                                        style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
                                               background: var(--primary-600); color: white; border: none;
                                               padding: 8px; border-radius: 4px; cursor: pointer; font-size: 14px;"
                                        title="Scan barcode">
                                    <i class="fas fa-qrcode"></i>
                                </button>
                            </div>
                            <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
                                <i class="fas fa-info-circle"></i> You can manually enter or scan a barcode/QR code for tracking
                            </small>
                        </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-primary add-sale-btn" onclick="addSaleRecord()"> Add Sale Record</button>
            </form>


        </div>

    <!-- Recent Sales Tab -->
    <div class="container">
        <div id="recent-sales" class="tab-content">
            <h2> Recent Sales & Import</h2>

            <!-- Select Record to Display Section -->
            <div style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; gap: 15px; color: white;">
                    <i class="fas fa-filter" style="font-size: 20px; color: #ffd700;"></i>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 16px; color: white;">
                            Select Record to Display
                        </label>
                        <select id="record-display-selector" onchange="changeRecordDisplay()"
                                style="width: 100%; max-width: 300px; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95); color: #333; font-weight: 500;">
                            <option value="sales-record" selected>Sales Record</option>
                            <option value="purchase-history">Purchase History</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sales Import Section -->
            <div id="sales-import-section" style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e9ecef;">
                <h3 style="margin: 0 0 15px 0; color: #4ecdc4;"> Bulk Import Sales</h3>
                <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">Import multiple sales records from CSV or Excel file</p>

                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;" class="import-section">
                    <input type="file" id="sales-import-file" accept=".csv,.xlsx,.xls" style="display: none;" onchange="importSales(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('sales-import-file').click()" style="width: auto; padding: 10px 16px; font-size: 14px;" title="Import sales from CSV or Excel file">
                         Import Sales Data
                    </button>
                    <button class="btn" onclick="downloadSalesTemplate()" style="width: auto; padding: 10px 16px; font-size: 14px; background-color: #6c757d; color: white;" title="Download sample CSV template">
                         Download Template
                    </button>
                    <small style="color: #666; font-size: 12px;">Supports CSV and Excel files with required columns: Item Name, Category, Cost Price, Selling Price, Sale Date, Customer Name</small>
                </div>
            </div>

            <!-- Sales Summary Table with Customer Details -->
            <div id="sales-summary-table-section" style="background: #fff; border-radius: 15px; border: 2px solid #e9ecef; overflow: hidden; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.08);">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); color: white; padding: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-table" style="font-size: 28px; color: #ffd700;"></i>
                            <div>
                                <h3 style="margin: 0; font-size: 24px; font-weight: 700;"> Sales Summary</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">Customer details with sales information</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn" onclick="refreshSalesSummary()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); width: auto; padding: 10px 18px; font-size: 14px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn" onclick="exportSalesSummary()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); width: auto; padding: 10px 18px; font-size: 14px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                </div>

                <div style="padding: 25px;">
                    <!-- Sales Statistics Summary -->
                    <div id="sales-summary" style="background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                        <h4 style="margin: 0 0 15px 0; text-align: center; font-size: 18px;"> Sales Statistics</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                            <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <h4 id="summary-total-sales" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                                <p style="font-size: 12px; opacity: 0.9; margin: 0;">Total Sales</p>
                            </div>
                            <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <h4 id="summary-total-cost" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                                <p style="font-size: 12px; opacity: 0.9; margin: 0;">Total Cost</p>
                            </div>
                            <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <h4 id="summary-total-selling" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                                <p style="font-size: 12px; opacity: 0.9; margin: 0;">Total Selling</p>
                            </div>
                            <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <h4 id="summary-total-profit" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                                <p style="font-size: 12px; opacity: 0.9; margin: 0;">Total Profit</p>
                            </div>
                        </div>
                    </div>

                    <!-- Search and Filter for Summary Table -->
                    <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #667eea;">
                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px;">
                                    <i class="fas fa-search"></i> Search Customers & Sales
                                </label>
                                <input type="text" id="summary-search" placeholder="Search by customer name, phone, email, or date..."
                                       oninput="filterSalesSummary()"
                                       style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; background: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px;">Date Range</label>
                                <select id="date-filter" onchange="filterSalesSummary()" style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; background: white;">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="clearSummaryFilter()" style="background: #6c757d; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                    <i class="fas fa-eraser"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Summary Table -->
                    <div class="table-container" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e9ecef; max-height: 600px; overflow-y: auto;">
                        <table id="sales-summary-table" class="sales-table" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th style="padding: 18px 15px; text-align: left; font-weight: 600; font-size: 14px; border-bottom: 2px solid #fff; white-space: nowrap;">
                                        <i class="fas fa-user"></i> Customer Name
                                    </th>
                                    <th style="padding: 18px 15px; text-align: left; font-weight: 600; font-size: 14px; border-bottom: 2px solid #fff; white-space: nowrap;">
                                        <i class="fas fa-phone"></i> Phone
                                    </th>
                                    <th style="padding: 18px 15px; text-align: left; font-weight: 600; font-size: 14px; border-bottom: 2px solid #fff; white-space: nowrap;">
                                        <i class="fas fa-envelope"></i> Email
                                    </th>
                                    <th style="padding: 18px 15px; text-align: center; font-weight: 600; font-size: 14px; border-bottom: 2px solid #fff; white-space: nowrap;">
                                        <i class="fas fa-calendar"></i> Date
                                    </th>
                                    <th style="padding: 18px 15px; text-align: right; font-weight: 600; font-size: 14px; border-bottom: 2px solid #fff; white-space: nowrap;">
                                        <i class="fas fa-rupee-sign"></i> Selling Price
                                    </th>
                                    <th style="padding: 18px 15px; text-align: center; font-weight: 600; font-size: 14px; border-bottom: 2px solid #fff; white-space: nowrap;">
                                        <i class="fas fa-cogs"></i> Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body">
                                <!-- Table rows will be populated by JavaScript -->
                                <tr id="no-summary-data" style="display: none;">
                                    <td colspan="6" style="padding: 60px 20px; text-align: center; color: #999; font-style: italic;">
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                                            <i class="fas fa-inbox" style="font-size: 48px; color: #ddd;"></i>
                                            <div>
                                                <h4 style="margin: 0 0 8px 0; color: #666;">No Sales Data Found</h4>
                                                <p style="margin: 0; font-size: 14px;">Add your first sale or adjust the search filters</p>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination for Summary Table -->
                    <div id="summary-pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="color: #666; font-size: 14px;">
                            Showing <span id="summary-showing-start">0</span> to <span id="summary-showing-end">0</span> of <span id="summary-total-count">0</span> entries
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="summary-prev-btn" onclick="changeSummaryPage(-1)" style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span id="summary-page-info" style="padding: 8px 12px; color: #666; font-size: 14px; font-weight: 500;">Page 1 of 1</span>
                            <button id="summary-next-btn" onclick="changeSummaryPage(1)" style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;" disabled>
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Purchase History Section -->
                <div id="purchase-history-section" style="background: #fff; border-radius: 10px; border: 2px solid #e9ecef; overflow: hidden; margin-top: 30px; display: none;">
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <h3 style="margin: 0; font-size: 20px;"> Purchase History (<span id="purchase-count">0</span>)</h3>
                                <button id="purchase-toggle-btn" onclick="togglePurchaseSection()" class="toggle-btn" title="Expand/Collapse Purchase History">
                                    
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn" onclick="exportPurchaseHistory()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); width: auto; padding: 8px 16px; font-size: 14px;">
                                     Export Purchases
                                </button>
                                <button class="btn" onclick="addToPurchaseHistory()" style="background: #10B981; color: white; border: none; width: auto; padding: 8px 16px; font-size: 14px;">
                                     Add Purchase
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="purchase-content-container" class="collapsible-section collapsed" style="transition: all 0.3s ease; overflow: hidden;">
                        <!-- Purchase Summary -->
                        <div style="padding: 20px;">
                            <div id="purchase-summary" style="background: linear-gradient(45deg, #10B981, #059669); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 15px 0; text-align: center; font-size: 18px;"> Purchase Summary</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                                    <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                        <h4 id="summary-total-purchases" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                                        <p style="font-size: 12px; opacity: 0.9; margin: 0;">Total Items</p>
                                    </div>
                                    <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                        <h4 id="summary-total-purchase-cost" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                                        <p style="font-size: 12px; opacity: 0.9; margin: 0;">Total Purchase Cost</p>
                                    </div>
                                    <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                        <h4 id="summary-total-selling-value" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                                        <p style="font-size: 12px; opacity: 0.9; margin: 0;">Total Selling Value</p>
                                    </div>
                                    <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                        <h4 id="summary-potential-profit" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                                        <p style="font-size: 12px; opacity: 0.9; margin: 0;">Potential Profit</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Purchase Search and Filter -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;"> Search Purchases</label>
                                        <input type="text" id="purchase-search" placeholder="Search by item name, category, or supplier..."
                                               oninput="filterPurchases()" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="clearPurchaseFilter()" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                             Clear
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Add Purchase Form Section -->
                            <div id="add-purchase-form" style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; margin-bottom: 20px; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h4 style="margin: 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-plus-circle" style="color: #10B981;"></i>
                                        Add New Purchase
                                    </h4>
                                    <button onclick="cancelAddPurchase()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                         Cancel
                                    </button>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                    <!-- Left Column -->
                                    <div>
                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                                <i class="fas fa-tag" style="color: #6366F1; margin-right: 5px;"></i>
                                                Supplier Name <span style="color: #dc3545;">*</span>
                                            </label>
                                            <input type="text" id="supplier-name" placeholder="Enter supplier name"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease;">
                                        </div>

                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                                <i class="fas fa-gem" style="color: #6366F1; margin-right: 5px;"></i>
                                                Purchase Name (Item) <span style="color: #dc3545;">*</span>
                                            </label>
                                            <input type="text" id="purchase-name" placeholder="Enter item name"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease;">
                                        </div>

                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                                <i class="fas fa-rupee-sign" style="color: #6366F1; margin-right: 5px;"></i>
                                                Purchase Cost <span style="color: #dc3545;">*</span>
                                            </label>
                                            <input type="number" id="purchase-cost" placeholder="Enter purchase cost" min="0" step="0.01"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease;">
                                        </div>
                                    </div>

                                    <!-- Right Column -->
                                    <div>
                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                                <i class="fas fa-list" style="color: #6366F1; margin-right: 5px;"></i>
                                                Category
                                            </label>
                                            <input type="text" id="purchase-category" placeholder="e.g., Necklaces, Earrings, Rings"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease;">
                                        </div>

                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                                <i class="fas fa-money-bill-wave" style="color: #6366F1; margin-right: 5px;"></i>
                                                Selling Price
                                            </label>
                                            <input type="number" id="selling-price" placeholder="Enter intended selling price" min="0" step="0.01"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease;">
                                        </div>

                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                                <i class="fas fa-sort-numeric-up" style="color: #6366F1; margin-right: 5px;"></i>
                                                Quantity
                                            </label>
                                            <input type="number" id="purchase-quantity" placeholder="Enter quantity" min="1" value="1"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease;">
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                        <i class="fas fa-sticky-note" style="color: #6366F1; margin-right: 5px;"></i>
                                        Notes (Optional)
                                    </label>
                                    <textarea id="purchase-notes" placeholder="Enter any additional notes..." rows="3"
                                              style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; resize: vertical; transition: border-color 0.3s ease;"></textarea>
                                </div>

                                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                                    <button onclick="cancelAddPurchase()" style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                        Cancel
                                    </button>
                                    <button onclick="savePurchaseFromForm()" style="background: #10B981; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                        <i class="fas fa-save" style="margin-right: 5px;"></i>
                                        Save Purchase
                                    </button>
                                </div>
                            </div>

                            <!-- Purchase Records Container -->
                            <div class="enhanced-purchase-container">
                                <div id="purchase-records"></div>
                                <div id="no-purchase-message" style="text-align: center; padding: 40px; color: #666; font-style: italic; display: none;">
                                    <h3 style="color: #999;"> No Purchase Records Found</h3>
                                    <p>Add your first purchase record to track inventory!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div class="container">
        <div id="dashboard" class="tab-content">
            <h2> Sales Dashboard</h2>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="total-sales">0</h3>
                    <p>Total Sales</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-revenue">0</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-profit">0</h3>
                    <p>Total Profit</p>
                </div>
                <div class="stat-card">
                    <h3 id="avg-profit">0</h3>
                    <p>Average Profit</p>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="downloadExcel()">
                 Download Excel Report
            </button>

            <div class="chart-container">
                <canvas id="salesChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="categoryChart" width="400" height="200"></canvas>
            </div>

            <!-- Monthly Sales Section -->
            <div style="margin-top: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3> Monthly Sales Records</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="downloadMonthlySales()" style="width: auto; padding: 8px 16px; font-size: 14px;">
                             Export Monthly Report
                        </button>
                    </div>
                </div>
                <div id="monthly-sales-list"></div>
            </div>
        </div>
    </div>

    <!-- Customers Tab -->
    <div class="container">
        <div id="customers" class="tab-content">
            <h2> Customer Management</h2>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3>Add New Customer</h3>
                <div id="customer-success-message" class="success-message"></div>
                <div id="customer-error-message" class="error-message"></div>

                <form id="customer-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="newCustomerName">Customer Name *</label>
                            <input type="text" id="newCustomerName" required placeholder="Enter customer name">
                        </div>
                        <div class="form-group">
                            <label for="newCustomerPhone">Phone Number</label>
                            <input type="tel" id="newCustomerPhone" placeholder="Enter phone number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newCustomerAddress">Address</label>
                        <textarea id="newCustomerAddress" placeholder="Enter customer address" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newCustomerEmail">Email</label>
                        <input type="email" id="newCustomerEmail" placeholder="Enter email address">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addCustomer()"> Add Customer</button>
                </form>
            </div>

            <!-- Enhanced Customer Database Section -->
            <div style="background: #fff; border-radius: 10px; border: 2px solid #e9ecef; overflow: hidden;">
                <!-- Header Section -->
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 style="margin: 0; font-size: 20px;"> Customer Database (<span id="customers-count">0</span>)</h3>
                            <button id="customer-stats-toggle" onclick="toggleCustomerStats()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 16px; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease;" title="Show/Hide Customer Statistics">
                                 Stats
                            </button>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <input type="file" id="customer-import-file" accept=".csv,.xlsx,.xls" style="display: none;" onchange="importCustomers(event)">
                            <button class="btn" onclick="document.getElementById('customer-import-file').click()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); width: auto; padding: 6px 12px; font-size: 13px;" title="Import customers from CSV or Excel file">
                                 Import
                            </button>
                            <button class="btn" onclick="downloadCustomerTemplate()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); width: auto; padding: 6px 12px; font-size: 13px;">
                                 Template
                            </button>
                            <button class="btn" onclick="downloadCustomersExcel()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); width: auto; padding: 6px 12px; font-size: 13px;">
                                 Export
                            </button>
                            <button class="btn" onclick="deleteAllCustomers()" style="background: #ff6b6b; color: white; border: none; width: auto; padding: 6px 12px; font-size: 13px;">
                                 Delete All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Customer Statistics Panel -->
                <div id="customer-stats-panel" style="display: none; background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; padding: 20px;">
                    <h4 style="margin: 0 0 15px 0; text-align: center; font-size: 18px;"> Customer Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <h4 id="stat-total-customers" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                            <p style="font-size: 12px; opacity: 0.9; margin: 0;">Total Customers</p>
                        </div>
                        <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <h4 id="stat-active-customers" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                            <p style="font-size: 12px; opacity: 0.9; margin: 0;">Active Buyers</p>
                        </div>
                        <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <h4 id="stat-avg-orders" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                            <p style="font-size: 12px; opacity: 0.9; margin: 0;">Avg Orders</p>
                        </div>
                        <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <h4 id="stat-total-clv" style="margin: 0 0 5px 0; font-size: 24px;">0</h4>
                            <p style="font-size: 12px; opacity: 0.9; margin: 0;">Total CLV</p>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;"> Search Customers</label>
                            <input type="text" id="customer-database-search" placeholder="Search by name, phone, email, or address..."
                                   oninput="filterCustomerDatabase()" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;"> Sort By</label>
                            <select id="customer-sort-select" onchange="sortCustomerDatabase()" style="padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="purchases-desc">Most Purchases</option>
                                <option value="purchases-asc">Least Purchases</option>
                                <option value="spending-desc">Highest Spending</option>
                                <option value="spending-asc">Lowest Spending</option>
                                <option value="recent-desc">Recently Added</option>
                                <option value="recent-asc">Oldest Added</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="clearCustomerDatabaseFilter()" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                 Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Customers List Container with Enhanced UI -->
                <div style="padding: 20px;">
                    <div id="customer-view-mode" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="font-size: 14px; color: #666;">
                            Showing <span id="customers-showing">0</span> of <span id="customers-total">0</span> customers
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 14px; color: #666;">View:</label>
                            <select id="customers-per-page" onchange="changeCustomersPerPage()" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="10">10 per page</option>
                                <option value="25" selected>25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>

                    <!-- Enhanced Customer Cards Container -->
                    <div class="enhanced-customers-container" style="max-height: 500px; overflow-y: auto; background: #fafafa; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px;">
                        <div id="customers-list-container"></div>

                        <!-- Pagination Controls -->
                        <div id="customer-pagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 15px;">
                            <button id="prev-customers-btn" onclick="previousCustomersPage()" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 14px;" disabled>
                                 Previous
                            </button>
                            <span id="customer-page-info" style="font-size: 14px; color: #666; margin: 0 15px;">Page 1 of 1</span>
                            <button id="next-customers-btn" onclick="nextCustomersPage()" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 14px;" disabled>
                                Next 
                            </button>
                        </div>

                        <!-- No Customers Message -->
                        <div id="no-customers-message" style="text-align: center; padding: 40px; color: #666; font-style: italic; display: none;">
                            <h3 style="color: #999;"> No Customers Found</h3>
                            <p>Add your first customer above or import existing customer data!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div class="container">
        <div id="analytics" class="tab-content">
            <h2> Analytics</h2>





            <!-- Export & Download Section -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-download"></i> Export & Download Reports</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Report Type:</label>
                        <select id="report-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="sales">Sales Report</option>
                            <option value="customers">Customer Report</option>
                            <option value="products">Product Report</option>
                            <option value="analytics">Analytics Summary</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Customer Filter:</label>
                        <select id="customer-filter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">All Customers</option>
                            <option value="top-customers">Top 10 Customers</option>
                            <option value="new-customers">New Customers</option>
                            <option value="returning-customers">Returning Customers</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Date Range:</label>
                        <select id="export-date-range" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Format:</label>
                        <select id="export-format" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                            <option value="pdf">PDF (.pdf)</option>
                        </select>
                    </div>
                </div>
                <div id="custom-date-range" style="display: none; margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label style="font-weight: 600;">From:</label>
                        <input type="date" id="export-start-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        <label style="font-weight: 600;">To:</label>
                        <input type="date" id="export-end-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="downloadReport()" style="background: var(--success-600); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-download"></i> Download Report
                    </button>
                    <button onclick="previewReport()" style="background: var(--primary-600); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-eye"></i> Preview Report
                    </button>
                    <button onclick="emailReport()" style="background: var(--secondary-600); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-envelope"></i> Email Report
                    </button>
                    <button onclick="scheduleReport()" style="background: var(--warning-600); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-clock"></i> Schedule Report
                    </button>
                </div>
            </div>


        </div>
    </div>

    <!-- Business Intelligence Tab -->
        <div id="business-intelligence" class="tab-content">
            <h2> Business Intelligence & AI Insights</h2>

            <!-- AI Insights Summary -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;"><i class="fas fa-robot"></i> AI-Powered Insights</h3>
                    <button onclick="generateAIInsights()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                        <i class="fas fa-sync-alt"></i> Refresh Insights
                    </button>
                </div>
                <div id="ai-insights-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 8px;"><i class="fas fa-chart-line"></i> Sales Forecast</h4>
                        <p id="sales-forecast" style="font-size: 14px; margin: 0;">Analyzing data...</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 8px;"><i class="fas fa-users"></i> Customer Behavior</h4>
                        <p id="customer-behavior" style="font-size: 14px; margin: 0;">Processing insights...</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 8px;"><i class="fas fa-gem"></i> Product Trends</h4>
                        <p id="product-trends" style="font-size: 14px; margin: 0;">Evaluating patterns...</p>
                    </div>
                </div>
            </div>

            <!-- Sales Forecasting -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-crystal-ball"></i> Sales Forecasting</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <canvas id="forecastChart" width="400" height="300"></canvas>
                    </div>
                    <div>
                        <h4>Forecast Details</h4>
                        <div id="forecast-details" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <p><strong>Next 7 Days:</strong> <span id="forecast-7days">0</span></p>
                            <p><strong>Next 30 Days:</strong> <span id="forecast-30days">0</span></p>
                            <p><strong>Confidence Level:</strong> <span id="forecast-confidence">0%</span></p>
                            <p><strong>Trend:</strong> <span id="forecast-trend">Stable</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Lifetime Value -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-user-friends"></i> Customer Lifetime Value Analysis</h3>
                <div id="clv-analysis" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- CLV data will be populated here -->
                </div>
            </div>

            <!-- Seasonal Analysis -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-calendar-alt"></i> Seasonal Trends Analysis</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <canvas id="seasonalChart" width="400" height="300"></canvas>
                    </div>
                    <div>
                        <h4>Seasonal Insights</h4>
                        <div id="seasonal-insights" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <!-- Seasonal data will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profit Optimization -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-coins"></i> Profit Optimization Recommendations</h3>
                <div id="profit-optimization" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <!-- Profit optimization suggestions will be populated here -->
                </div>
            </div>
        </div>

        <!-- Integrations Tab -->
        <div id="integrations" class="tab-content">
            <h2> Integrations & Communication</h2>

            <!-- WhatsApp Integration -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fab fa-whatsapp"></i> WhatsApp Integration</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">WhatsApp Business Phone:</label>
                        <input type="tel" id="whatsapp-phone" placeholder="+91 9876543210" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                        <button onclick="testWhatsAppConnection()" style="background: #25D366; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            <i class="fab fa-whatsapp"></i> Test Connection
                        </button>
                    </div>
                    <div>
                        <h4>Quick Actions</h4>
                        <button onclick="sendSalesReceipt()" style="background: #25D366; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-bottom: 10px; width: 100%;">
                            <i class="fas fa-receipt"></i> Send Sales Receipt
                        </button>
                        <button onclick="sendPaymentReminder()" style="background: #25D366; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-bottom: 10px; width: 100%;">
                            <i class="fas fa-bell"></i> Send Payment Reminder
                        </button>
                    </div>
                </div>
            </div>

            <!-- Email Integration -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-envelope"></i> Email Integration</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Business Email:</label>
                        <input type="email" id="business-email" placeholder="business@example.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Email Template:</label>
                        <select id="email-template" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="receipt">Sales Receipt</option>
                            <option value="reminder">Payment Reminder</option>
                            <option value="thanks">Thank You Note</option>
                        </select>
                    </div>
                    <div>
                        <h4>Email Actions</h4>
                        <button onclick="sendEmailReceipt()" style="background: #0084ff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-bottom: 10px; width: 100%;">
                            <i class="fas fa-paper-plane"></i> Send Email Receipt
                        </button>
                        <button onclick="sendBulkEmails()" style="background: #0084ff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-bottom: 10px; width: 100%;">
                            <i class="fas fa-broadcast-tower"></i> Send Bulk Emails
                        </button>
                    </div>
                </div>
            </div>

            <!-- SMS Integration -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-sms"></i> SMS Integration</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">SMS API Key:</label>
                        <input type="password" id="sms-api-key" placeholder="Enter your SMS API key" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Sender ID:</label>
                        <input type="text" id="sms-sender-id" placeholder="JEWELZ" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div>
                        <h4>SMS Actions</h4>
                        <button onclick="sendSMSReceipt()" style="background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-bottom: 10px; width: 100%;">
                            <i class="fas fa-mobile-alt"></i> Send SMS Receipt
                        </button>
                        <button onclick="sendSMSReminder()" style="background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-bottom: 10px; width: 100%;">
                            <i class="fas fa-clock"></i> Send SMS Reminder
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Tab -->
        <div id="security" class="tab-content">
            <h2> Security & Access Control</h2>

            <!-- Authentication Section -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-user-lock"></i> User Authentication</h3>
                <div id="auth-status" style="margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <strong>Status:</strong> <span id="auth-status-text">Not Authenticated</span>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Username:</label>
                        <input type="text" id="auth-username" placeholder="Enter username" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Password:</label>
                        <input type="password" id="auth-password" placeholder="Enter password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                        <button onclick="authenticateUser()" style="background: var(--primary-600); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>
                    <div>
                        <h4>Security Features</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="two-factor-auth" onchange="toggleTwoFactorAuth()">
                                <span>Two-Factor Authentication</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="session-timeout" onchange="toggleSessionTimeout()" checked>
                                <span>Auto-logout (30 min)</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="audit-trail" onchange="toggleAuditTrail()" checked>
                                <span>Audit Trail Logging</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Access Control -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-users-cog"></i> Access Control & Permissions</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>User Roles</h4>
                        <div id="user-roles" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="radio" name="user-role" value="admin" checked>
                                    <span><strong>Admin</strong> - Full access</span>
                                </label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="radio" name="user-role" value="manager">
                                    <span><strong>Manager</strong> - Sales & Reports</span>
                                </label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="radio" name="user-role" value="staff">
                                    <span><strong>Staff</strong> - Sales Entry Only</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4>Current Permissions</h4>
                        <div id="current-permissions" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="margin-bottom: 5px;"> Create Sales</div>
                            <div style="margin-bottom: 5px;"> View Sales</div>
                            <div style="margin-bottom: 5px;"> Edit Sales</div>
                            <div style="margin-bottom: 5px;"> Delete Sales</div>
                            <div style="margin-bottom: 5px;"> View Analytics</div>
                            <div style="margin-bottom: 5px;"> Export Data</div>
                            <div style="margin-bottom: 5px;"> System Settings</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Encryption -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-lock"></i> Data Protection & Encryption</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Encryption Settings</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="encrypt-customer-data" checked>
                                <span>Encrypt Customer Data</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="encrypt-sales-data" checked>
                                <span>Encrypt Sales Data</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="encrypt-backups" checked>
                                <span>Encrypt Backups</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <h4>Security Status</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="margin-bottom: 5px;"> <strong>Encryption:</strong> AES-256 Active</div>
                            <div style="margin-bottom: 5px;"> <strong>Authentication:</strong> Enabled</div>
                            <div style="margin-bottom: 5px;"> <strong>Audit Logs:</strong> Active</div>
                            <div style="margin-bottom: 5px;"> <strong>Data Protection:</strong> Compliant</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Trail -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-history"></i> Audit Trail</h3>
                <div style="margin-bottom: 15px;">
                    <button onclick="viewAuditLogs()" style="background: var(--primary-600); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                        <i class="fas fa-eye"></i> View Logs
                    </button>
                    <button onclick="exportAuditLogs()" style="background: var(--success-600); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                        <i class="fas fa-download"></i> Export Logs
                    </button>
                    <button onclick="clearAuditLogs()" style="background: var(--error-600); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-trash"></i> Clear Logs
                    </button>
                </div>
                <div id="audit-logs-display" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <div style="font-family: monospace; font-size: 12px; color: #666;">
                        [2024-01-15 10:30:22] USER_LOGIN: admin - IP: 192.168.1.100<br>
                        [2024-01-15 10:35:15] SALE_CREATED: Sale ID 12345 - Amount: 5,000<br>
                        [2024-01-15 10:40:08] CUSTOMER_ADDED: Customer ID 67890 - Name: John Doe<br>
                        [2024-01-15 10:45:30] DATA_EXPORT: Sales data exported by admin<br>
                        [2024-01-15 10:50:12] SETTINGS_CHANGED: Database method updated<br>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let salesData = [];
        let customersData = [];
        let salesChart = null;
        let categoryChart = null;
        let displayedSalesCount = 20; // Initial number of sales to show

        // Multi-select category variables
        let selectedCategories = [];
        let isCategoryDropdownOpen = false;

        // ======== DATABASE CONFIGURATION ========
        // Database configuration object
        const dbConfig = {
            // Choose your preferred database method:
            // 'firebase' - Firebase Firestore (recommended)
            // 'google-sheets' - Google Sheets
            // 'local' - Local storage only
            method: 'firebase',

            // Firebase configuration
            firebase: {
                apiKey: "AIzaSyBEbRfCjqEOfoLTdrCPCuGHVRIOBPIUEIg",
                authDomain: "theiajewelz.firebaseapp.com",
                projectId: "theiajewelz",
                storageBucket: "theiajewelz.firebasestorage.app",
                messagingSenderId: "328369793227",
                appId: "1:328369793227:web:03c7cbf22b3c2f05cdd34e",
                measurementId: "G-1BKG612HJG"
            },

            // Google Sheets configuration
            googleSheets: {
                scriptUrl: "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE",
                enabled: true
            },

            // Auto-save settings
            autoSave: true,
            showSaveStatus: true
        };

        // Database connection objects
        let firebaseApp = null;
        let firestore = null;
        let auth = null;

        // ======== DATABASE INITIALIZATION ========
        function initializeDatabase() {
            console.log(' Initializing database...', dbConfig.method);
            console.log(' Running on domain:', window.location.hostname);

            switch(dbConfig.method) {
                case 'firebase':
                    return initializeFirebase();
                case 'google-sheets':
                    return initializeGoogleSheets();
                case 'local':
                    return initializeLocalStorage();
                default:
                    console.warn('Unknown database method, falling back to local storage');
                    return initializeLocalStorage();
            }
        }

        // Test Firebase connection
        async function testFirebaseConnection() {
            if (!firestore) {
                console.error(' Firebase not initialized');
                alert(' Firebase not initialized. Check console for details.');
                return false;
            }

            try {
                console.log(' Testing Firebase connection...');
                console.log(' Domain:', window.location.hostname);
                console.log(' Origin:', window.location.origin);
                console.log(' Protocol:', window.location.protocol);

                const testDoc = await firestore.collection('connection-test').add({
                    test: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    domain: window.location.hostname,
                    origin: window.location.origin,
                    protocol: window.location.protocol,
                    userAgent: navigator.userAgent,
                    testTime: new Date().toISOString()
                });

                console.log(' Firebase connection test successful:', testDoc.id);
                showDatabaseStatus('Firebase connection test successful', 'success');

                // Clean up test document after 5 seconds
                setTimeout(async () => {
                    try {
                        await testDoc.delete();
                        console.log(' Test document deleted');
                    } catch (deleteError) {
                        console.log(' Could not delete test document:', deleteError);
                    }
                }, 5000);

                return true;
            } catch (error) {
                console.error(' Firebase connection test failed:', error);
                console.error(' Error code:', error.code);
                console.error(' Error message:', error.message);

                let errorMessage = 'Firebase connection failed: ' + error.message;

                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied - Firebase security rules blocking access from: ' + window.location.hostname + '\n\nPlease update Firebase security rules to allow writes from this domain.';
                } else if (error.code === 'failed-precondition') {
                    errorMessage = 'Firebase configuration error - check project settings';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Firebase service unavailable - check internet connection';
                }

                alert(' ' + errorMessage);
                return false;
            }
        }

        // Initialize Firebase
        function initializeFirebase() {
            try {
                // Check if Firebase is configured
                if (!dbConfig.firebase.apiKey || dbConfig.firebase.apiKey === "YOUR_API_KEY_HERE") {
                    console.warn(' Firebase not configured, using local storage instead');
                    return initializeLocalStorage();
                }

                // Initialize Firebase (check if already exists)
                if (!firebaseApp) {
                    console.log(' Initializing Firebase with config:', dbConfig.firebase);
                    console.log(' Current domain:', window.location.hostname);
                    console.log(' Current origin:', window.location.origin);

                    // Check if Firebase app already exists
                    if (firebase.apps.length === 0) {
                        firebaseApp = firebase.initializeApp(dbConfig.firebase);
                        console.log(' Firebase initialized successfully');
                    } else {
                        firebaseApp = firebase.app();
                        console.log(' Firebase app already exists, using existing instance');
                    }

                    firestore = firebase.firestore();
                    auth = firebase.auth();
                    console.log(' Firestore instance:', firestore);

                    // Configure Firestore for mobile and web
                    firestore.settings({
                        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                        ignoreUndefinedProperties: true
                    });

                    // Mobile-specific settings
                    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                        console.log(' Mobile device detected - enabling persistence');
                        firestore.enablePersistence({ synchronizeTabs: true }).catch(err => {
                            console.log(' Persistence failed:', err);
                            // Persistence can fail for various reasons, but the app will still work
                        });
                    }

                    // Mobile-friendly connection monitoring
                    firestore.onSnapshotsInSync(() => {
                        console.log(' Firestore sync complete');
                    });

                    // Enable network for GitHub Pages
                    firestore.enableNetwork().then(() => {
                        console.log(' Firestore network enabled');

                        // Mobile-specific initialization complete message
                        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                            console.log(' Mobile Firebase initialization complete');
                        }

                        // Connection established - status will be shown in status bar
                    }).catch(err => {
                        console.error(' Firestore network error:', err);
                        showDatabaseStatus('Connection error: ' + err.message, 'error');
                    });

                    // Show connection status
                    showDatabaseStatus('Firebase connected', 'success');
                }

                return true;
            } catch (error) {
                console.error(' Firebase initialization error:', error);

                // Handle duplicate app error specifically
                if (error.code === 'app/duplicate-app') {
                    console.log(' Using existing Firebase app');
                    firebaseApp = firebase.app();
                    firestore = firebase.firestore();
                    auth = firebase.auth();
                    showDatabaseStatus('Firebase connected', 'success');
                    return true;
                }

                console.error(' Firebase initialization failed:', error);
                showDatabaseStatus('Firebase connection failed', 'error');
                return initializeLocalStorage();
            }
        }

        // Initialize Google Sheets
        function initializeGoogleSheets() {
            try {
                if (!dbConfig.googleSheets.scriptUrl || dbConfig.googleSheets.scriptUrl === "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE") {
                    console.warn(' Google Sheets not configured, using local storage instead');
                    return initializeLocalStorage();
                }

                console.log(' Google Sheets initialized');
                showDatabaseStatus('Google Sheets connected', 'success');
                return true;
            } catch (error) {
                console.error(' Google Sheets initialization error:', error);
                showDatabaseStatus('Google Sheets connection failed', 'error');
                return initializeLocalStorage();
            }
        }

        // Initialize Local Storage
        function initializeLocalStorage() {
            console.log(' Using local storage');
            showDatabaseStatus('Local storage active', 'warning');
            return true;
        }

        // ======== DATABASE SAVE FUNCTIONS ========
        async function saveToDatabase(saleData) {
            if (!dbConfig.autoSave) return { success: true, message: 'Auto-save disabled' };

            console.log(' Saving to database:', saleData);
            showSaveStatus('Saving...', 'loading');

            try {
                let result;

                switch(dbConfig.method) {
                    case 'firebase':
                        result = await saveToFirebase(saleData);
                        break;
                    case 'google-sheets':
                        result = await saveToGoogleSheets(saleData);
                        break;
                    case 'local':
                    default:
                        result = await saveToLocalStorage(saleData);
                        break;
                }

                if (result.success) {
                    showSaveStatus('Saved successfully', 'success');
                    console.log(' Save successful:', result.message);
                } else {
                    showSaveStatus('Save failed', 'error');
                    console.error(' Save failed:', result.error);
                }

                return result;
            } catch (error) {
                console.error(' Database save error:', error);
                showSaveStatus('Save error', 'error');
                return { success: false, error: error.message };
            }
        }

        // Save to Firebase
        async function saveToFirebase(saleData) {
            console.log(' Attempting to save to Firebase:', saleData);
            console.log(' Current domain:', window.location.hostname);
            console.log(' User Agent:', navigator.userAgent);
            console.log(' Is mobile:', /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));

            if (!firestore) {
                const error = 'Firebase not initialized';
                console.error('', error);
                alert(' Firebase Error: ' + error);
                return { success: false, error: error };
            }

            try {
                console.log(' Firestore instance exists, saving to collection...');

                // Add comprehensive device/environment information for debugging
                const dataToSave = {
                    ...saleData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: new Date().toISOString(),
                    domain: window.location.hostname,
                    origin: window.location.origin,
                    userAgent: navigator.userAgent,
                    isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                    connectionType: navigator.connection ? navigator.connection.effectiveType : 'unknown',
                    protocol: window.location.protocol,
                    port: window.location.port || (window.location.protocol === 'https:' ? '443' : '80')
                };

                console.log(' Data being saved:', dataToSave);

                // Add timeout for mobile devices
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Operation timed out')), 15000);
                });

                const savePromise = firestore.collection('sales').add(dataToSave);

                const docRef = await Promise.race([savePromise, timeoutPromise]);

                console.log(' Successfully saved to Firebase with ID:', docRef.id);

                // Show success message on mobile
                if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    alert(' Data saved successfully!');
                }

                return {
                    success: true,
                    message: 'Saved to Firebase',
                    id: docRef.id
                };
            } catch (error) {
                console.error(' Firebase save error:', error);
                console.error(' Error code:', error.code);
                console.error(' Error details:', error);

                // Handle specific Firebase errors with mobile-friendly messages
                if (error.code === 'permission-denied') {
                    const errorMsg = 'Permission denied. Firebase security rules are blocking access from this device/domain: ' + window.location.hostname;
                    console.error(' Permission Error:', errorMsg);
                    alert(' Permission Error: ' + errorMsg + '\n\nPlease check Firebase security rules in the Firebase Console.');
                    return { success: false, error: errorMsg };
                } else if (error.code === 'unavailable') {
                    const errorMsg = 'Firebase service unavailable. Please check your internet connection and try again.';
                    console.error(' Unavailable Error:', errorMsg);
                    alert(' ' + errorMsg);
                    return { success: false, error: errorMsg };
                } else if (error.message === 'Operation timed out') {
                    const errorMsg = 'Operation timed out. Please check your internet connection and try again.';
                    console.error(' Timeout Error:', errorMsg);
                    alert(' ' + errorMsg);
                    return { success: false, error: errorMsg };
                }

                alert(' Firebase Save Error: ' + error.message);
                return { success: false, error: error.message };
            }
        }

        // Save to Google Sheets
        async function saveToGoogleSheets(saleData) {
            if (!dbConfig.googleSheets.scriptUrl || dbConfig.googleSheets.scriptUrl === "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE") {
                return { success: false, error: 'Google Sheets not configured' };
            }

            try {
                const response = await fetch(dbConfig.googleSheets.scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saleData)
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Google Sheets save error:', error);
                return { success: false, error: error.message };
            }
        }

        // Save to Local Storage
        async function saveToLocalStorage(saleData) {
            try {
                const existingData = JSON.parse(localStorage.getItem('theiaJewelz_sales') || '[]');
                existingData.push({
                    ...saleData,
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString()
                });

                localStorage.setItem('theiaJewelz_sales', JSON.stringify(existingData));

                return {
                    success: true,
                    message: 'Saved to local storage',
                    id: saleData.id
                };
            } catch (error) {
                console.error('Local storage save error:', error);
                return { success: false, error: error.message };
            }
        }

        // ======== DATABASE LOAD FUNCTIONS ========
        async function loadFromDatabase() {
            console.log(' Loading from database...');

            try {
                let result;

                switch(dbConfig.method) {
                    case 'firebase':
                        result = await loadFromFirebase();
                        break;
                    case 'google-sheets':
                        result = await loadFromGoogleSheets();
                        break;
                    case 'local':
                    default:
                        result = await loadFromLocalStorage();
                        break;
                }

                if (result.success && result.data) {
                    salesData = result.data;
                    console.log(` Loaded ${salesData.length} sales records`);
                    updateDashboard();

                    // Trigger insights generation after data is loaded
                    setTimeout(() => {
                        generateBusinessIntelligence();
                    }, 100);
                }

                return result;
            } catch (error) {
                console.error(' Database load error:', error);
                return { success: false, error: error.message };
            }
        }

        // Load from Firebase
        async function loadFromFirebase() {
            if (!firestore) {
                return { success: false, error: 'Firebase not initialized' };
            }

            try {
                const snapshot = await firestore.collection('sales')
                    .orderBy('timestamp', 'desc')
                    .limit(1000)
                    .get();

                const data = [];
                snapshot.forEach(doc => {
                    data.push({ id: doc.id, ...doc.data() });
                });

                return {
                    success: true,
                    data: data,
                    message: `Loaded ${data.length} records from Firebase`
                };
            } catch (error) {
                console.error('Firebase load error:', error);
                return { success: false, error: error.message };
            }
        }

        // Load from Google Sheets
        async function loadFromGoogleSheets() {
            // This would require additional API setup
            return { success: false, error: 'Google Sheets loading not implemented yet' };
        }

        // Load from Local Storage
        async function loadFromLocalStorage() {
            try {
                const data = JSON.parse(localStorage.getItem('theiaJewelz_sales') || '[]');
                return {
                    success: true,
                    data: data,
                    message: `Loaded ${data.length} records from local storage`
                };
            } catch (error) {
                console.error('Local storage load error:', error);
                return { success: false, error: error.message };
            }
        }

        // ======== STATUS DISPLAY FUNCTIONS ========
        function showDatabaseStatus(message, type) {
            if (!dbConfig.showSaveStatus) return;

            const statusDiv = document.getElementById('database-status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `database-status ${type}`;
            }
        }

        function showSaveStatus(message, type) {
            if (!dbConfig.showSaveStatus) return;

            const statusDiv = document.getElementById('save-status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `save-status ${type}`;

                // Auto-hide after 3 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        statusDiv.textContent = '';
                        statusDiv.className = 'save-status';
                    }, 3000);
                }
            }
        }

        // Function to handle record display selection
        function changeRecordDisplay() {
            const selector = document.getElementById('record-display-selector');
            const selectedValue = selector.value;

            // Get all sections by their IDs
            const salesImportSection = document.getElementById('sales-import-section');
            const salesRecordSection = document.getElementById('sales-records-section');
            const purchaseHistorySection = document.getElementById('purchase-history-section');

            // Hide all sections initially
            if (salesImportSection) salesImportSection.style.display = 'none';
            if (salesRecordSection) salesRecordSection.style.display = 'none';
            if (purchaseHistorySection) purchaseHistorySection.style.display = 'none';

            // Show selected section(s)
            switch(selectedValue) {
                case 'sales-record':
                    if (salesImportSection) salesImportSection.style.display = 'block';
                    if (salesRecordSection) salesRecordSection.style.display = 'block';
                    break;
                case 'purchase-history':
                    if (purchaseHistorySection) purchaseHistorySection.style.display = 'block';
                    break;
            }
        }

        // Initialize the display on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set the dropdown to sales-record (default)
            const selector = document.getElementById('record-display-selector');
            if (selector) {
                selector.value = 'sales-record';
            }

            // Set initial display to show only sales records
            changeRecordDisplay();
        });



        // Multi-Select Category Functions
        function toggleCategoryDropdown(event) {
            console.log('=== toggleCategoryDropdown called ===');

            // Prevent event propagation if event is passed
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
                console.log('Event propagation stopped');
            }

            const dropdown = document.getElementById('category-dropdown');
            const display = document.getElementById('category-display');
            const arrow = document.getElementById('category-arrow');

            // Check if elements exist
            if (!dropdown || !display || !arrow) {
                console.error('Category dropdown elements not found:', {
                    dropdown: !!dropdown,
                    display: !!display,
                    arrow: !!arrow
                });
                return;
            }

            // Use global state variable instead of computed styles
            console.log('Global dropdown state (isCategoryDropdownOpen):', isCategoryDropdownOpen);
            console.log('Dropdown style.display:', dropdown.style.display);
            console.log('Dropdown offsetHeight:', dropdown.offsetHeight);

            // Use the global state variable for more reliable state tracking
            const isVisible = isCategoryDropdownOpen === true;
            console.log('Is dropdown visible (based on state)?', isVisible);

            if (!isVisible) {
                console.log('Opening dropdown...');

                // Get the position of the display element for fixed positioning
                const rect = display.getBoundingClientRect();

                // Force show the dropdown with fixed positioning
                dropdown.style.setProperty('display', 'block', 'important');
                dropdown.style.setProperty('visibility', 'visible', 'important');
                dropdown.style.setProperty('opacity', '1', 'important');
                dropdown.style.setProperty('position', 'fixed', 'important');
                dropdown.style.setProperty('z-index', '99999', 'important');
                dropdown.style.setProperty('top', rect.bottom + 'px', 'important');
                dropdown.style.setProperty('left', rect.left + 'px', 'important');
                dropdown.style.setProperty('width', rect.width + 'px', 'important');
                dropdown.style.setProperty('background', 'white', 'important');
                dropdown.style.setProperty('border', '2px solid var(--primary-600)', 'important');
                dropdown.style.setProperty('border-top', 'none', 'important');
                dropdown.style.setProperty('border-radius', '0 0 8px 8px', 'important');
                dropdown.style.setProperty('max-height', '250px', 'important');
                dropdown.style.setProperty('overflow-y', 'auto', 'important');
                dropdown.style.setProperty('box-shadow', '0 10px 25px rgba(0,0,0,0.3)', 'important');

                display.classList.add('active');
                display.setAttribute('aria-expanded', 'true');
                arrow.style.transform = 'rotate(180deg)';

                // Update global state
                isCategoryDropdownOpen = true;

                console.log(' Dropdown opened successfully!');
            } else {
                console.log('Closing dropdown...');
                dropdown.style.setProperty('display', 'none', 'important');
                dropdown.style.setProperty('visibility', 'hidden', 'important');
                dropdown.style.setProperty('opacity', '0', 'important');

                display.classList.remove('active');
                display.setAttribute('aria-expanded', 'false');
                arrow.style.transform = 'rotate(0deg)';

                // Update global state
                isCategoryDropdownOpen = false;

                console.log(' Dropdown closed successfully!');
            }
        }



        // ======== TAB NAVIGATION FUNCTIONS ========
        function showTab(tabName) {
            try {
                // 1. Hide all tab contents first
                const tabContents = document.querySelectorAll('.tab-content');
                console.log('Found tab contents:', tabContents.length);
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });

                // 2. Remove active class from ALL navigation elements
                const allNavElements = document.querySelectorAll('.mobile-tab, .tab, .bottom-nav-item, [data-tab], .nav-item');
                console.log('Found nav elements:', allNavElements.length);
                allNavElements.forEach(element => {
                    element.classList.remove('active');
                });

                // 3. Show the selected tab content
                const selectedContent = document.getElementById(tabName);
                if (selectedContent) {
                    selectedContent.classList.add('active');
                    selectedContent.style.display = 'block';
                    console.log(' Tab content shown:', tabName);
                } else {
                    console.error(' Tab content not found:', tabName);
                    console.log('Available tabs:', Array.from(document.querySelectorAll('.tab-content')).map(t => t.id));
                    return; // Exit if tab content not found
                }

                // 4. Activate ONLY the button(s) that correspond to the current tab
                const targetButtons = document.querySelectorAll(`[data-tab="${tabName}"]`);
                console.log(`Found ${targetButtons.length} buttons for tab: ${tabName}`);

                targetButtons.forEach(button => {
                    button.classList.add('active');
                    console.log(' Activated button for tab:', tabName, button);
                });

                // Perform tab-specific actions
                switch(tabName) {
                    case 'dashboard':
                        if (typeof updateDashboard === 'function') {
                            updateDashboard();
                            // Also ensure charts are updated after a short delay to allow DOM to render
                            setTimeout(() => {
                                if (typeof updateCharts === 'function') {
                                    updateCharts();
                                }
                            }, 100);
                        } else {
                            console.warn('updateDashboard function not found');
                        }
                        break;
                    case 'customers':
                        if (typeof loadCustomers === 'function') {
                            loadCustomers();
                        } else {
                            console.warn('loadCustomers function not found');
                        }
                        break;
                    case 'recent-sales':
                        if (typeof loadSalesRecords === 'function') {
                            loadSalesRecords();
                            // Ensure the sales section is expanded
                            const salesContentContainer = document.getElementById('sales-content-container');
                            if (salesContentContainer) {
                                salesContentContainer.classList.remove('collapsed');
                            }

                        // Load sales summary table to show statistics
                        if (typeof loadSalesSummaryTable === 'function') {
                            loadSalesSummaryTable();
                        } else {
                            console.warn('loadSalesSummaryTable function not found');
                        }
                        } else {
                            console.warn('loadSalesRecords function not found');
                        }
                        break;
                    case 'analytics':
                        // Analytics tab only has export functionality now
                        console.log('Analytics tab loaded (export functionality only)');
                        break;
                    case 'sales':
                        // Focus on the first input field
                        setTimeout(() => {
                            const firstInput = document.querySelector('#sales input:first-of-type');
                            if (firstInput) {
                                firstInput.focus();
                                console.log(' Focused on first input field');
                            } else {
                                console.log('No input field found in sales tab');
                            }
                        }, 100);
                        break;
                    case 'business-intelligence':
                        if (typeof generateBusinessIntelligence === 'function') {
                            generateBusinessIntelligence();
                        } else {
                            console.warn('generateBusinessIntelligence function not found');
                        }
                        break;
                    default:
                        console.log('No specific actions for tab:', tabName);
                }

                console.log(' Tab switch completed:', tabName);
            } catch (error) {
                console.error(' Error in showTab function:', error);
            }
        }

        function updateSelectedCategories() {
            const checkboxes = document.querySelectorAll('.category-options input[type="checkbox"]');
            const placeholder = document.getElementById('category-placeholder');
            const selectedContainer = document.getElementById('category-selected');
            const errorDiv = document.getElementById('category-error');

            selectedCategories = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedCategories.push(checkbox.value);
                }
            });

            // Hide error if categories are selected
            if (selectedCategories.length > 0) {
                errorDiv.style.display = 'none';
            }

            if (selectedCategories.length === 0) {
                placeholder.style.display = 'block';
                selectedContainer.style.display = 'none';
                placeholder.textContent = 'Select categories...';
            } else {
                placeholder.style.display = 'none';
                selectedContainer.style.display = 'flex';

                selectedContainer.innerHTML = selectedCategories.map(category => {
                    const icon = getCategoryIcon(category);
                    return `
                        <span class="category-tag">
                            ${icon} ${category}
                            <button type="button" class="remove-tag" onclick="removeCategory('${category}')" title="Remove ${category}">
                                
                            </button>
                        </span>
                    `;
                }).join('');
            }
        }

        function getCategoryIcon(category) {
            const icons = {
                'Necklaces': '',
                'Earrings': '',
                'Bracelets': '',
                'Rings': '',
                'Anklets': '',
                'Sets': '',
                'Bangles': '',
                'Chains': '',
                'Pendants': '',
                'Brooches': ''
            };
            return icons[category] || '';
        }

        function removeCategory(categoryToRemove) {
            const checkbox = document.querySelector(`input[value="${categoryToRemove}"]`);
            if (checkbox) {
                checkbox.checked = false;
                updateSelectedCategories();
            }
        }

        function selectAllCategories() {
            const checkboxes = document.querySelectorAll('.category-options input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCategories();
        }

        function clearAllCategories() {
            const checkboxes = document.querySelectorAll('.category-options input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCategories();
        }

        // Close dropdown when clicking outside (with small delay to prevent interference)
        document.addEventListener('click', function(event) {
            setTimeout(() => {
                const container = document.querySelector('.multi-select-container');
                const dropdown = document.getElementById('category-dropdown');

                if (container && !container.contains(event.target) && dropdown) {
                    const isVisible = dropdown.style.display === 'block';
                    if (isVisible) {
                        console.log('Closing dropdown due to outside click');
                        closeDropdown();
                    }
                }
            }, 10); // Small delay to allow click events to process
        });

        // Separate function to close dropdown
        function closeDropdown() {
            const dropdown = document.getElementById('category-dropdown');
            const display = document.getElementById('category-display');
            const arrow = document.getElementById('category-arrow');

            if (dropdown && display && arrow) {
                dropdown.style.setProperty('display', 'none', 'important');
                dropdown.style.setProperty('visibility', 'hidden', 'important');
                dropdown.style.setProperty('opacity', '0', 'important');
                display.classList.remove('active');
                display.setAttribute('aria-expanded', 'false');
                arrow.style.transform = 'rotate(0deg)';
                isCategoryDropdownOpen = false;
                console.log('Dropdown closed via closeDropdown()');
            }
        }

        // Separate function to open dropdown
        function openDropdown() {
            const dropdown = document.getElementById('category-dropdown');
            const display = document.getElementById('category-display');
            const arrow = document.getElementById('category-arrow');

            if (dropdown && display && arrow) {
                // Position dropdown correctly
                const rect = display.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const dropdownHeight = 250;

                if (rect.bottom + dropdownHeight > viewportHeight) {
                    dropdown.style.top = 'auto';
                    dropdown.style.bottom = '100%';
                    dropdown.style.borderRadius = 'var(--radius-md) var(--radius-md) 0 0';
                    dropdown.style.borderTop = '2px solid var(--primary-600)';
                    dropdown.style.borderBottom = 'none';
                } else {
                    dropdown.style.top = '100%';
                    dropdown.style.bottom = 'auto';
                    dropdown.style.borderRadius = '0 0 var(--radius-md) var(--radius-md)';
                    dropdown.style.borderTop = 'none';
                    dropdown.style.borderBottom = '2px solid var(--primary-600)';
                }

                dropdown.style.display = 'block';
                dropdown.style.visibility = 'visible';
                dropdown.style.opacity = '1';
                display.classList.add('active');
                display.setAttribute('aria-expanded', 'true');
                arrow.style.transform = 'rotate(180deg)';
                dropdown.style.zIndex = '99999';
                dropdown.style.position = 'absolute';
                isCategoryDropdownOpen = true;
                console.log('Dropdown opened');
            }
        }

        // Initialize Collapsible Sections
        function initializeCollapsibleSections() {
            // Initialize Sales Section as collapsed
            const salesContainer = document.getElementById('sales-content-container');
            const salesToggleBtn = document.getElementById('sales-toggle-btn');

            if (salesContainer && salesToggleBtn) {
                salesContainer.classList.add('collapsed');
                salesToggleBtn.textContent = '';
                salesToggleBtn.classList.add('collapsed');
                salesToggleBtn.title = 'Expand Sales Records';
            }

            // Initialize Purchase History Section as collapsed
            const purchaseContainer = document.getElementById('purchase-content-container');
            const purchaseToggleBtn = document.getElementById('purchase-toggle-btn');

            if (purchaseContainer && purchaseToggleBtn) {
                purchaseContainer.classList.add('collapsed');
                purchaseToggleBtn.textContent = '';
                purchaseToggleBtn.classList.add('collapsed');
                purchaseToggleBtn.title = 'Expand Purchase History';
            }
        }

        // Toggle Sales Section
        function toggleSalesSection() {
            const container = document.getElementById('sales-content-container');
            const toggleBtn = document.getElementById('sales-toggle-btn');

            if (container.classList.contains('collapsed')) {
                container.classList.remove('collapsed');
                container.classList.add('expanded');
                toggleBtn.textContent = '';
                toggleBtn.classList.remove('collapsed');
                toggleBtn.title = 'Collapse Sales Records';
                // Load sales data when expanded
                loadSalesRecords();
            } else {
                container.classList.remove('expanded');
                container.classList.add('collapsed');
                toggleBtn.textContent = '';
                toggleBtn.classList.add('collapsed');
                toggleBtn.title = 'Expand Sales Records';
            }
        }

        // PWA Installation
        let deferredPrompt;
        let installBtn = null;

        // Initialize category dropdown
        function initializeCategoryDropdown() {
            console.log('Initializing category dropdown...');

            // Ensure dropdown starts hidden
            const dropdown = document.getElementById('category-dropdown');
            const display = document.getElementById('category-display');
            const arrow = document.getElementById('category-arrow');

            if (dropdown && display) {
                console.log('Dropdown display before init:', `"${dropdown.style.display}"`);
                console.log('Dropdown offsetHeight before init:', dropdown.offsetHeight);

                // Force complete reset of dropdown state
                dropdown.style.removeProperty('display');
                dropdown.style.removeProperty('visibility');
                dropdown.style.removeProperty('opacity');
                dropdown.style.removeProperty('position');
                dropdown.style.removeProperty('top');
                dropdown.style.removeProperty('left');
                dropdown.style.removeProperty('width');
                dropdown.style.removeProperty('z-index');

                // Set initial hidden state
                dropdown.style.setProperty('display', 'none', 'important');
                dropdown.style.setProperty('visibility', 'hidden', 'important');

                // Reset display element
                dropdown.style.setProperty('opacity', '0', 'important');
                display.classList.remove('active');
                display.setAttribute('aria-expanded', 'false');

                // Reset arrow
                if (arrow) {
                    arrow.style.transform = 'rotate(0deg)';
                }

                // Reset global state
                isCategoryDropdownOpen = false;

                console.log('Dropdown display after init:', `"${dropdown.style.display}"`);
                console.log('Dropdown offsetHeight after init:', dropdown.offsetHeight);
                console.log('Dropdown initialized in closed state');

                // Alternative click event binding as fallback
                display.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('Category display clicked via event listener');
                    toggleCategoryDropdown();
                });

                // Touch event for mobile
                display.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('Category display touched');
                    toggleCategoryDropdown();
                });

                // Prevent clicks inside dropdown from propagating and closing it
                dropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('Click inside dropdown - prevented propagation');
                });

                console.log('Category dropdown event listeners attached');
            } else {
                console.error('Category dropdown elements not found!', {
                    dropdown: !!dropdown,
                    display: !!display
                });
            }
        }

        // ======== SETTINGS FUNCTIONALITY ========
        let customFields = {
            sales: [],
            customers: [],
            inventory: [],
            purchases: []
        };

        // Load settings from localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('theiaJewelzSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);

                    // Load app name
                    if (settings.appName) {
                        document.getElementById('app-title').textContent = settings.appName;
                        document.getElementById('app-name-input').value = settings.appName;
                    }

                    // Load custom fields
                    if (settings.customFields) {
                        customFields = settings.customFields;
                        renderCustomFields();
                    }

                    // Load other settings
                    if (settings.companyName) {
                        document.getElementById('company-name').value = settings.companyName;
                    }
                    if (settings.currencySymbol) {
                        document.getElementById('currency-symbol').value = settings.currencySymbol;
                    }

                    // Update domain display
                    document.getElementById('current-domain').textContent = window.location.hostname;

                    // Load database settings
                    if (settings.database) {
                        dbConfig.method = settings.database.method || 'firebase';
                        dbConfig.autoSave = settings.database.autoSave !== undefined ? settings.database.autoSave : true;
                        dbConfig.showSaveStatus = settings.database.showSaveStatus !== undefined ? settings.database.showSaveStatus : true;

                        // Update UI elements
                        const methodSelect = document.getElementById('database-method');
                        const autoSaveToggle = document.getElementById('auto-save-toggle');
                        const showStatusToggle = document.getElementById('show-status-toggle');

                        if (methodSelect) methodSelect.value = dbConfig.method;
                        if (autoSaveToggle) autoSaveToggle.checked = dbConfig.autoSave;
                        if (showStatusToggle) showStatusToggle.checked = dbConfig.showSaveStatus;

                        // Update status displays
                        document.getElementById('current-db-method').textContent =
                            dbConfig.method === 'firebase' ? 'Firebase Firestore' :
                            dbConfig.method === 'google-sheets' ? 'Google Sheets' :
                            'Local Storage';
                        document.getElementById('current-auto-save').textContent =
                            dbConfig.autoSave ? 'Enabled' : 'Disabled';

                        // Show/hide status bar
                        const statusBar = document.querySelector('.status-bar');
                        if (statusBar) {
                            statusBar.style.display = dbConfig.showSaveStatus ? 'flex' : 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            const settings = {
                appName: document.getElementById('app-name-input').value,
                companyName: document.getElementById('company-name').value,
                currencySymbol: document.getElementById('currency-symbol').value,
                customFields: customFields,
                database: {
                    method: dbConfig.method,
                    autoSave: dbConfig.autoSave,
                    showSaveStatus: dbConfig.showSaveStatus
                }
            };

            localStorage.setItem('theiaJewelzSettings', JSON.stringify(settings));

            // Update app title in header
            document.getElementById('app-title').textContent = settings.appName;

            // Apply custom fields to forms
            applyCustomFieldsToForms();

            showSuccess(' Settings saved successfully! Custom fields have been applied to forms.');
            closeSettings();
        }

        // Open settings modal
        function openSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = 'block';

            // Prevent body scrolling and ensure proper positioning
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';

            // Force reflow to ensure proper centering
            setTimeout(() => {
                modal.style.display = 'block';
            }, 10);

            loadSettings();
        }

        // Close settings modal
        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';

            // Restore body scrolling
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
        console.log(' Switching to settings tab:', tabName);

            // Hide all sections
            const sections = ['general', 'database', 'fields', 'help'];
            sections.forEach(section => {
                const element = document.getElementById(section + '-settings');
                if (element) {
                    element.style.display = 'none';
                }
            })}

        // Switch between settings tabs
        function switchSettingsTab(tabName) {
            console.log(' Switching to tab:', tabName);

            // Hide all settings sections
            document.querySelectorAll('.settings-section').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all tabs
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById(tabName + '-settings');
            if (targetSection) {
                targetSection.style.display = 'block';
                console.log(' Showing section:', tabName + '-settings');
            } else {
                console.error(' Section not found:', tabName + '-settings');
            }

            // Activate the clicked tab
            const clickedTab = document.querySelector(`[onclick="switchSettingsTab('${tabName}')"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
                console.log(' Activated tab:', tabName);
            } else {
                console.error(' Tab not found:', tabName);
            }
        }

        // Switch between custom fields tabs
        function switchFieldsTab(tabName) {
            // Hide all fields containers
            document.querySelectorAll('.custom-fields-container').forEach(container => {
                container.style.display = 'none';
            });

            // Remove active class from fields tabs
            document.querySelectorAll('#fields-settings .settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected container and activate tab
            document.getElementById(tabName + '-fields').style.display = 'block';
            event.target.classList.add('active');
        }

        // Add custom field - Show placement modal
        function addCustomField(tabType) {
            currentFieldTab = tabType;
            showFieldPlacementModal(tabType);
        }

        let currentFieldTab = '';
        let selectedPlacement = '';

        // Show field placement modal
        function showFieldPlacementModal(tabType) {
            const modal = document.getElementById('field-placement-modal');
            const optionsContainer = document.getElementById('placement-options-container');

            // Clear previous options
            optionsContainer.innerHTML = '';

            // Define placement options based on tab type
            const placementOptions = getPlacementOptions(tabType);

            placementOptions.forEach((option, index) => {
                const optionHTML = `
                    <div class="placement-option" onclick="selectPlacement('${option.id}')">
                        <input type="radio" name="placement" value="${option.id}" id="placement_${index}">
                        <div class="placement-option-content">
                            <div class="placement-option-title">
                                <i class="${option.icon}"></i> ${option.title}
                            </div>
                            <div class="placement-option-desc">${option.description}</div>
                        </div>
                    </div>
                `;
                optionsContainer.innerHTML += optionHTML;
            });

            // Reset form
            document.getElementById('new-field-label').value = '';
            document.getElementById('new-field-type').value = 'text';
            document.getElementById('new-field-required').checked = false;
            selectedPlacement = '';

            modal.style.display = 'block';

            // Force reflow to ensure proper centering
            setTimeout(() => {
                modal.style.display = 'block';
            }, 10);
        }

        // Get placement options based on tab type
        function getPlacementOptions(tabType) {
            const options = {
                sales: [
                    {
                        id: 'customer-details',
                        title: 'Customer Details Section',
                        description: 'Add field in the customer information card (with name, phone, address)',
                        icon: 'fas fa-user'
                    },
                    {
                        id: 'product-details',
                        title: 'Product Details Section',
                        description: 'Add field in the jewelry product information card (with type, weight, rate)',
                        icon: 'fas fa-gem'
                    },
                    {
                        id: 'payment-details',
                        title: 'Payment Details Section',
                        description: 'Add field in the payment information card (with amount, method, advance)',
                        icon: 'fas fa-credit-card'
                    },
                    {
                        id: 'additional-info',
                        title: 'Additional Information Section',
                        description: 'Add field in a separate additional information card',
                        icon: 'fas fa-info-circle'
                    }
                ],
                customers: [
                    {
                        id: 'basic-info',
                        title: 'Basic Information',
                        description: 'Add field in the main customer details (with name, phone, email)',
                        icon: 'fas fa-id-card'
                    },
                    {
                        id: 'contact-info',
                        title: 'Contact Information',
                        description: 'Add field in the contact details section',
                        icon: 'fas fa-address-book'
                    },
                    {
                        id: 'preferences',
                        title: 'Customer Preferences',
                        description: 'Add field for customer preferences and notes',
                        icon: 'fas fa-heart'
                    }
                ],
                inventory: [
                    {
                        id: 'product-basic',
                        title: 'Product Basic Info',
                        description: 'Add field in the basic product information section',
                        icon: 'fas fa-box'
                    },
                    {
                        id: 'product-specs',
                        title: 'Product Specifications',
                        description: 'Add field in the detailed specifications section',
                        icon: 'fas fa-list-ul'
                    },
                    {
                        id: 'pricing-stock',
                        title: 'Pricing & Stock',
                        description: 'Add field in the pricing and stock management section',
                        icon: 'fas fa-calculator'
                    }
                ],
                purchases: [
                    {
                        id: 'supplier-info',
                        title: 'Supplier Information',
                        description: 'Add field in the supplier details section',
                        icon: 'fas fa-truck'
                    },
                    {
                        id: 'purchase-details',
                        title: 'Purchase Details',
                        description: 'Add field in the purchase order details section',
                        icon: 'fas fa-shopping-cart'
                    },
                    {
                        id: 'delivery-info',
                        title: 'Delivery Information',
                        description: 'Add field in the delivery and tracking section',
                        icon: 'fas fa-shipping-fast'
                    }
                ]
            };

            return options[tabType] || [];
        }

        // Select placement option
        function selectPlacement(placementId) {
            selectedPlacement = placementId;

            // Remove selected class from all options
            document.querySelectorAll('.placement-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Add selected class to clicked option
            event.currentTarget.classList.add('selected');

            // Check the radio button
            const radioButton = event.currentTarget.querySelector('input[type="radio"]');
            radioButton.checked = true;
        }

        // Close field placement modal
        function closeFieldPlacementModal() {
            document.getElementById('field-placement-modal').style.display = 'none';
        }

        // Confirm field placement
        function confirmFieldPlacement() {
            const label = document.getElementById('new-field-label').value.trim();
            const type = document.getElementById('new-field-type').value;
            const required = document.getElementById('new-field-required').checked;

            if (!label) {
                alert('Please enter a field label');
                return;
            }

            if (!selectedPlacement) {
                alert('Please select where to place the field');
                return;
            }

            const fieldId = 'custom_' + Date.now();
            const newField = {
                id: fieldId,
                label: label,
                type: type,
                required: required,
                placement: selectedPlacement,
                options: [] // for select/radio fields
            };

            customFields[currentFieldTab].push(newField);
            renderCustomFields();
            closeFieldPlacementModal();

            showSuccess(` Field "${label}" added successfully to ${selectedPlacement.replace('-', ' ')} section!`);
        }

        // Remove custom field
        function removeCustomField(tabType, fieldId) {
            customFields[tabType] = customFields[tabType].filter(field => field.id !== fieldId);
            renderCustomFields();
        }

        // Render custom fields
        function renderCustomFields() {
            Object.keys(customFields).forEach(tabType => {
                const container = document.getElementById('custom-' + tabType + '-fields');
                if (!container) return;

                container.innerHTML = '';

                customFields[tabType].forEach(field => {
                    const placementText = field.placement ? field.placement.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Not specified';
                    const fieldHTML = `
                        <div class="custom-field" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; gap: var(--space-3); align-items: center; margin-bottom: var(--space-2);">
                                <input type="text" placeholder="Field Label" value="${field.label}"
                                       onchange="updateFieldProperty('${tabType}', '${field.id}', 'label', this.value)"
                                       style="flex: 2;">
                                <select onchange="updateFieldProperty('${tabType}', '${field.id}', 'type', this.value)"
                                        style="flex: 1;">
                                    <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option>
                                    <option value="number" ${field.type === 'number' ? 'selected' : ''}>Number</option>
                                    <option value="email" ${field.type === 'email' ? 'selected' : ''}>Email</option>
                                    <option value="phone" ${field.type === 'phone' ? 'selected' : ''}>Phone</option>
                                    <option value="date" ${field.type === 'date' ? 'selected' : ''}>Date</option>
                                    <option value="select" ${field.type === 'select' ? 'selected' : ''}>Dropdown</option>
                                    <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>Text Area</option>
                                </select>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" ${field.required ? 'checked' : ''}
                                           onchange="updateFieldProperty('${tabType}', '${field.id}', 'required', this.checked)">
                                    Required
                                </label>
                                <button class="delete-field-btn" onclick="removeCustomField('${tabType}', '${field.id}')" title="Delete field">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div style="background: var(--primary-50); padding: var(--space-2); border-radius: var(--radius-sm); font-size: 0.85rem; color: var(--primary-700); border: 1px solid var(--primary-200);">
                                <i class="fas fa-map-marker-alt"></i> Will be placed in: <strong>${placementText}</strong> section
                            </div>
                        </div>
                    `;
                    container.innerHTML += fieldHTML;
                });
            });
        }

        // Update field property
        function updateFieldProperty(tabType, fieldId, property, value) {
            const field = customFields[tabType].find(f => f.id === fieldId);
            if (field) {
                field[property] = value;
            }
        }

        // Apply custom fields to forms
        function applyCustomFieldsToForms() {
            // Apply to sales form
            applyCustomFieldsToForm('sales', 'sales-form');
            // Apply to customer form (if exists)
            applyCustomFieldsToForm('customers', 'customer-form');
            // Apply to inventory form (if exists)
            applyCustomFieldsToForm('inventory', 'inventory-form');
            // Apply to purchases form (if exists)
            applyCustomFieldsToForm('purchases', 'purchase-form');
        }

        // Apply custom fields to a specific form
        function applyCustomFieldsToForm(fieldType, formId) {
            const form = document.getElementById(formId);
            if (!form) return;

            // Remove existing custom fields
            const existingCustomFields = form.querySelectorAll('.custom-field-container');
            existingCustomFields.forEach(field => field.remove());

            // Add new custom fields
            customFields[fieldType].forEach(field => {
                if (!field.label) return; // Skip fields without labels

                const fieldContainer = document.createElement('div');
                fieldContainer.className = 'form-group custom-field-container';

                let fieldHTML = `
                    <label for="${field.id}" ${field.required ? 'class="required"' : ''}>
                        ${field.label}
                    </label>
                `;

                switch (field.type) {
                    case 'text':
                    case 'email':
                    case 'phone':
                        fieldHTML += `<input type="${field.type}" id="${field.id}" name="${field.id}" ${field.required ? 'required' : ''} placeholder="Enter ${field.label.toLowerCase()}">`;
                        break;
                    case 'number':
                        fieldHTML += `<input type="number" id="${field.id}" name="${field.id}" ${field.required ? 'required' : ''} placeholder="Enter ${field.label.toLowerCase()}">`;
                        break;
                    case 'date':
                        fieldHTML += `<input type="date" id="${field.id}" name="${field.id}" ${field.required ? 'required' : ''}>`;
                        break;
                    case 'textarea':
                        fieldHTML += `<textarea id="${field.id}" name="${field.id}" ${field.required ? 'required' : ''} placeholder="Enter ${field.label.toLowerCase()}" rows="3"></textarea>`;
                        break;
                    case 'select':
                        fieldHTML += `
                            <select id="${field.id}" name="${field.id}" ${field.required ? 'required' : ''}>
                                <option value="">Select ${field.label.toLowerCase()}</option>
                                <!-- Options would be added based on field configuration -->
                            </select>
                        `;
                        break;
                }

                fieldContainer.innerHTML = fieldHTML;

                // Insert before the submit button
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    form.insertBefore(fieldContainer, submitButton.parentElement);
                } else {
                    form.appendChild(fieldContainer);
                }
            });
        }

        // Close settings when clicking outside
        document.addEventListener('click', function(event) {
            const settingsModal = document.getElementById('settings-modal');
            const placementModal = document.getElementById('field-placement-modal');

            if (event.target === settingsModal) {
                closeSettings();
            }

            if (event.target === placementModal) {
                closeFieldPlacementModal();
            }
        });

        // Keyboard shortcuts for settings
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === ',') { // Ctrl+, to open settings
                event.preventDefault();
                openSettings();
            }
            if (event.key === 'Escape') {
                // Close placement modal first, then settings modal
                const placementModal = document.getElementById('field-placement-modal');
                const settingsModal = document.getElementById('settings-modal');

                if (placementModal.style.display === 'block') {
                    closeFieldPlacementModal();
                } else if (settingsModal.style.display === 'block') {
                    closeSettings();
                }
            }
        });

        // ======== DATABASE SETTINGS FUNCTIONS ========

        // Change database method
        function changeDatabaseMethod() {
            const method = document.getElementById('database-method').value;
            dbConfig.method = method;

            // Update status display
            document.getElementById('current-db-method').textContent =
                method === 'firebase' ? 'Firebase Firestore' :
                method === 'google-sheets' ? 'Google Sheets' :
                'Local Storage';

            // Reinitialize database
            initializeDatabase();

            // Save settings
            saveSettings();

            showSuccess(`Database method changed to ${method}`);
        }

        // Toggle auto-save
        function toggleAutoSave() {
            const autoSave = document.getElementById('auto-save-toggle').checked;
            dbConfig.autoSave = autoSave;

            document.getElementById('current-auto-save').textContent =
                autoSave ? 'Enabled' : 'Disabled';

            saveSettings();
            showSuccess(`Auto-save ${autoSave ? 'enabled' : 'disabled'}`);
        }

        // Toggle show status
        function toggleShowStatus() {
            const showStatus = document.getElementById('show-status-toggle').checked;
            dbConfig.showSaveStatus = showStatus;

            const statusBar = document.querySelector('.status-bar');
            if (statusBar) {
                statusBar.style.display = showStatus ? 'flex' : 'none';
            }

            saveSettings();
            showSuccess(`Status display ${showStatus ? 'enabled' : 'disabled'}`);
        }

        // Test database connection
        async function testDatabaseConnection() {
            showSaveStatus('Testing connection...', 'loading');

            try {
                console.log(' Testing database connection...');
                console.log(' Database method:', dbConfig.method);
                console.log(' Firebase app:', firebaseApp);
                console.log(' Firestore:', firestore);

                const testData = {
                    id: 'test-' + Date.now(),
                    itemName: 'Test Item',
                    category: 'test',
                    costPrice: 100,
                    sellingPrice: 150,
                    profit: 50,
                    saleDate: new Date().toISOString().split('T')[0],
                    customerName: 'Test Customer',
                    customerPhone: 'Test Phone',
                    customerAddress: 'Test Address',
                    createdAt: new Date().toISOString(),
                    isTest: true
                };

                console.log(' Test data:', testData);

                const result = await saveToDatabase(testData);

                if (result.success) {
                    showSuccess(' Database connection successful!');
                    document.getElementById('current-db-status').textContent = 'Connected';
                    alert(' SUCCESS!\n\nDatabase connection test passed!\nCheck Firebase Console for the test document.');
                } else {
                    showError(' Database connection failed: ' + result.error);
                    document.getElementById('current-db-status').textContent = 'Failed';
                    alert(' FAILED!\n\nDatabase connection test failed:\n' + result.error);
                }
            } catch (error) {
                showError(' Connection test error: ' + error.message);
                document.getElementById('current-db-status').textContent = 'Error';
                alert(' ERROR!\n\nConnection test error:\n' + error.message);
            }
        }

        // Run Firebase connection test
        async function runConnectionTest() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';

            try {
                if (dbConfig.method === 'firebase') {
                    await testFirebaseConnection();
                } else {
                    await testDatabaseConnection();
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-vial"></i> Test Firebase Connection';
            }
        }

        // Debug function to test display functions
        function debugDisplayFunctions() {
            console.log(' Testing display functions...');

            try {
                console.log(' Testing updateDashboard...');
                updateDashboard();
                console.log(' updateDashboard passed');
            } catch (e) {
                console.error(' updateDashboard failed:', e);
            }

            try {
                console.log(' Testing loadSalesRecords...');
                loadSalesRecords();
                console.log(' loadSalesRecords passed');
            } catch (e) {
                console.error(' loadSalesRecords failed:', e);
            }

            try {
                console.log(' Testing loadCustomers...');
                loadCustomers();
                console.log(' loadCustomers passed');
            } catch (e) {
                console.error(' loadCustomers failed:', e);
            }

            try {
                console.log(' Testing updateCustomerCount...');
                updateCustomerCount();
                console.log(' updateCustomerCount passed');
            } catch (e) {
                console.error(' updateCustomerCount failed:', e);
            }

            alert('Debug test completed - check console for details');
        }

        // Quick Firebase test from status bar
        async function quickTestFirebase() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                console.log(' Quick Firebase Test Started');
                console.log(' Current URL:', window.location.href);
                console.log(' Current Domain:', window.location.hostname);
                console.log(' Current Origin:', window.location.origin);
                console.log(' Firebase Config:', dbConfig.firebase);
                console.log(' Firebase App:', firebaseApp);
                console.log(' Firestore:', firestore);

                // Mobile-specific debug info
                const mobileInfo = {
                    userAgent: navigator.userAgent,
                    isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink,
                        rtt: navigator.connection.rtt
                    } : 'unknown',
                    online: navigator.onLine,
                    cookieEnabled: navigator.cookieEnabled,
                    platform: navigator.platform,
                    languages: navigator.languages
                };

                console.log(' Mobile Debug Info:', mobileInfo);

                if (dbConfig.method === 'firebase') {
                    await testFirebaseConnection();
                } else {
                    await testDatabaseConnection();
                }

                alert(' Firebase test completed! Check console for details.');
            } catch (error) {
                console.error(' Quick test error:', error);
                alert(' Firebase test failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Sync local data to database
        async function syncLocalData() {
            try {
                const localData = JSON.parse(localStorage.getItem('jewelrySales') || '[]');
                if (localData.length === 0) {
                    showError('No local data to sync');
                    return;
                }

                showSaveStatus('Syncing local data...', 'loading');

                let synced = 0;
                let failed = 0;

                for (const sale of localData) {
                    try {
                        const result = await saveToDatabase(sale);
                        if (result.success) {
                            synced++;
                        } else {
                            failed++;
                        }
                    } catch (error) {
                        failed++;
                    }
                }

                showSuccess(` Sync complete! ${synced} records synced, ${failed} failed`);
            } catch (error) {
                showError(' Sync error: ' + error.message);
            }
        }

        // Download backup
        function downloadBackup() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    salesData: salesData,
                    customersData: customersData,
                    purchaseData: purchaseData,
                    settings: {
                        appName: document.getElementById('app-name-input').value,
                        companyName: document.getElementById('company-name').value,
                        currencySymbol: document.getElementById('currency-symbol').value,
                        databaseMethod: dbConfig.method
                    }
                };

                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `theia-jewelz-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showSuccess(' JSON Backup downloaded successfully!');
            } catch (error) {
                showError(' Backup error: ' + error.message);
            }
        }

        // Download Excel backup
        function downloadExcelBackup() {
            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare Sales Data
                const salesDataForExport = salesData.map(sale => ({
                    'Sale ID': sale.id,
                    'Sale Date': sale.saleDate,
                    'Customer Name': sale.customerName,
                    'Customer Phone': sale.customerPhone,
                    'Customer Address': sale.customerAddress,
                    'Item Name': sale.itemName,
                    'Category': sale.category,
                    'Weight (grams)': sale.weight,
                    'Rate per gram': sale.rate,
                    'Cost Price': sale.costPrice,
                    'Selling Price': sale.sellingPrice,
                    'Profit': sale.profit,
                    'Profit Margin (%)': sale.profitMargin,
                    'Payment Method': sale.paymentMethod,
                    'Advance Amount': sale.advanceAmount,
                    'Balance Amount': sale.balanceAmount,
                    'Notes': sale.notes,
                    'Created At': sale.createdAt
                }));

                // Prepare Customers Data
                const customersDataForExport = customersData.map(customer => ({
                    'Customer ID': customer.id,
                    'Name': customer.name,
                    'Phone': customer.phone,
                    'Address': customer.address,
                    'Total Purchases': customer.totalPurchases,
                    'Total Amount Spent': customer.totalAmountSpent,
                    'Last Purchase Date': customer.lastPurchaseDate,
                    'Created At': customer.createdAt
                }));

                // Prepare Purchase History Data
                const purchaseDataForExport = purchaseData.map(purchase => ({
                    'Purchase ID': purchase.id,
                    'Purchase Date': purchase.purchaseDate,
                    'Vendor Name': purchase.vendorName,
                    'Vendor Phone': purchase.vendorPhone,
                    'Item Name': purchase.itemName,
                    'Category': purchase.category,
                    'Weight (grams)': purchase.weight,
                    'Rate per gram': purchase.rate,
                    'Total Cost': purchase.totalCost,
                    'Payment Method': purchase.paymentMethod,
                    'Payment Status': purchase.paymentStatus,
                    'Notes': purchase.notes,
                    'Created At': purchase.createdAt
                }));

                // Create Summary Sheet
                const summaryData = [{
                    'Export Date': new Date().toLocaleDateString(),
                    'Total Sales Records': salesData.length,
                    'Total Customers': customersData.length,
                    'Total Purchases': purchaseData.length,
                    'Total Sales Revenue': salesData.reduce((sum, sale) => sum + sale.sellingPrice, 0),
                    'Total Sales Profit': salesData.reduce((sum, sale) => sum + sale.profit, 0),
                    'Total Purchase Cost': purchaseData.reduce((sum, purchase) => sum + purchase.totalCost, 0),
                    'Database Method': dbConfig.method,
                    'App Name': document.getElementById('app-name-input').value,
                    'Company Name': document.getElementById('company-name').value,
                    'Currency Symbol': document.getElementById('currency-symbol').value
                }];

                // Add sheets to workbook
                const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                const salesSheet = XLSX.utils.json_to_sheet(salesDataForExport);
                const customersSheet = XLSX.utils.json_to_sheet(customersDataForExport);
                const purchaseSheet = XLSX.utils.json_to_sheet(purchaseDataForExport);

                XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
                XLSX.utils.book_append_sheet(wb, salesSheet, 'Sales Records');
                XLSX.utils.book_append_sheet(wb, customersSheet, 'Customers');
                XLSX.utils.book_append_sheet(wb, purchaseSheet, 'Purchase History');

                // Export file
                const fileName = `Theia_Jewelz_Complete_Backup_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showSuccess(` Excel backup downloaded successfully!\n\nFile: ${fileName}\nSheets: Summary, Sales Records, Customers, Purchase History`);

            } catch (error) {
                console.error('Error creating Excel backup:', error);
                showError(' Excel backup error: ' + error.message);
            }
        }

        // ======== USER-FRIENDLY ENHANCEMENTS ========

        // Initialize current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            const dateStr = now.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('current-time').textContent = `${timeStr}  ${dateStr}`;
        }

        // Quick Actions Functions
        function showLastSales() {
            showTab('recent-sales');
            // Force reload of sales records to show all data
            loadSalesRecords();
        }

        function showTodaysSummary() {
            const today = new Date().toISOString().split('T')[0];
            const todaysSales = salesData.filter(sale => sale.saleDate === today);

            const totalRevenue = todaysSales.reduce((sum, sale) => sum + sale.sellingPrice, 0);
            const totalProfit = todaysSales.reduce((sum, sale) => sum + sale.profit, 0);

            alert(` Today's Summary (${today})

Sales: ${todaysSales.length}
Revenue: ${totalRevenue.toFixed(2)}
Profit: ${totalProfit.toFixed(2)}
Profit Margin: ${totalRevenue > 0 ? ((totalProfit / totalRevenue) * 100).toFixed(1) + '%' : '0%'}`);
        }



        // Auto-save draft functionality
        let autoSaveTimeout;
        function autoSaveDraft() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const draftData = {
                    customerName: document.getElementById('customerName').value,
                    customerPhone: document.getElementById('customerPhone').value,
                    customerAddress: document.getElementById('customerAddress').value,
                    itemName: document.getElementById('itemName').value,
                    weight: document.getElementById('weight').value,
                    rate: document.getElementById('rate').value,
                    sellingPrice: document.getElementById('sellingPrice').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('salesDraft', JSON.stringify(draftData));
                showAutoSaveStatus();
            }, 2000);
        }

        function showAutoSaveStatus() {
            const status = document.getElementById('autosave-status');
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 2000);
        }

        function loadDraft() {
            const draft = localStorage.getItem('salesDraft');
            if (draft) {
                const data = JSON.parse(draft);
                const timeDiff = new Date() - new Date(data.timestamp);

                // Only load if draft is less than 1 hour old
                if (timeDiff < 3600000) {
                    if (confirm('Found a saved draft. Would you like to restore it?')) {
                        Object.keys(data).forEach(key => {
                            if (key !== 'timestamp') {
                                const element = document.getElementById(key);
                                if (element) element.value = data[key];
                            }
                        });
                    }
                }
            }
        }

        // Item Name Suggestions
        function showItemSuggestions(value) {
            if (value.length < 2) {
                document.getElementById('item-suggestions').style.display = 'none';
                return;
            }

            const suggestions = [...new Set(salesData.map(sale => sale.itemName))]
                .filter(item => item.toLowerCase().includes(value.toLowerCase()))
                .slice(0, 5);

            if (suggestions.length > 0) {
                const suggestionsHtml = suggestions.map(item =>
                    `<div class="search-suggestion" onclick="selectItemSuggestion('${item}')">${item}</div>`
                ).join('');

                document.getElementById('item-suggestions').innerHTML = suggestionsHtml;
                document.getElementById('item-suggestions').style.display = 'block';
            } else {
                document.getElementById('item-suggestions').style.display = 'none';
            }
        }

        function selectItemSuggestion(item) {
            document.getElementById('itemName').value = item;
            document.getElementById('item-suggestions').style.display = 'none';
            autoSaveDraft();
        }

        function handleItemKeydown(event) {
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                const firstSuggestion = document.querySelector('.search-suggestion');
                if (firstSuggestion) firstSuggestion.focus();
            }
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                // Ctrl/Cmd + shortcuts
                if (event.ctrlKey || event.metaKey) {
                    switch(event.key) {
                        case 'n':
                            event.preventDefault();
                            showTab('sales');
                            break;
                        case 'r':
                            event.preventDefault();
                            showTab('recent-sales');
                            break;
                        case 's':
                            event.preventDefault();
                            if (document.getElementById('sales').classList.contains('active')) {
                                addSale();
                            }
                            break;
                        case '/':
                            event.preventDefault();
                            toggleShortcutsHelp();
                            break;
                    }
                }

                // F-key shortcuts
                if (event.key === 'F1') {
                    event.preventDefault();
                    toggleShortcutsHelp();
                }
            });
        }

        function toggleShortcutsHelp() {
            const help = document.getElementById('shortcuts-help');
            help.style.display = help.style.display === 'none' ? 'block' : 'none';
        }

        // Enhanced form validation
        function validateForm() {
            const requiredFields = ['customerName', 'customerPhone', 'itemName', 'sellingPrice'];
            let isValid = true;

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const value = field.value.trim();

                if (!value) {
                    field.classList.add('error');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                    field.classList.add('success');
                }
            });

            return isValid;
        }

        // ======== ADVANCED ANALYTICS FUNCTIONS ========

        // Update Analytics Dashboard
        function updateAnalytics() {
            const period = document.getElementById('analytics-period').value;
            const startDate = document.getElementById('analytics-start-date').value;
            const endDate = document.getElementById('analytics-end-date').value;

            const filteredData = filterSalesData(period, startDate, endDate);
            updateMetricCards(filteredData);
            updateCharts(filteredData);
            updateTopProducts(filteredData);
            updateCustomerInsights(filteredData);
        }

        function filterSalesData(period, startDate, endDate) {
            let filtered = salesData;

            if (startDate && endDate) {
                filtered = salesData.filter(sale => {
                    const saleDate = new Date(sale.saleDate);
                    return saleDate >= new Date(startDate) && saleDate <= new Date(endDate);
                });
            } else if (period !== 'all') {
                const days = parseInt(period);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);

                filtered = salesData.filter(sale => new Date(sale.saleDate) >= cutoffDate);
            }

            return filtered;
        }

        function updateMetricCards(data) {
            const totalRevenue = data.reduce((sum, sale) => sum + sale.sellingPrice, 0);
            const totalProfit = data.reduce((sum, sale) => sum + sale.profit, 0);
            const totalSales = data.length;
            const avgOrderValue = totalSales > 0 ? totalRevenue / totalSales : 0;

            document.getElementById('total-revenue').textContent = `${totalRevenue.toFixed(0)}`;
            document.getElementById('total-profit').textContent = `${totalProfit.toFixed(0)}`;
            document.getElementById('total-sales').textContent = totalSales;
            document.getElementById('avg-order-value').textContent = `${avgOrderValue.toFixed(0)}`;

            // Calculate growth (simplified)
            const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            document.getElementById('revenue-growth').textContent = `Profit Margin: ${profitMargin.toFixed(1)}%`;
        }

        function updateCharts(data) {
            updateSalesTrendChart(data);
            updateCategoryChart(data);
        }

        function updateSalesTrendChart(data) {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');

            // Group data by date
            const dailyData = {};
            data.forEach(sale => {
                const date = sale.saleDate;
                if (!dailyData[date]) {
                    dailyData[date] = { revenue: 0, count: 0 };
                }
                dailyData[date].revenue += sale.sellingPrice;
                dailyData[date].count += 1;
            });

            const dates = Object.keys(dailyData).sort();
            const revenues = dates.map(date => dailyData[date].revenue);

            if (window.salesTrendChart) {
                window.salesTrendChart.destroy();
            }

            window.salesTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Daily Revenue',
                        data: revenues,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Sales Trend Over Time' }
                    }
                }
            });
        }

        function updateCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');

            // Group data by category
            const categoryData = {};
            data.forEach(sale => {
                const category = sale.category;
                if (!categoryData[category]) {
                    categoryData[category] = 0;
                }
                categoryData[category] += sale.sellingPrice;
            });

            const categories = Object.keys(categoryData);
            const revenues = Object.values(categoryData);

            if (window.categoryChart) {
                window.categoryChart.destroy();
            }

            window.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: revenues,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#4ecdc4', '#44a08d',
                            '#f093fb', '#f5576c', '#ffecd2', '#fcb69f'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Category Revenue Distribution' }
                    }
                }
            });
        }

        function updateTopProducts(data) {
            const productData = {};
            data.forEach(sale => {
                const product = sale.itemName;
                if (!productData[product]) {
                    productData[product] = { count: 0, revenue: 0 };
                }
                productData[product].count += 1;
                productData[product].revenue += sale.sellingPrice;
            });

            const topProducts = Object.entries(productData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);

            const html = topProducts.map((product, index) => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                    <div>
                        <strong>${index + 1}. ${product[0]}</strong>
                        <div style="font-size: 12px; color: #666;">${product[1].count} sales</div>
                    </div>
                    <div style="text-align: right;">
                        <strong>${product[1].revenue.toFixed(0)}</strong>
                    </div>
                </div>
            `).join('');

            document.getElementById('top-products-list').innerHTML = html || '<p>No products found</p>';
        }

        function updateCustomerInsights(data) {
            const customerData = {};
            data.forEach(sale => {
                const customer = sale.customerName;
                if (!customerData[customer]) {
                    customerData[customer] = { count: 0, revenue: 0 };
                }
                customerData[customer].count += 1;
                customerData[customer].revenue += sale.sellingPrice;
            });

            const topCustomers = Object.entries(customerData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);

            const html = topCustomers.map((customer, index) => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                    <div>
                        <strong>${index + 1}. ${customer[0]}</strong>
                        <div style="font-size: 12px; color: #666;">${customer[1].count} purchases</div>
                    </div>
                    <div style="text-align: right;">
                        <strong>${customer[1].revenue.toFixed(0)}</strong>
                    </div>
                </div>
            `).join('');

            document.getElementById('customer-insights-list').innerHTML = html || '<p>No customers found</p>';
        }

        // Advanced Search & Filters
        function applyAdvancedFilters() {
            const searchTerm = document.getElementById('advanced-search').value.toLowerCase();
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const category = document.getElementById('filter-category').value;
            const priceRange = document.getElementById('filter-price-range').value;
            const sortBy = document.getElementById('filter-sort').value;

            let filtered = salesData;

            // Apply filters
            if (searchTerm) {
                filtered = filtered.filter(sale =>
                    sale.customerName.toLowerCase().includes(searchTerm) ||
                    sale.itemName.toLowerCase().includes(searchTerm) ||
                    sale.category.toLowerCase().includes(searchTerm)
                );
            }

            if (startDate && endDate) {
                filtered = filtered.filter(sale => {
                    const saleDate = new Date(sale.saleDate);
                    return saleDate >= new Date(startDate) && saleDate <= new Date(endDate);
                });
            }

            if (category) {
                filtered = filtered.filter(sale => sale.category === category);
            }

            if (priceRange) {
                const [min, max] = priceRange.split('-').map(p => p.replace('+', ''));
                filtered = filtered.filter(sale => {
                    const price = sale.sellingPrice;
                    if (priceRange.includes('+')) {
                        return price >= parseInt(min);
                    } else {
                        return price >= parseInt(min) && price <= parseInt(max);
                    }
                });
            }

            // Apply sorting
            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc': return new Date(b.saleDate) - new Date(a.saleDate);
                    case 'date-asc': return new Date(a.saleDate) - new Date(b.saleDate);
                    case 'price-desc': return b.sellingPrice - a.sellingPrice;
                    case 'price-asc': return a.sellingPrice - b.sellingPrice;
                    case 'profit-desc': return b.profit - a.profit;
                    case 'profit-asc': return a.profit - b.profit;
                    default: return 0;
                }
            });

            displayFilteredResults(filtered);
        }

        function displayFilteredResults(data) {
            const html = data.map(sale => `
                <div style="padding: 15px; border-bottom: 1px solid #eee; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                    <div>
                        <strong>${sale.itemName}</strong>
                        <div style="font-size: 12px; color: #666;">${sale.customerName}</div>
                    </div>
                    <div>${sale.category}</div>
                    <div>${sale.sellingPrice.toFixed(0)}</div>
                    <div>${sale.saleDate}</div>
                </div>
            `).join('');

            document.getElementById('filtered-results-content').innerHTML = html || '<p>No results found</p>';
            document.getElementById('filtered-results').style.display = 'block';
            document.getElementById('results-count').textContent = `${data.length} results found`;
        }

        function clearAdvancedFilters() {
            document.getElementById('advanced-search').value = '';
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-price-range').value = '';
            document.getElementById('filter-sort').value = 'date-desc';
            document.getElementById('filtered-results').style.display = 'none';
        }

        // ======== EXPORT & DOWNLOAD FUNCTIONS ========

        function downloadReport() {
            const reportType = document.getElementById('report-type').value;
            const customerFilter = document.getElementById('customer-filter').value;
            const dateRange = document.getElementById('export-date-range').value;
            const format = document.getElementById('export-format').value;

            let data = [];
            let filename = '';

            // Filter data based on date range
            const filteredData = getFilteredDataByDateRange(salesData, dateRange);

            // Generate report based on type
            switch (reportType) {
                case 'sales':
                    data = generateSalesReport(filteredData, customerFilter);
                    filename = `Sales_Report_${new Date().toISOString().split('T')[0]}`;
                    break;
                case 'customers':
                    data = generateCustomerReport(filteredData, customerFilter);
                    filename = `Customer_Report_${new Date().toISOString().split('T')[0]}`;
                    break;
                case 'products':
                    data = generateProductReport(filteredData);
                    filename = `Product_Report_${new Date().toISOString().split('T')[0]}`;
                    break;
                case 'analytics':
                    data = generateAnalyticsReport(filteredData);
                    filename = `Analytics_Report_${new Date().toISOString().split('T')[0]}`;
                    break;
            }

            // Export based on format
            if (format === 'excel') {
                exportToExcel(data, filename);
            } else if (format === 'csv') {
                exportToCSV(data, filename);
            } else if (format === 'pdf') {
                exportToPDF(data, filename);
            }
        }

        function getFilteredDataByDateRange(data, dateRange) {
            const today = new Date();
            let startDate, endDate;

            switch (dateRange) {
                case 'today':
                    startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                    break;
                case 'week':
                    startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
                    endDate = today;
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'quarter':
                    const quarterStart = Math.floor(today.getMonth() / 3) * 3;
                    startDate = new Date(today.getFullYear(), quarterStart, 1);
                    endDate = new Date(today.getFullYear(), quarterStart + 3, 0);
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                case 'custom':
                    startDate = new Date(document.getElementById('export-start-date').value);
                    endDate = new Date(document.getElementById('export-end-date').value);
                    break;
                default:
                    return data;
            }

            return data.filter(sale => {
                const saleDate = new Date(sale.saleDate);
                return saleDate >= startDate && saleDate <= endDate;
            });
        }

        function generateSalesReport(data, customerFilter) {
            let filteredData = data;

            // Apply customer filter
            if (customerFilter) {
                if (customerFilter === 'top-customers') {
                    const customerTotals = {};
                    data.forEach(sale => {
                        if (!customerTotals[sale.customerName]) {
                            customerTotals[sale.customerName] = 0;
                        }
                        customerTotals[sale.customerName] += sale.sellingPrice;
                    });
                    const topCustomers = Object.entries(customerTotals)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10)
                        .map(([name]) => name);
                    filteredData = data.filter(sale => topCustomers.includes(sale.customerName));
                } else if (customerFilter === 'new-customers') {
                    const customerFirstPurchase = {};
                    data.forEach(sale => {
                        if (!customerFirstPurchase[sale.customerName]) {
                            customerFirstPurchase[sale.customerName] = sale.saleDate;
                        }
                    });
                    const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    const newCustomers = Object.entries(customerFirstPurchase)
                        .filter(([name, date]) => new Date(date) >= last30Days)
                        .map(([name]) => name);
                    filteredData = data.filter(sale => newCustomers.includes(sale.customerName));
                }
            }

            return filteredData.map(sale => ({
                'Sale Date': sale.saleDate,
                'Customer Name': sale.customerName,
                'Customer Phone': sale.customerPhone,
                'Customer Address': sale.customerAddress,
                'Item Name': sale.itemName,
                'Category': sale.category,
                'Weight (grams)': sale.weight,
                'Gold Rate': sale.goldRate,
                'Making Charges': sale.makingCharges,
                'Stone Price': sale.stonePrice,
                'GST Amount': sale.gstAmount,
                'Total Cost': sale.totalCost,
                'Selling Price': sale.sellingPrice,
                'Profit': sale.profit,
                'Profit Margin (%)': ((sale.profit / sale.sellingPrice) * 100).toFixed(2)
            }));
        }

        function generateCustomerReport(data, customerFilter) {
            const customerStats = {};

            data.forEach(sale => {
                const customer = sale.customerName;
                if (!customerStats[customer]) {
                    customerStats[customer] = {
                        name: customer,
                        phone: sale.customerPhone,
                        address: sale.customerAddress,
                        totalPurchases: 0,
                        totalSpent: 0,
                        totalProfit: 0,
                        avgOrderValue: 0,
                        firstPurchase: sale.saleDate,
                        lastPurchase: sale.saleDate,
                        favoriteCategory: {}
                    };
                }

                const stats = customerStats[customer];
                stats.totalPurchases++;
                stats.totalSpent += sale.sellingPrice;
                stats.totalProfit += sale.profit;

                if (sale.saleDate < stats.firstPurchase) stats.firstPurchase = sale.saleDate;
                if (sale.saleDate > stats.lastPurchase) stats.lastPurchase = sale.saleDate;

                if (!stats.favoriteCategory[sale.category]) {
                    stats.favoriteCategory[sale.category] = 0;
                }
                stats.favoriteCategory[sale.category]++;
            });

            // Calculate averages and find favorite category
            Object.values(customerStats).forEach(stats => {
                stats.avgOrderValue = stats.totalSpent / stats.totalPurchases;

                let maxCategory = '';
                let maxCount = 0;
                Object.entries(stats.favoriteCategory).forEach(([category, count]) => {
                    if (count > maxCount) {
                        maxCount = count;
                        maxCategory = category;
                    }
                });
                stats.favoriteCategory = maxCategory;
            });

            let reportData = Object.values(customerStats);

            // Apply customer filter
            if (customerFilter === 'top-customers') {
                reportData = reportData.sort((a, b) => b.totalSpent - a.totalSpent).slice(0, 10);
            } else if (customerFilter === 'new-customers') {
                const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                reportData = reportData.filter(customer => new Date(customer.firstPurchase) >= last30Days);
            } else if (customerFilter === 'returning-customers') {
                reportData = reportData.filter(customer => customer.totalPurchases > 1);
            }

            return reportData.map(customer => ({
                'Customer Name': customer.name,
                'Phone': customer.phone,
                'Address': customer.address,
                'Total Purchases': customer.totalPurchases,
                'Total Spent ()': customer.totalSpent.toFixed(2),
                'Total Profit Generated ()': customer.totalProfit.toFixed(2),
                'Average Order Value ()': customer.avgOrderValue.toFixed(2),
                'First Purchase': customer.firstPurchase,
                'Last Purchase': customer.lastPurchase,
                'Favorite Category': customer.favoriteCategory,
                'Customer Status': customer.totalPurchases > 5 ? 'VIP' : customer.totalPurchases > 2 ? 'Regular' : 'New'
            }));
        }

        function generateProductReport(data) {
            const productStats = {};

            data.forEach(sale => {
                const product = sale.itemName;
                if (!productStats[product]) {
                    productStats[product] = {
                        name: product,
                        category: sale.category,
                        totalSales: 0,
                        totalRevenue: 0,
                        totalProfit: 0,
                        avgSellingPrice: 0,
                        avgProfit: 0,
                        profitMargin: 0
                    };
                }

                const stats = productStats[product];
                stats.totalSales++;
                stats.totalRevenue += sale.sellingPrice;
                stats.totalProfit += sale.profit;
            });

            Object.values(productStats).forEach(stats => {
                stats.avgSellingPrice = stats.totalRevenue / stats.totalSales;
                stats.avgProfit = stats.totalProfit / stats.totalSales;
                stats.profitMargin = (stats.totalProfit / stats.totalRevenue) * 100;
            });

            return Object.values(productStats)
                .sort((a, b) => b.totalRevenue - a.totalRevenue)
                .map(product => ({
                    'Product Name': product.name,
                    'Category': product.category,
                    'Total Sales': product.totalSales,
                    'Total Revenue ()': product.totalRevenue.toFixed(2),
                    'Total Profit ()': product.totalProfit.toFixed(2),
                    'Average Selling Price ()': product.avgSellingPrice.toFixed(2),
                    'Average Profit ()': product.avgProfit.toFixed(2),
                    'Profit Margin (%)': product.profitMargin.toFixed(2),
                    'Performance': product.profitMargin > 20 ? 'Excellent' : product.profitMargin > 10 ? 'Good' : 'Poor'
                }));
        }

        function generateAnalyticsReport(data) {
            const totalSales = data.length;
            const totalRevenue = data.reduce((sum, sale) => sum + sale.sellingPrice, 0);
            const totalProfit = data.reduce((sum, sale) => sum + sale.profit, 0);
            const avgOrderValue = totalRevenue / totalSales;
            const profitMargin = (totalProfit / totalRevenue) * 100;

            // Category analysis
            const categoryStats = {};
            data.forEach(sale => {
                if (!categoryStats[sale.category]) {
                    categoryStats[sale.category] = { sales: 0, revenue: 0, profit: 0 };
                }
                categoryStats[sale.category].sales++;
                categoryStats[sale.category].revenue += sale.sellingPrice;
                categoryStats[sale.category].profit += sale.profit;
            });

            // Customer analysis
            const customerStats = {};
            data.forEach(sale => {
                if (!customerStats[sale.customerName]) {
                    customerStats[sale.customerName] = { purchases: 0, spent: 0 };
                }
                customerStats[sale.customerName].purchases++;
                customerStats[sale.customerName].spent += sale.sellingPrice;
            });

            const topCustomer = Object.entries(customerStats)
                .sort((a, b) => b[1].spent - a[1].spent)[0];

            const topCategory = Object.entries(categoryStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)[0];

            return [{
                'Analysis Date': new Date().toISOString().split('T')[0],
                'Total Sales': totalSales,
                'Total Revenue ()': totalRevenue.toFixed(2),
                'Total Profit ()': totalProfit.toFixed(2),
                'Average Order Value ()': avgOrderValue.toFixed(2),
                'Profit Margin (%)': profitMargin.toFixed(2),
                'Top Customer': topCustomer ? topCustomer[0] : 'N/A',
                'Top Customer Spending ()': topCustomer ? topCustomer[1].spent.toFixed(2) : '0',
                'Top Category': topCategory ? topCategory[0] : 'N/A',
                'Top Category Revenue ()': topCategory ? topCategory[1].revenue.toFixed(2) : '0',
                'Performance Status': profitMargin > 20 ? 'Excellent' : profitMargin > 10 ? 'Good' : 'Needs Improvement'
            }];
        }

        function exportToExcel(data, filename) {
            try {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Report');
                XLSX.writeFile(wb, `${filename}.xlsx`);
                alert(` Excel report downloaded successfully: ${filename}.xlsx`);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        function exportToCSV(data, filename) {
            try {
                const ws = XLSX.utils.json_to_sheet(data);
                const csv = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${filename}.csv`;
                link.click();
                alert(` CSV report downloaded successfully: ${filename}.csv`);
            } catch (error) {
                console.error('Error exporting to CSV:', error);
                alert('Error exporting to CSV: ' + error.message);
            }
        }

        function exportToPDF(data, filename) {
            // Simple PDF export using print functionality
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Report</title>');
            printWindow.document.write('<style>table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #f2f2f2; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>Sales Report</h1>');

            if (data.length > 0) {
                printWindow.document.write('<table>');
                printWindow.document.write('<tr>');
                Object.keys(data[0]).forEach(key => {
                    printWindow.document.write(`<th>${key}</th>`);
                });
                printWindow.document.write('</tr>');

                data.forEach(row => {
                    printWindow.document.write('<tr>');
                    Object.values(row).forEach(value => {
                        printWindow.document.write(`<td>${value}</td>`);
                    });
                    printWindow.document.write('</tr>');
                });
                printWindow.document.write('</table>');
            }

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
            alert(` PDF report prepared for printing: ${filename}.pdf`);
        }

        function previewReport() {
            try {
                const reportType = document.getElementById('report-type').value;
                const customerFilter = document.getElementById('customer-filter').value;
                const dateRange = document.getElementById('export-date-range').value;

                console.log('Preview Report - Report Type:', reportType);
                console.log('Preview Report - Sales Data Length:', salesData.length);

                if (salesData.length === 0) {
                    document.getElementById('filtered-results-content').innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h4>No Sales Data Available</h4><p>Please add some sales records first to generate reports.</p></div>';
                    document.getElementById('filtered-results').style.display = 'block';
                    document.getElementById('results-count').textContent = '0 records found';
                    return;
                }

                const filteredData = getFilteredDataByDateRange(salesData, dateRange);
                let data = [];

                switch (reportType) {
                    case 'sales':
                        data = generateSalesReport(filteredData, customerFilter);
                    break;
                case 'customers':
                        data = generateCustomerReport(filteredData, customerFilter);
                            break;
                        case 'products':
                        data = generateProductReport(filteredData);
                        break;
                    case 'analytics':
                        data = generateAnalyticsReport(filteredData);
                        break;
                    default:
                        data = generateSalesReport(filteredData, customerFilter);
                }

                console.log('Generated data length:', data.length);

                if (data.length === 0) {
                    document.getElementById('filtered-results-content').innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h4>No Data Found</h4><p>No records match the selected filters and date range.</p></div>';
                    document.getElementById('filtered-results').style.display = 'block';
                    document.getElementById('results-count').textContent = '0 records found';
                    return;
                }

                // Show preview in filtered results
                const previewHtml = `
                    <h4 style="color: #333; margin-bottom: 15px;"> Report Preview (${reportType.toUpperCase()}) - ${data.length} records</h4>
                    <div style="overflow-x: auto; max-height: 400px; border: 1px solid #ddd; border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #f8f9fa; position: sticky; top: 0;">
                                    ${Object.keys(data[0] || {}).map(key => `<th style="border: 1px solid #ddd; padding: 8px; text-align: left; font-weight: 600; color: #333;">${key}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.slice(0, 50).map((row, index) => `
                                    <tr style="background-color: ${index % 2 === 0 ? '#fff' : '#f9f9f9'};">
                                        ${Object.values(row).map(value => `<td style="border: 1px solid #ddd; padding: 8px;">${value || 'N/A'}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${data.length > 50 ? `<p style="margin-top: 10px; color: #666; font-style: italic;"><em>Showing first 50 records. Total: ${data.length} records</em></p>` : ''}
                `;

                document.getElementById('filtered-results-content').innerHTML = previewHtml;
                document.getElementById('filtered-results').style.display = 'block';
                document.getElementById('results-count').textContent = `${data.length} records found`;

                showSuccess(`Report preview generated successfully! ${data.length} records found.`);

            } catch (error) {
                console.error('Error in previewReport:', error);
                document.getElementById('filtered-results-content').innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;"><h4>Error Generating Preview</h4><p>${error.message}</p></div>`;
                document.getElementById('filtered-results').style.display = 'block';
                document.getElementById('results-count').textContent = 'Error';
                showError('Error generating report preview: ' + error.message);
            }
        }

        function emailReport() {
            alert(' Email functionality would be implemented with a backend service. For now, please download the report and send it manually.');
        }

        function scheduleReport() {
            alert(' Schedule functionality would be implemented with a backend service. For now, please download reports manually as needed.');
        }

        function exportFilteredResults() {
            const content = document.getElementById('filtered-results-content');
            if (!content || content.innerHTML.includes('No results found')) {
                alert('No results to export. Please run a filter or preview first.');
                return;
            }

            // Get the current filtered data and export it
            const format = document.getElementById('export-format').value;
            const filename = `Filtered_Results_${new Date().toISOString().split('T')[0]}`;

            // This would need to be implemented based on the current filtered data
            alert(`Exporting filtered results as ${format.toUpperCase()}...`);
        }

        // Handle custom date range visibility
        document.getElementById('export-date-range').addEventListener('change', function() {
            const customDateRange = document.getElementById('custom-date-range');
            if (this.value === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
        });

        // ======== BUSINESS INTELLIGENCE FUNCTIONS ========

        function generateBusinessIntelligence() {
            generateSalesForecast();
            generateCustomerLifetimeValue();
            generateSeasonalAnalysis();
            generateProfitOptimization();
            generateAIInsights();
        }

        function generateSalesForecast() {
            // Simple linear regression for forecasting
            const last30Days = salesData.slice(-30);
            const dailyTotals = {};

            last30Days.forEach(sale => {
                const date = sale.saleDate;
                if (!dailyTotals[date]) dailyTotals[date] = 0;
                dailyTotals[date] += sale.sellingPrice;
            });

            const values = Object.values(dailyTotals);
            const avgDaily = values.reduce((a, b) => a + b, 0) / values.length;

            document.getElementById('forecast-7days').textContent = `${(avgDaily * 7).toFixed(0)}`;
            document.getElementById('forecast-30days').textContent = `${(avgDaily * 30).toFixed(0)}`;
            document.getElementById('forecast-confidence').textContent = '85%';
            document.getElementById('forecast-trend').textContent = 'Increasing';
        }

        function generateCustomerLifetimeValue() {
            const customerData = {};
            salesData.forEach(sale => {
                const customer = sale.customerName;
                if (!customerData[customer]) {
                    customerData[customer] = { totalSpent: 0, purchases: 0, firstPurchase: sale.saleDate };
                }
                customerData[customer].totalSpent += sale.sellingPrice;
                customerData[customer].purchases += 1;
            });

            const clvData = Object.entries(customerData)
                .map(([name, data]) => ({
                    name,
                    clv: data.totalSpent,
                    purchases: data.purchases,
                    avgOrder: data.totalSpent / data.purchases
                }))
                .sort((a, b) => b.clv - a.clv)
                .slice(0, 10);

            const html = clvData.map(customer => `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <strong>${customer.name}</strong>
                    <div>Lifetime Value: ${customer.clv.toFixed(0)}</div>
                    <div>Purchases: ${customer.purchases}</div>
                    <div>Avg Order: ${customer.avgOrder.toFixed(0)}</div>
                </div>
            `).join('');

            document.getElementById('clv-analysis').innerHTML = html;
        }

        function generateAIInsights() {
            try {
                console.log(' Generating AI Insights...');
                console.log(' Sales data available:', salesData ? salesData.length : 'undefined');

                // Check if we have sales data
                if (!salesData || salesData.length === 0) {
                    const noDataMessage = 'No sales data available. Add some sales records to generate insights.';
                    document.getElementById('sales-forecast').textContent = noDataMessage;
                    document.getElementById('customer-behavior').textContent = noDataMessage;
                    console.log(' No sales data available for insights');
                    document.getElementById('product-trends').textContent = noDataMessage;
                    return;
                }

                // Calculate dynamic insights based on actual data
                console.log(' Calculating insights from', salesData.length, 'sales records');
                const insights = calculateDynamicInsights();

                // Update the DOM elements
                const salesForecastElement = document.getElementById('sales-forecast');
                const customerBehaviorElement = document.getElementById('customer-behavior');
                const productTrendsElement = document.getElementById('product-trends');

                if (salesForecastElement) {
                    salesForecastElement.textContent = insights.salesForecast;
                } else {
                    console.error(' sales-forecast element not found');
                }

                if (customerBehaviorElement) {
                    customerBehaviorElement.textContent = insights.customerBehavior;
                } else {
                    console.error(' customer-behavior element not found');
                }

                if (productTrendsElement) {
                    productTrendsElement.textContent = insights.productTrends;
                } else {
                    console.error(' product-trends element not found');
                }

                console.log(' AI Insights generated successfully:', insights);
            } catch (error) {
                console.error(' Error generating AI insights:', error);
                console.error('Error stack:', error.stack);
                const errorMessage = 'Unable to generate insights. Please check the console for details.';

                try {
                    document.getElementById('sales-forecast').textContent = errorMessage;
                        document.getElementById('customer-behavior').textContent = errorMessage;
                document.getElementById('product-trends').textContent = errorMessage;
                } catch (domError) {
                    console.error(' Error updating DOM elements:', domError);
                }
            }
        }

        function calculateDynamicInsights() {
            // Sales Forecast Analysis
            const last30Days = salesData.slice(-30);
            const totalSales = last30Days.reduce((sum, sale) => sum + (sale.sellingPrice || 0), 0);
            const avgDailySales = totalSales / 30;
            const growthRate = calculateGrowthRate(last30Days);

            let salesForecast = `Based on last ${last30Days.length} days (${totalSales.toLocaleString()}), `;
            if (growthRate > 0) {
                salesForecast += `sales are trending up by ${growthRate.toFixed(1)}%. Expected growth next month.`;
            } else if (growthRate < 0) {
                salesForecast += `sales are down by ${Math.abs(growthRate).toFixed(1)}%. Consider promotional strategies.`;
            } else {
                salesForecast += `sales are stable. Maintain current strategies.`;
            }

            // Customer Behavior Analysis
            const customerPurchases = {};
            const dayOfWeekSales = {};

            salesData.forEach(sale => {
                // Customer analysis
                if (sale.customerName) {
                    customerPurchases[sale.customerName] = (customerPurchases[sale.customerName] || 0) + 1;
                }

                // Day of week analysis
                try {
                    const date = new Date(sale.saleDate);
                    if (!isNaN(date.getTime())) {
                        const dayOfWeek = date.getDay();
                        dayOfWeekSales[dayOfWeek] = (dayOfWeekSales[dayOfWeek] || 0) + (sale.sellingPrice || 0);
                    }
                } catch (e) {
                    console.warn('Invalid date format for sale:', sale.saleDate);
                }
            });

            const repeatCustomers = Object.values(customerPurchases).filter(count => count > 1).length;
            const totalCustomers = Object.keys(customerPurchases).length;

            let customerBehavior = `${repeatCustomers} repeat customers out of ${totalCustomers} total customers. `;

            if (Object.keys(dayOfWeekSales).length > 0) {
                const bestDay = Object.entries(dayOfWeekSales).reduce((a, b) =>
                    dayOfWeekSales[a[0]] > dayOfWeekSales[b[0]] ? a : b
                );
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                customerBehavior += `Best sales day: ${dayNames[bestDay[0]]} (${bestDay[1].toLocaleString()}).`;
            } else {
                customerBehavior += `No specific day pattern identified yet.`;
            }

            // Product Trends Analysis
            const categoryStats = {};
            const productStats = {};

            salesData.forEach(sale => {
                // Category analysis
                if (sale.category) {
                    if (!categoryStats[sale.category]) {
                        categoryStats[sale.category] = { count: 0, revenue: 0, profit: 0 };
                    }
                    categoryStats[sale.category].count++;
                    categoryStats[sale.category].revenue += (sale.sellingPrice || 0);
                    categoryStats[sale.category].profit += ((sale.sellingPrice || 0) - (sale.purchasePrice || 0));
                }

                // Product analysis
                if (sale.productName) {
                    if (!productStats[sale.productName]) {
                        productStats[sale.productName] = { count: 0, revenue: 0 };
                    }
                    productStats[sale.productName].count++;
                    productStats[sale.productName].revenue += (sale.sellingPrice || 0);
                }
            });

            let productTrends = '';

            if (Object.keys(categoryStats).length > 0) {
                const topCategory = Object.entries(categoryStats).reduce((a, b) =>
                    categoryStats[a[0]].profit > categoryStats[b[0]].profit ? a : b
                );
                productTrends += `Top category: ${topCategory[0]} (${topCategory[1].profit.toLocaleString()} profit). `;
            }

            if (Object.keys(productStats).length > 0) {
                const topProduct = Object.entries(productStats).reduce((a, b) =>
                    productStats[a[0]].revenue > productStats[b[0]].revenue ? a : b
                );
                productTrends += `Best seller: ${topProduct[0]} (${topProduct[1].revenue.toLocaleString()} revenue).`;
            }

            if (!productTrends) {
                productTrends = 'No product trends available yet. Add category and product information to sales records.';
            }

            return {
                salesForecast,
                customerBehavior,
                productTrends
            };
        }

        function calculateGrowthRate(salesData) {
            if (salesData.length < 10) return 0;

            const midPoint = Math.floor(salesData.length / 2);
            const firstHalf = salesData.slice(0, midPoint);
            const secondHalf = salesData.slice(-midPoint);

            const firstHalfTotal = firstHalf.reduce((sum, sale) => sum + (sale.sellingPrice || 0), 0);
            const secondHalfTotal = secondHalf.reduce((sum, sale) => sum + (sale.sellingPrice || 0), 0);

            if (firstHalfTotal === 0) return secondHalfTotal > 0 ? 100 : 0;
            return ((secondHalfTotal - firstHalfTotal) / firstHalfTotal) * 100;
        }

        // ======== INTEGRATION FUNCTIONS ========

        function testWhatsAppConnection() {
            const phone = document.getElementById('whatsapp-phone').value;
            if (phone) {
                alert(`Testing WhatsApp connection to ${phone}...`);
                // In real implementation, test API connection
                setTimeout(() => {
                    alert('WhatsApp connection successful!');
                }, 1000);
            } else {
                alert('Please enter a phone number');
            }
        }

        function sendSalesReceipt() {
            const phone = document.getElementById('whatsapp-phone').value;
            if (phone) {
                const message = `Thank you for your purchase! Your receipt will be sent to ${phone}`;
                alert(message);
                // In real implementation, send WhatsApp message
            } else {
                alert('Please configure WhatsApp phone number first');
            }
        }

        function sendEmailReceipt() {
            const email = document.getElementById('business-email').value;
            if (email) {
                alert(`Email receipt will be sent from ${email}`);
                // In real implementation, send email
            } else {
                alert('Please configure business email first');
            }
        }

        function sendSMSReceipt() {
            const apiKey = document.getElementById('sms-api-key').value;
            if (apiKey) {
                alert('SMS receipt will be sent');
                // In real implementation, send SMS
            } else {
                alert('Please configure SMS API key first');
            }
        }

        // ======== SECURITY FUNCTIONS ========

        let isAuthenticated = false;
        let userRole = 'admin';
        let auditLog = [];

        function authenticateUser() {
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;

            // Simple authentication (in real app, use proper auth)
            if (username === 'admin' && password === 'password') {
                isAuthenticated = true;
                document.getElementById('auth-status-text').textContent = 'Authenticated as Admin';
                document.getElementById('auth-status').innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <strong>Status:</strong> Authenticated as ${username}
                    </div>
                `;
                logAuditEvent('USER_LOGIN', `${username} logged in`);
                alert('Login successful!');
            } else {
                alert('Invalid credentials');
                logAuditEvent('LOGIN_FAILED', `Failed login attempt for ${username}`);
            }
        }

        function logAuditEvent(action, details) {
            const timestamp = new Date().toISOString();
            const entry = `[${timestamp}] ${action}: ${details}`;
            auditLog.push(entry);

            // Keep only last 100 entries
            if (auditLog.length > 100) {
                auditLog.shift();
            }
        }

        function viewAuditLogs() {
            const display = document.getElementById('audit-logs-display');
            display.innerHTML = `<div style="font-family: monospace; font-size: 12px; color: #666;">
                ${auditLog.slice(-20).join('<br>')}
            </div>`;
        }

        function exportAuditLogs() {
            const blob = new Blob([auditLog.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAuditLogs() {
            if (confirm('Are you sure you want to clear all audit logs?')) {
                auditLog = [];
                document.getElementById('audit-logs-display').innerHTML = '<p>Audit logs cleared</p>';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            initializeApp();
            registerServiceWorker();
            setupPWA();
            loadSettings(); // Load saved settings

            // Initialize database
            initializeDatabase();

            // Load existing data from database
            await loadFromDatabase();

            // Initialize category dropdown with a small delay to ensure DOM is ready
            setTimeout(initializeCategoryDropdown, 100);

            // Initialize new features
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000); // Update every minute
            setupKeyboardShortcuts();
            loadDraft();

            // Initialize advanced features after data is loaded
            setTimeout(() => {
                updateAnalytics();
                generateBusinessIntelligence();
                populateFilterCategories();
            }, 500);

            // Add event listeners for auto-save
            const formInputs = document.querySelectorAll('#sales input, #sales select, #sales textarea');
            formInputs.forEach(input => {
                input.addEventListener('input', () => {
                    autoSaveDraft();
                });
            });
        });

        // Helper function to populate filter categories
        function populateFilterCategories() {
            const categories = [...new Set(salesData.map(sale => sale.category))];
            const select = document.getElementById('filter-category');
            select.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                select.innerHTML += `<option value="${category}">${category}</option>`;
            });
        }

        function refreshAnalytics() {
            updateAnalytics();
            generateBusinessIntelligence();
            showSuccess('Analytics refreshed successfully!');
        }

        function saveFilterPreset() {
            const filters = {
                searchTerm: document.getElementById('advanced-search').value,
                startDate: document.getElementById('filter-start-date').value,
                endDate: document.getElementById('filter-end-date').value,
                category: document.getElementById('filter-category').value,
                priceRange: document.getElementById('filter-price-range').value,
                sortBy: document.getElementById('filter-sort').value
            };

            localStorage.setItem('savedFilterPreset', JSON.stringify(filters));
            showSuccess('Filter preset saved successfully!');
        }

        // Additional integration functions
        function sendPaymentReminder() {
            alert('Payment reminder sent via WhatsApp');
        }

        function sendBulkEmails() {
            alert('Bulk emails sent to all customers');
        }

        function sendSMSReminder() {
            alert('SMS reminder sent to customer');
        }

        function toggleTwoFactorAuth() {
            const enabled = document.getElementById('two-factor-auth').checked;
            alert(`Two-factor authentication ${enabled ? 'enabled' : 'disabled'}`);
        }

        function toggleSessionTimeout() {
            const enabled = document.getElementById('session-timeout').checked;
            alert(`Session timeout ${enabled ? 'enabled' : 'disabled'}`);
        }

        function toggleAuditTrail() {
            const enabled = document.getElementById('audit-trail').checked;
            alert(`Audit trail ${enabled ? 'enabled' : 'disabled'}`);
        }

        // Register Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then((registration) => {
                            console.log('SW registered: ', registration);

                            // Check for updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showUpdateAvailable();
                                    }
                                });
                            });
                        })
                        .catch((registrationError) => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }
        }

        // Setup PWA Features
        function setupPWA() {
            // Create install button
            createInstallButton();

            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('PWA: beforeinstallprompt event fired');
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();
            });

            // Listen for app installed event
            window.addEventListener('appinstalled', () => {
                console.log('PWA: App was installed');
                hideInstallButton();
                showSuccess(' App installed successfully! You can now access Theia Jewelz from your home screen.');
            });

            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                console.log('PWA: App is running in standalone mode');
                hideInstallButton();
            }
        }

        // Create Install Button
        function createInstallButton() {
            installBtn = document.createElement('button');
            installBtn.id = 'install-btn';
            installBtn.innerHTML = ' Install App';
            installBtn.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                background: #28a745;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
                display: none;
            `;

            installBtn.addEventListener('mouseenter', () => {
                installBtn.style.transform = 'translateY(-2px)';
                installBtn.style.boxShadow = '0 6px 12px rgba(0,0,0,0.3)';
            });

            installBtn.addEventListener('mouseleave', () => {
                installBtn.style.transform = 'translateY(0)';
                installBtn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            });

            installBtn.addEventListener('click', installApp);
            document.body.appendChild(installBtn);
        }

        // Show Install Button
        function showInstallButton() {
            if (installBtn) {
                installBtn.style.display = 'block';
                setTimeout(() => {
                    installBtn.style.opacity = '1';
                    installBtn.style.transform = 'scale(1)';
                }, 100);
            }
        }

        // Hide Install Button
        function hideInstallButton() {
            if (installBtn) {
                installBtn.style.display = 'none';
            }
        }

        // Install App
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA: User accepted the install prompt');
                    } else {
                        console.log('PWA: User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Show Update Available
        function showUpdateAvailable() {
            const updateDiv = document.createElement('div');
            updateDiv.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #007bff;
                color: white;
                padding: 15px 25px;
                border-radius: 25px;
                z-index: 1001;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                animation: slideUp 0.3s ease;
            `;
            updateDiv.innerHTML = `
                <span> New version available! Click to update</span>
            `;

            updateDiv.addEventListener('click', () => {
                window.location.reload();
            });

            document.body.appendChild(updateDiv);

            setTimeout(() => {
                if (document.body.contains(updateDiv)) {
                    document.body.removeChild(updateDiv);
                }
            }, 5000);
        }

        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from {
                    transform: translateX(-50%) translateY(100px);
                    opacity: 0;
                }
                to {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
            }

            @media (max-width: 768px) {
                #install-btn {
                    top: 10px !important;
                    right: 10px !important;
                    font-size: 12px !important;
                    padding: 10px 16px !important;
                }
            }
        `;
        document.head.appendChild(style);

        function initializeApp() {
            try {
                // Load data from localStorage
                const savedData = localStorage.getItem('jewelrySales');
                if (savedData) {
                    const rawData = JSON.parse(savedData);
                    // Clean and validate existing data
                    salesData = cleanSalesData(rawData);

                    // Save cleaned data back
                    if (salesData.length !== rawData.length) {
                        localStorage.setItem('jewelrySales', JSON.stringify(salesData));
                    }
                } else {
                    salesData = [];
                }

                // Load customer data
                const savedCustomers = localStorage.getItem('jewelryCustomers');
                if (savedCustomers) {
                    customersData = JSON.parse(savedCustomers);
                } else {
                    customersData = [];
                }

                // Set today's date as default
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                document.getElementById('saleDate').value = dateString;

                // Load initial displays
                loadSalesRecords();
                updateDashboard();
                loadCustomers();
                updateCustomerCount();

                // Initialize collapsible sections
                initializeCollapsibleSections();

                // Initialize the default tab (sales tab is marked as active in HTML)
                // Make sure the sales tab is properly displayed
                setTimeout(() => {
                    const salesTab = document.getElementById('sales');
                    if (salesTab) {
                        salesTab.style.display = 'block';
                        salesTab.classList.add('active');
                    }

                    // Test if showTab function is available
                    if (typeof showTab === 'function') {
                        console.log(' showTab function is properly defined');
                    } else {
                        console.error(' showTab function not found!');
                    }

                    // No sample data - start with clean slate
                }, 100);



            } catch (error) {
                console.error('Error initializing app:', error);
                showError('Error loading saved data. Starting fresh.');

                // If there's an error, start fresh
                salesData = [];
                localStorage.removeItem('jewelrySales');

                // Try to load displays again
                try {
                    loadSalesRecords();
                    updateDashboard();
                    loadCustomers();
                } catch (e) {
                    console.error('Error in recovery mode:', e);
                }
            }
        }

        // Function to clean and validate sales data
        function cleanSalesData(rawData) {
            if (!Array.isArray(rawData)) {
                return [];
            }

            const cleanedData = [];

            rawData.forEach((sale, index) => {
                try {
                    // Check if sale has all required properties
                    if (!sale || typeof sale !== 'object') {
                        return;
                    }

                    // Validate and fix numeric fields
                    const costPrice = parseFloat(sale.costPrice) || 0;
                    const sellingPrice = parseFloat(sale.sellingPrice) || 0;
                    const profit = sellingPrice - costPrice;

                    // Validate required string fields
                    const itemName = sale.itemName || 'Unknown Item';
                    const category = sale.category || 'Uncategorized';
                    const customerName = sale.customerName || 'Unknown Customer';
                    const customerPhone = sale.customerPhone || 'Not provided';
                    const customerAddress = sale.customerAddress || 'Not provided';
                    const saleDate = sale.saleDate || new Date().toISOString().split('T')[0];
                    const id = sale.id || Date.now() + index;

                    // Create cleaned sale object
                    const cleanedSale = {
                        id: id,
                        itemName: itemName,
                        category: category,
                        costPrice: costPrice,
                        sellingPrice: sellingPrice,
                        profit: profit,
                        saleDate: saleDate,
                        customerName: customerName,
                        customerPhone: customerPhone,
                        customerAddress: customerAddress,
                        createdAt: sale.createdAt || new Date().toISOString()
                    };

                    cleanedData.push(cleanedSale);

                } catch (saleError) {
                    console.error('Error cleaning sale:', saleError);
                }
            });

            return cleanedData;
        }



        // Update customer count in search hint to include all unique customers
        function updateCustomerCount() {
            try {
                const countElement = document.getElementById('total-customers');
                if (countElement) {
                    const allUniqueCustomers = getUniqueCustomers();
                    countElement.textContent = allUniqueCustomers.length;
                }
            } catch (error) {
                console.error('Error updating customer count:', error);
            }
        }

        // Import customers from CSV/Excel file
        function importCustomers(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();

            if (fileName.endsWith('.csv')) {
                importCSVCustomers(file);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                importExcelCustomers(file);
            } else {
                showError('Please select a CSV or Excel file (.csv, .xlsx, .xls)');
                return;
            }

            // Reset file input
            event.target.value = '';
        }

        // Import customers from CSV
        function importCSVCustomers(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');

                    if (lines.length < 2) {
                        showError('CSV file appears to be empty or invalid');
                        return;
                    }

                    // Parse header row
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    const requiredHeaders = ['name', 'phone'];
                    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));

                    if (missingHeaders.length > 0) {
                        showError(`CSV must contain columns: ${requiredHeaders.join(', ')}. Missing: ${missingHeaders.join(', ')}`);
                        return;
                    }

                    // Find column indices
                    const nameIndex = headers.indexOf('name');
                    const phoneIndex = headers.indexOf('phone');
                    const addressIndex = headers.indexOf('address');
                    const emailIndex = headers.indexOf('email');

                    let importedCount = 0;
                    let skippedCount = 0;

                    // Process data rows
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const values = line.split(',').map(v => v.trim().replace(/"/g, ''));

                        if (values.length < headers.length) continue;

                        const customerName = values[nameIndex];
                        const customerPhone = values[phoneIndex] || '';
                        const customerAddress = addressIndex >= 0 ? values[addressIndex] || '' : '';
                        const customerEmail = emailIndex >= 0 ? values[emailIndex] || '' : '';

                        if (!customerName) {
                            skippedCount++;
                            continue;
                        }

                        // Check if customer already exists
                        const existingCustomer = customersData.find(c =>
                            c.name.toLowerCase() === customerName.toLowerCase() ||
                            (customerPhone && c.phone === customerPhone)
                        );

                        if (existingCustomer) {
                            skippedCount++;
                            continue;
                        }

                        // Add new customer
                        const newCustomer = {
                            id: Date.now() + Math.random(),
                            name: customerName,
                            phone: customerPhone,
                            address: customerAddress,
                            email: customerEmail,
                            createdAt: new Date().toISOString()
                        };

                        customersData.push(newCustomer);
                        importedCount++;
                    }

                    // Save to localStorage
                    localStorage.setItem('jewelryCustomers', JSON.stringify(customersData));

                    // Refresh displays
                    loadCustomers();
                    updateCustomerCount();

                    showSuccess(` Import completed! ${importedCount} customers imported, ${skippedCount} duplicates skipped.`);

                } catch (error) {
                    console.error('Error importing CSV:', error);
                    showError('Error importing CSV file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Import customers from Excel
        function importExcelCustomers(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        showError('Excel file appears to be empty');
                        return;
                    }

                    let importedCount = 0;
                    let skippedCount = 0;

                    jsonData.forEach(row => {
                        const customerName = row.Name || row.name || row.customer_name || row['Customer Name'];
                        const customerPhone = row.Phone || row.phone || row.mobile || row.Mobile || '';
                        const customerAddress = row.Address || row.address || '';
                        const customerEmail = row.Email || row.email || '';

                        if (!customerName) {
                            skippedCount++;
                            return;
                        }

                        // Check if customer already exists
                        const existingCustomer = customersData.find(c =>
                            c.name.toLowerCase() === customerName.toLowerCase() ||
                            (customerPhone && c.phone === customerPhone)
                        );

                        if (existingCustomer) {
                            skippedCount++;
                            return;
                        }

                        // Add new customer
                        const newCustomer = {
                            id: Date.now() + Math.random(),
                            name: customerName,
                            phone: customerPhone,
                            address: customerAddress,
                            email: customerEmail,
                            createdAt: new Date().toISOString()
                        };

                        customersData.push(newCustomer);
                        importedCount++;
                    });

                    // Save to localStorage
                    localStorage.setItem('jewelryCustomers', JSON.stringify(customersData));

                    // Refresh displays
                    loadCustomers();
                    updateCustomerCount();

                    showSuccess(` Import completed! ${importedCount} customers imported, ${skippedCount} duplicates skipped.`);

                } catch (error) {
                    console.error('Error importing Excel:', error);
                    showError('Error importing Excel file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Download customer import template
        function downloadCustomerTemplate() {
            const csvContent = [
                'name,phone,address,email',
                'Customer Name,+91-XXXXXXXXXX,Full Address City State,email@example.com'
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'customer_import_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showSuccess(' Customer import template downloaded! Use this format for importing customers.');
        }

        // Enhanced Customer Database Functionality
        let currentCustomerPage = 1;
        let customersPerPage = 25;
        let filteredCustomers = [];
        let isCustomerSearchActive = false;
        let currentCustomerSort = 'name-asc';

        function toggleCustomerStats() {
            const panel = document.getElementById('customer-stats-panel');
            const button = document.getElementById('customer-stats-toggle');

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.textContent = ' Hide Stats';
                updateCustomerStatistics();
            } else {
                panel.style.display = 'none';
                button.textContent = ' Stats';
            }
        }

        function updateCustomerStatistics() {
            const totalCustomers = customersData.length;
            const activeCustomers = customersData.filter(customer => {
                const purchases = salesData.filter(sale => sale.customerName === customer.name);
                return purchases.length > 0;
            }).length;

            const totalOrders = salesData.length;
            const avgOrdersPerCustomer = activeCustomers > 0 ? (totalOrders / activeCustomers).toFixed(1) : 0;

            const totalCLV = customersData.reduce((sum, customer) => {
                const customerSales = salesData.filter(sale => sale.customerName === customer.name);
                const customerSpending = customerSales.reduce((total, sale) => total + (sale.sellingPrice || 0), 0);
                return sum + customerSpending;
            }, 0);

            document.getElementById('stat-total-customers').textContent = totalCustomers;
            document.getElementById('stat-active-customers').textContent = activeCustomers;
            document.getElementById('stat-avg-orders').textContent = avgOrdersPerCustomer;
            document.getElementById('stat-total-clv').textContent = `${(totalCLV || 0).toFixed(2)}`;
        }

        function filterCustomerDatabase() {
            const searchTerm = document.getElementById('customer-database-search').value.trim().toLowerCase();

            if (searchTerm.length === 0) {
                isCustomerSearchActive = false;
                filteredCustomers = [];
                currentCustomerPage = 1;
                displayCustomerDatabase();
                return;
            }

            if (searchTerm.length < 2) {
                return;
            }

            filteredCustomers = customersData.filter(customer =>
                customer.name.toLowerCase().includes(searchTerm) ||
                (customer.phone && customer.phone.toLowerCase().includes(searchTerm)) ||
                (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                (customer.address && customer.address.toLowerCase().includes(searchTerm))
            );

            isCustomerSearchActive = true;
            currentCustomerPage = 1;
            displayCustomerDatabase();
        }

        function sortCustomerDatabase() {
            currentCustomerSort = document.getElementById('customer-sort-select').value;
            displayCustomerDatabase();
        }

        function clearCustomerDatabaseFilter() {
            document.getElementById('customer-database-search').value = '';
            document.getElementById('customer-sort-select').value = 'name-asc';
            isCustomerSearchActive = false;
            filteredCustomers = [];
            currentCustomerSort = 'name-asc';
            currentCustomerPage = 1;
            displayCustomerDatabase();
        }

        function changeCustomersPerPage() {
            customersPerPage = parseInt(document.getElementById('customers-per-page').value);
            currentCustomerPage = 1;
            displayCustomerDatabase();
        }

        function displayCustomerDatabase() {
            const dataToDisplay = isCustomerSearchActive ? filteredCustomers : customersData;
            const sortedData = sortCustomersData(dataToDisplay);

            const totalCustomers = sortedData.length;
            const startIndex = (currentCustomerPage - 1) * customersPerPage;
            const endIndex = Math.min(startIndex + customersPerPage, totalCustomers);
            const currentPageData = sortedData.slice(startIndex, endIndex);

            const container = document.getElementById('customers-list-container');
            const noCustomersMessage = document.getElementById('no-customers-message');

            if (totalCustomers === 0) {
                container.innerHTML = '';
                noCustomersMessage.style.display = 'block';
                updateCustomerPagination(0, 0, 0);
                return;
            }

            noCustomersMessage.style.display = 'none';

            // Create table format for customers
            container.innerHTML = `
                <div class="table-container" style="overflow-x: auto; border-radius: 8px; border: 1px solid #e9ecef; background: white;">
                    <table class="customer-table" style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 150px;"> Customer Name</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 120px;"> Phone</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 150px;"> Email</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 180px;"> Address</th>
                                <th style="padding: 12px 8px; text-align: center; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 80px;"> Status</th>
                                <th style="padding: 12px 8px; text-align: right; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 80px;"> Orders</th>
                                <th style="padding: 12px 8px; text-align: right; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 100px;"> Total Spent</th>
                                <th style="padding: 12px 8px; text-align: right; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 100px;"> Avg Order</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 100px;"> Last Purchase</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 100px;"> Added Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentPageData.map((customer, index) => createCustomerRowHTML(customer, index)).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Update pagination
            updateCustomerPagination(currentCustomerPage, Math.ceil(totalCustomers / customersPerPage), totalCustomers);

            // Update showing info
            document.getElementById('customers-showing').textContent = `${startIndex + 1}-${endIndex}`;
            document.getElementById('customers-total').textContent = totalCustomers;
        }

        function sortCustomersData(data) {
            const sortedData = [...data];

            switch (currentCustomerSort) {
                case 'name-asc':
                    return sortedData.sort((a, b) => a.name.localeCompare(b.name));
                case 'name-desc':
                    return sortedData.sort((a, b) => b.name.localeCompare(a.name));
                case 'purchases-desc':
                case 'purchases-asc':
                    return sortedData.sort((a, b) => {
                        const aPurchases = salesData.filter(sale => sale.customerName === a.name).length;
                        const bPurchases = salesData.filter(sale => sale.customerName === b.name).length;
                        return currentCustomerSort === 'purchases-desc' ? bPurchases - aPurchases : aPurchases - bPurchases;
                    });
                case 'spending-desc':
                case 'spending-asc':
                    return sortedData.sort((a, b) => {
                        const aSpending = salesData.filter(sale => sale.customerName === a.name).reduce((sum, sale) => sum + sale.sellingPrice, 0);
                        const bSpending = salesData.filter(sale => sale.customerName === b.name).reduce((sum, sale) => sum + sale.sellingPrice, 0);
                        return currentCustomerSort === 'spending-desc' ? bSpending - aSpending : aSpending - bSpending;
                    });
                case 'recent-desc':
                    return sortedData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                case 'recent-asc':
                    return sortedData.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                default:
                    return sortedData;
            }
        }

        function createCustomerRowHTML(customer, index) {
            const customerSales = salesData.filter(sale => sale.customerName === customer.name);
            const totalPurchases = customerSales.length;
            const totalSpent = customerSales.reduce((sum, sale) => sum + (sale.sellingPrice || 0), 0);
            const avgOrderValue = totalPurchases > 0 ? (totalSpent / totalPurchases) : 0;
            const lastPurchase = customerSales.length > 0 ?
                Math.max(...customerSales.map(sale => new Date(sale.saleDate).getTime())) : null;

            const isActive = totalPurchases > 0;
            const statusClass = isActive ? 'active' : 'inactive';
            const statusText = isActive ? 'Active' : 'Inactive';
            const statusColor = isActive ? '#4CAF50' : '#f44336';

            return `
                <tr style="border-bottom: 1px solid #f8f9fa; transition: all 0.2s ease; background: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'};"
                    onmouseover="this.style.background='#e3f2fd'"
                    onmouseout="this.style.background='${index % 2 === 0 ? '#ffffff' : '#f8f9fa'}'">
                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; font-weight: 500; color: #333; font-size: 13px;">
                        ${customer.name}
                    </td>
                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; color: #666; font-size: 12px;">
                        ${customer.phone || 'Not provided'}
                    </td>
                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; color: #666; font-size: 12px;">
                        ${customer.email || 'Not provided'}
                    </td>
                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; color: #666; font-size: 12px;">
                        ${customer.address || 'Not provided'}
                    </td>
                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; text-align: center; font-size: 12px;">
                        <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;">
                            ${statusText}
                        </span>
                    </td>
                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; text-align: right; color: #333; font-size: 12px; font-weight: 500;">
                        ${totalPurchases}
                    </td>
                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; text-align: right; color: #333; font-size: 12px; font-weight: 500;">
                        ${(totalSpent || 0).toFixed(2)}
                    </td>
                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; text-align: right; color: #333; font-size: 12px; font-weight: 500;">
                        ${(avgOrderValue || 0).toFixed(2)}
                    </td>
                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; color: #666; font-size: 12px;">
                        ${lastPurchase ? new Date(lastPurchase).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Never'}
                    </td>
                    <td style="padding: 12px 8px; color: #666; font-size: 12px;">
                        ${new Date(customer.createdAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}
                    </td>
                </tr>
            `;
        }

        function updateCustomerPagination(currentPage, totalPages, totalCustomers) {
            const prevBtn = document.getElementById('prev-customers-btn');
            const nextBtn = document.getElementById('next-customers-btn');
            const pageInfo = document.getElementById('customer-page-info');

            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;

            pageInfo.textContent = totalPages > 0 ? `Page ${currentPage} of ${totalPages}` : 'No pages';

            // Update button styles based on disabled state
            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
            nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
            prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
            nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
        }

        function previousCustomersPage() {
            if (currentCustomerPage > 1) {
                currentCustomerPage--;
                displayCustomerDatabase();
            }
        }

        function nextCustomersPage() {
            const dataToDisplay = isCustomerSearchActive ? filteredCustomers : customersData;
            const totalPages = Math.ceil(dataToDisplay.length / customersPerPage);

            if (currentCustomerPage < totalPages) {
                currentCustomerPage++;
                displayCustomerDatabase();
            }
        }

        // Import sales from CSV/Excel file
        function importSales(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();

            if (fileName.endsWith('.csv')) {
                importCSVSales(file);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                importExcelSales(file);
            } else {
                showError('Please select a CSV or Excel file (.csv, .xlsx, .xls)');
                return;
            }

            // Reset file input
            event.target.value = '';
        }

        // Import sales from CSV
        function importCSVSales(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');

                    if (lines.length < 2) {
                        showError('CSV file appears to be empty or invalid');
                        return;
                    }

                    // Parse header row
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
                    const requiredHeaders = ['item_name', 'category', 'cost_price', 'selling_price', 'sale_date', 'customer_name'];

                    // Check for alternative header names
                    const headerMapping = {
                        'item_name': ['item_name', 'item name', 'itemname', 'product_name', 'product name', 'name'],
                        'category': ['category', 'item_category', 'product_category', 'type'],
                        'cost_price': ['cost_price', 'cost price', 'costprice', 'cost', 'purchase_price', 'cp'],
                        'selling_price': ['selling_price', 'selling price', 'sellingprice', 'price', 'sale_price', 'sp'],
                        'sale_date': ['sale_date', 'sale date', 'saledate', 'date', 'purchase_date'],
                        'customer_name': ['customer_name', 'customer name', 'customername', 'customer', 'buyer']
                    };

                    // Find column indices
                    const columnIndices = {};
                    let missingColumns = [];

                    for (const [key, alternatives] of Object.entries(headerMapping)) {
                        const foundIndex = headers.findIndex(h => alternatives.includes(h));
                        if (foundIndex >= 0) {
                            columnIndices[key] = foundIndex;
                        } else {
                            missingColumns.push(key);
                        }
                    }

                    if (missingColumns.length > 0) {
                        showError(`CSV must contain columns: ${requiredHeaders.join(', ')}. Missing: ${missingColumns.join(', ')}`);
                        return;
                    }

                    // Optional columns
                    const phoneIndex = headers.findIndex(h => ['customer_phone', 'customer phone', 'phone', 'mobile'].includes(h));
                    const addressIndex = headers.findIndex(h => ['customer_address', 'customer address', 'address'].includes(h));

                    let importedCount = 0;
                    let skippedCount = 0;
                    const errors = [];

                    // Process data rows
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const values = line.split(',').map(v => v.trim().replace(/"/g, ''));

                        if (values.length < headers.length) continue;

                        try {
                            const itemName = values[columnIndices.item_name]?.trim();
                            const category = values[columnIndices.category]?.trim();
                            const costPrice = parseFloat(values[columnIndices.cost_price]) || 0;
                            const sellingPrice = parseFloat(values[columnIndices.selling_price]) || 0;
                            const saleDate = values[columnIndices.sale_date]?.trim();
                            const customerName = values[columnIndices.customer_name]?.trim();
                            const customerPhone = phoneIndex >= 0 ? values[phoneIndex]?.trim() || '' : '';
                            const customerAddress = addressIndex >= 0 ? values[addressIndex]?.trim() || '' : '';

                            // Validate required fields
                            if (!itemName || !category || !costPrice || !sellingPrice || !saleDate || !customerName) {
                                errors.push(`Row ${i + 1}: Missing required fields`);
                                skippedCount++;
                                continue;
                            }

                            // Validate category
                            const validCategories = ['Necklaces', 'Earrings', 'Bracelets', 'Rings', 'Anklets', 'Sets', 'Bangles', 'Chains'];
                            if (!validCategories.includes(category)) {
                                errors.push(`Row ${i + 1}: Invalid category "${category}"`);
                                skippedCount++;
                                continue;
                            }

                            // Validate date format
                            const dateObj = new Date(saleDate);
                            if (isNaN(dateObj.getTime())) {
                                errors.push(`Row ${i + 1}: Invalid date format "${saleDate}"`);
                                skippedCount++;
                                continue;
                            }

                            // Create sale record
                            const newSale = {
                                id: Date.now() + Math.random(),
                                itemName: itemName,
                                category: category,
                                costPrice: costPrice,
                                sellingPrice: sellingPrice,
                                profit: sellingPrice - costPrice,
                                saleDate: saleDate,
                                customerName: customerName,
                                customerPhone: customerPhone,
                                customerAddress: customerAddress,
                                createdAt: new Date().toISOString()
                            };

                            salesData.push(newSale);
                            importedCount++;

                        } catch (error) {
                            errors.push(`Row ${i + 1}: ${error.message}`);
                            skippedCount++;
                        }
                    }

                    // Save to localStorage
                    localStorage.setItem('jewelrySales', JSON.stringify(salesData));

                    // Reset sales display to show latest sales
                    resetSalesDisplay();

                    // Refresh displays
                    loadSalesRecords();
                    updateDashboard();
                    loadCustomers();
                    updateCustomerCount();

                    let message = ` Import completed! ${importedCount} sales imported, ${skippedCount} records skipped.`;
                    if (errors.length > 0 && errors.length <= 5) {
                        message += `\n\nErrors:\n${errors.slice(0, 5).join('\n')}`;
                    } else if (errors.length > 5) {
                        message += `\n\n${errors.length} errors found. First 5:\n${errors.slice(0, 5).join('\n')}`;
                    }

                    showSuccess(message);

                } catch (error) {
                    console.error('Error importing CSV:', error);
                    showError('Error importing CSV file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Import sales from Excel
        function importExcelSales(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        showError('Excel file appears to be empty');
                        return;
                    }

                    let importedCount = 0;
                    let skippedCount = 0;
                    const errors = [];

                    jsonData.forEach((row, index) => {
                        try {
                            // Try different column name variations
                            const itemName = row['Item Name'] || row['Item_Name'] || row['itemname'] || row['Product Name'] || row['Name'];
                            const category = row['Category'] || row['Item Category'] || row['Type'];
                            const costPrice = parseFloat(row['Cost Price'] || row['Cost_Price'] || row['costprice'] || row['Cost'] || row['CP']) || 0;
                            const sellingPrice = parseFloat(row['Selling Price'] || row['Selling_Price'] || row['sellingprice'] || row['Price'] || row['SP']) || 0;
                            const saleDate = row['Sale Date'] || row['Sale_Date'] || row['saledate'] || row['Date'];
                            const customerName = row['Customer Name'] || row['Customer_Name'] || row['customername'] || row['Customer'];
                            const customerPhone = row['Customer Phone'] || row['Customer_Phone'] || row['Phone'] || row['Mobile'] || '';
                            const customerAddress = row['Customer Address'] || row['Customer_Address'] || row['Address'] || '';

                            // Validate required fields
                            if (!itemName || !category || !costPrice || !sellingPrice || !saleDate || !customerName) {
                                errors.push(`Row ${index + 2}: Missing required fields`);
                                skippedCount++;
                                return;
                            }

                            // Validate category
                            const validCategories = ['Necklaces', 'Earrings', 'Bracelets', 'Rings', 'Anklets', 'Sets', 'Bangles', 'Chains'];
                            if (!validCategories.includes(category)) {
                                errors.push(`Row ${index + 2}: Invalid category "${category}"`);
                                skippedCount++;
                                return;
                            }

                            // Validate and format date
                            let formattedDate = saleDate;
                            if (saleDate instanceof Date) {
                                formattedDate = saleDate.toISOString().split('T')[0];
                            } else if (typeof saleDate === 'string') {
                                const dateObj = new Date(saleDate);
                                if (isNaN(dateObj.getTime())) {
                                    errors.push(`Row ${index + 2}: Invalid date format "${saleDate}"`);
                                    skippedCount++;
                                    return;
                                }
                                formattedDate = dateObj.toISOString().split('T')[0];
                            }

                            // Create sale record
                            const newSale = {
                                id: Date.now() + Math.random(),
                                itemName: itemName,
                                category: category,
                                costPrice: costPrice,
                                sellingPrice: sellingPrice,
                                profit: sellingPrice - costPrice,
                                saleDate: formattedDate,
                                customerName: customerName,
                                customerPhone: customerPhone,
                                customerAddress: customerAddress,
                                createdAt: new Date().toISOString()
                            };

                            salesData.push(newSale);
                            importedCount++;

                        } catch (error) {
                            errors.push(`Row ${index + 2}: ${error.message}`);
                            skippedCount++;
                        }
                    });

                    // Save to localStorage
                    localStorage.setItem('jewelrySales', JSON.stringify(salesData));

                    // Reset sales display to show latest sales
                    resetSalesDisplay();

                    // Refresh displays
                    loadSalesRecords();
                    updateDashboard();
                    loadCustomers();
                    updateCustomerCount();

                    // Update sales summary statistics
                    updateSalesSummary();

                    // Update sales summary table
                    if (typeof loadSalesSummaryTable === 'function') {
                        loadSalesSummaryTable();
                    }

                    let message = ` Import completed! ${importedCount} sales imported, ${skippedCount} records skipped.`;
                    if (errors.length > 0 && errors.length <= 5) {
                        message += `\n\nErrors:\n${errors.slice(0, 5).join('\n')}`;
                    } else if (errors.length > 5) {
                        message += `\n\n${errors.length} errors found. First 5:\n${errors.slice(0, 5).join('\n')}`;
                    }

                    showSuccess(message);

                } catch (error) {
                    console.error('Error importing Excel:', error);
                    showError('Error importing Excel file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Download sales import template
        function downloadSalesTemplate() {
            const csvContent = [
                'item_name,category,cost_price,selling_price,sale_date,customer_name,customer_phone,customer_address',
                'Item Name,Category,Cost Price,Selling Price,YYYY-MM-DD,Customer Name,+91-XXXXXXXXXX,Full Address City State'
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'sales_import_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showSuccess(' Sales import template downloaded! Use this format for importing sales data.');
        }

        // Sales search and filter functionality
        let filteredSalesData = [];
        let isSearchActive = false;

        function filterSales() {
            const searchTerm = document.getElementById('sales-search').value.trim().toLowerCase();

            if (searchTerm.length === 0) {
                // Clear filter
                isSearchActive = false;
                filteredSalesData = [];
                resetSalesDisplay();
                loadSalesRecords();
                return;
            }

            if (searchTerm.length < 2) {
                return; // Wait for at least 2 characters
            }

            // Filter sales data
            filteredSalesData = salesData.filter(sale =>
                sale.itemName.toLowerCase().includes(searchTerm) ||
                sale.customerName.toLowerCase().includes(searchTerm) ||
                sale.category.toLowerCase().includes(searchTerm) ||
                (sale.customerPhone && sale.customerPhone.toLowerCase().includes(searchTerm))
            );

            isSearchActive = true;
            displayFilteredSales();
        }

        function displayFilteredSales() {
            const salesRecordsDiv = document.getElementById('sales-records');
            const loadMoreContainer = document.getElementById('load-more-container');
            const noSalesMessage = document.getElementById('no-sales-message');

            if (filteredSalesData.length === 0) {
                salesRecordsDiv.innerHTML = '';
                loadMoreContainer.style.display = 'none';
                noSalesMessage.style.display = 'block';
                noSalesMessage.innerHTML = `
                    <h3 style="color: #999;"> No Sales Found</h3>
                    <p>No sales records match your search criteria.</p>
                `;
                document.getElementById('sales-count').textContent = '0';
                return;
            }

            // Display all filtered results in table format
            salesRecordsDiv.innerHTML = `
                <div class="table-container" style="overflow-x: auto; border-radius: 8px; border: 1px solid #e9ecef;">
                    <table class="sales-table" style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 120px;"> Item</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 100px;"> Category</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 120px;"> Customer</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 100px;"> Phone</th>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 90px;"> Date</th>
                                <th style="padding: 12px 8px; text-align: right; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 80px;"> Cost</th>
                                <th style="padding: 12px 8px; text-align: right; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 80px;"> Selling</th>
                                <th style="padding: 12px 8px; text-align: right; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 80px;"> Profit</th>
                                <th style="padding: 12px 8px; text-align: center; border-bottom: 2px solid #e9ecef; font-weight: 600; font-size: 13px; min-width: 80px;"> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredSalesData.map((sale, index) => `
                                <tr id="sale-item-${sale.id}" style="border-bottom: 1px solid #f8f9fa; transition: all 0.2s ease; background: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'};"
                                    onmouseover="this.style.background='#e3f2fd'"
                                    onmouseout="this.style.background='${index % 2 === 0 ? '#ffffff' : '#f8f9fa'}'">
                                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; font-weight: 500; color: #333; font-size: 13px;">
                                        ${sale.itemName}
                                    </td>
                                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; color: #666; font-size: 12px;">
                                        ${sale.category}
                                    </td>
                                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; color: #333; font-size: 12px;">
                                        <div style="font-weight: 500;">${sale.customerName}</div>
                                        ${sale.customerAddress && sale.customerAddress !== 'Not provided' ?
                                            `<div style="font-size: 10px; color: #888; margin-top: 2px;"> ${sale.customerAddress}</div>` : ''}
                                    </td>
                                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; color: #666; font-size: 12px;">
                                        ${sale.customerPhone}
                                    </td>
                                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; color: #666; font-size: 12px;">
                                        ${new Date(sale.saleDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}
                                    </td>
                                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; text-align: right; color: #333; font-size: 12px; font-weight: 500;">
                                        ${(sale.costPrice || 0).toFixed(2)}
                                    </td>
                                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; text-align: right; color: #333; font-size: 12px; font-weight: 500;">
                                        ${(sale.sellingPrice || 0).toFixed(2)}
                                    </td>
                                    <td style="padding: 12px 8px; border-right: 1px solid #f0f0f0; text-align: right; color: ${(sale.profit || 0) >= 0 ? '#4CAF50' : '#f44336'}; font-size: 12px; font-weight: 600;">
                                        ${(sale.profit || 0).toFixed(2)}
                                    </td>
                                    <td style="padding: 12px 8px; text-align: center;">
                                        <div style="display: flex; gap: 4px; justify-content: center; align-items: center;">
                                            <button onclick="editSale(${sale.id})" title="Edit Sale"
                                                style="background: #2196F3; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; transition: all 0.2s ease;"
                                                onmouseover="this.style.background='#1976D2'"
                                                onmouseout="this.style.background='#2196F3'"></button>
                                            <button onclick="deleteSale(${sale.id})" title="Delete Sale"
                                                style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; transition: all 0.2s ease;"
                                                onmouseover="this.style.background='#d32f2f'"
                                                onmouseout="this.style.background='#f44336'"></button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            loadMoreContainer.style.display = 'none';
            noSalesMessage.style.display = 'none';
            document.getElementById('sales-count').textContent = filteredSalesData.length;

            // Update summary for filtered data
            updateSalesSummary(filteredSalesData);
        }

        function clearSalesFilter() {
            document.getElementById('sales-search').value = '';
            isSearchActive = false;
            filteredSalesData = [];
            resetSalesDisplay();
            loadSalesRecords();
        }

        function updateSalesSummary(dataToSummarize = null) {
            const dataToUse = dataToSummarize || salesData;

            const totalSales = dataToUse.length;
            const totalCost = dataToUse.reduce((sum, sale) => sum + (sale.costPrice || 0), 0);
            const totalSelling = dataToUse.reduce((sum, sale) => sum + (sale.sellingPrice || 0), 0);
            const totalProfit = totalSelling - totalCost;

            document.getElementById('summary-total-sales').textContent = totalSales;
            document.getElementById('summary-total-cost').textContent = `${(totalCost || 0).toFixed(2)}`;
            document.getElementById('summary-total-selling').textContent = `${(totalSelling || 0).toFixed(2)}`;
            document.getElementById('summary-total-profit').textContent = `${(totalProfit || 0).toFixed(2)}`;
        }

        function createSaleItemHTML(sale) {
            const saleDate = new Date(sale.saleDate);
            const formattedDate = saleDate.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });

            const profitColor = sale.profit > 0 ? '#4ecdc4' : sale.profit < 0 ? '#ff6b6b' : '#666';

            return `
                <div class="sales-item" style="position: relative; margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid ${profitColor}; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div class="action-buttons" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;">
                        <button class="edit-btn" onclick="editSale('${sale.id}')" style="background: #007bff; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                             Edit
                        </button>
                        <button class="delete-btn" onclick="deleteSale('${sale.id}')" style="background: #ff6b6b; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                             Delete
                        </button>
                    </div>

                    <h4 style="margin: 0 0 8px 0; color: #333; font-size: 16px; padding-right: 120px;">${sale.itemName}</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 14px; color: #666;">
                        <p style="margin: 0;"><strong> Category:</strong> ${sale.category}</p>
                        <p style="margin: 0;"><strong> Date:</strong> ${formattedDate}</p>
                        <p style="margin: 0;"><strong> Cost:</strong> ${(sale.costPrice || 0).toFixed(2)}</p>
                        <p style="margin: 0;"><strong> Selling:</strong> ${(sale.sellingPrice || 0).toFixed(2)}</p>
                        <p style="margin: 0;"><strong> Profit:</strong> <span style="color: ${profitColor}; font-weight: bold;">${(sale.profit || 0).toFixed(2)}</span></p>
                        <p style="margin: 0;"><strong> Customer:</strong> ${sale.customerName}</p>
                    </div>

                    ${sale.customerPhone ? `<p style="margin: 8px 0 0 0; font-size: 13px; color: #888;"><strong> Phone:</strong> ${sale.customerPhone}</p>` : ''}
                    ${sale.customerAddress ? `<p style="margin: 4px 0 0 0; font-size: 13px; color: #888;"><strong> Address:</strong> ${sale.customerAddress}</p>` : ''}
                </div>
            `;
        }

        // Customer search functionality
        function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('customer-search-results');
            selectedSearchIndex = -1; // Reset selection

            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            // Get unique customers from both database and sales data
            const allUniqueCustomers = getUniqueCustomers();

            // Update total customer count
            document.getElementById('total-customers').textContent = allUniqueCustomers.length;

            // Filter customers based on search term
            const matchingCustomers = allUniqueCustomers.filter(customer =>
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.phone.toLowerCase().includes(searchTerm) ||
                (customer.email && customer.email.toLowerCase().includes(searchTerm))
            );

            if (matchingCustomers.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 10px; color: #666; font-style: italic;">No customers found. You can enter new customer details below.</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            // Display matching customers
            resultsContainer.innerHTML = matchingCustomers.map(customer => {
                const lastPurchaseText = customer.lastPurchase
                    ? `Last purchase: ${new Date(customer.lastPurchase).toLocaleDateString()}`
                    : 'No purchases yet';

                const sourceIcon = customer.source === 'database' ? '' : '';
                const sourceText = customer.source === 'database' ? 'In Customer DB' : 'From Sales Only';

                return `
                <div style="padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: all 0.2s; border-left: 3px solid transparent;"
                     onclick="selectCustomer('${escapeQuotes(customer.name)}', '${escapeQuotes(customer.phone)}', '${escapeQuotes(customer.address)}', '${escapeQuotes(customer.email)}')"
                     onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.borderLeftColor='#4ecdc4';"
                     onmouseout="this.style.backgroundColor='white'; this.style.borderLeftColor='transparent';">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                            <div style="font-weight: bold; color: #333; font-size: 15px;">${customer.name}</div>
                    <div style="font-size: 10px; color: #999; padding: 2px 6px; background: #f0f0f0; border-radius: 10px;">
                            ${sourceIcon} ${sourceText}
                        </div>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 6px;">
                        ${customer.phone !== 'Not provided' ?
                                `<div style="font-size: 12px; color: #666; display: flex; align-items: center;"> ${customer.phone}</div>` : ''}
                        ${customer.email && customer.email !== 'Not provided' ?
                        `<div style="font-size: 12px; color: #666; display: flex; align-items: center;"> ${customer.email}</div>` : ''}
                    ${customer.address && customer.address !== 'Not provided' ?
                        `<div style="font-size: 12px; color: #888; margin-bottom: 6px; line-height: 1.3;"> ${customer.address}</div>` : ''}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                        </div>
                    <div style="font-size: 11px; color: #4ecdc4; font-weight: 600;">
                            ${customer.totalPurchases > 0 ?
                                `${customer.totalPurchases} purchase${customer.totalPurchases > 1 ? 's' : ''}  ${(customer.totalSpent || 0).toFixed(2)} total` :
                                'New customer'
                            }
                        </div>
                        <div style="font-size: 10px; color: #999; font-style: italic;">
                            ${lastPurchaseText}
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            resultsContainer.style.display = 'block';
        }

        // Get customers from customer database and sales data with purchase stats
        function getUniqueCustomers() {
            const allCustomers = new Map();

            // Add customers from customer database
            customersData.forEach(customer => {
                const customerSales = salesData.filter(sale =>
                    sale.customerName.toLowerCase() === customer.name.toLowerCase() ||
                    sale.customerPhone === customer.phone
                );

                const totalPurchases = customerSales.length;
                const totalSpent = customerSales.reduce((sum, sale) => sum + sale.sellingPrice, 0);
                const lastPurchase = customerSales.length > 0
                    ? Math.max(...customerSales.map(sale => new Date(sale.saleDate).getTime()))
                    : null;

                const customerKey = customer.name.toLowerCase() + '|' + (customer.phone || '');
                allCustomers.set(customerKey, {
                    name: customer.name,
                    phone: customer.phone || 'Not provided',
                    address: customer.address || 'Not provided',
                    email: customer.email || 'Not provided',
                    totalPurchases: totalPurchases,
                    totalSpent: totalSpent,
                    lastPurchase: lastPurchase,
                    source: 'database'
                });
            });

            // Add customers from sales data who are not in customer database
            salesData.forEach(sale => {
                const customerKey = sale.customerName.toLowerCase() + '|' + (sale.customerPhone || '');

                if (!allCustomers.has(customerKey)) {
                    const customerSales = salesData.filter(s =>
                        s.customerName.toLowerCase() === sale.customerName.toLowerCase() ||
                        (s.customerPhone && sale.customerPhone && s.customerPhone === sale.customerPhone)
                    );

                    const totalPurchases = customerSales.length;
                    const totalSpent = customerSales.reduce((sum, s) => sum + s.sellingPrice, 0);
                    const lastPurchase = Math.max(...customerSales.map(s => new Date(s.saleDate).getTime()));

                    allCustomers.set(customerKey, {
                        name: sale.customerName,
                        phone: sale.customerPhone || 'Not provided',
                        address: sale.customerAddress || 'Not provided',
                        email: 'Not provided',
                        totalPurchases: totalPurchases,
                        totalSpent: totalSpent,
                        lastPurchase: lastPurchase,
                        source: 'sales'
                    });
                }
            });

            // Convert to array and sort by total spent (descending), then by last purchase date (descending)
            return Array.from(allCustomers.values()).sort((a, b) => {
                if (b.totalSpent !== a.totalSpent) {
                    return b.totalSpent - a.totalSpent;
                }
                if (a.lastPurchase && b.lastPurchase) {
                    return b.lastPurchase - a.lastPurchase;
                }
                return a.lastPurchase ? -1 : (b.lastPurchase ? 1 : 0);
            });
        }

        // Escape quotes for HTML attributes
        function escapeQuotes(str) {
            if (!str) return '';
            return str.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        }

        // Select customer from search results
        function selectCustomer(name, phone, address, email) {
            document.getElementById('customerName').value = name;
            document.getElementById('customerPhone').value = phone !== 'Not provided' ? phone : '';
            document.getElementById('customerAddress').value = address !== 'Not provided' ? address : '';

            // Clear search
            document.getElementById('customerSearch').value = '';
            document.getElementById('customer-search-results').style.display = 'none';

            // Show success message
            showSuccess(` Customer "${name}" selected! Details filled automatically.`);

            // Focus on item name field
            document.getElementById('itemName').focus();
        }

        // Clear customer search
        function clearCustomerSearch() {
            document.getElementById('customerSearch').value = '';
            document.getElementById('customer-search-results').style.display = 'none';
        }

        // Handle keyboard navigation in search
        let selectedSearchIndex = -1;
        function handleSearchKeydown(event) {
            const resultsContainer = document.getElementById('customer-search-results');
            const results = resultsContainer.querySelectorAll('[onclick*="selectCustomer"]');

            if (results.length === 0) return;

            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedSearchIndex = Math.min(selectedSearchIndex + 1, results.length - 1);
                    highlightSearchResult(results);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    selectedSearchIndex = Math.max(selectedSearchIndex - 1, -1);
                    highlightSearchResult(results);
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedSearchIndex >= 0 && selectedSearchIndex < results.length) {
                        results[selectedSearchIndex].click();
                    }
                    break;
                case 'Escape':
                    clearCustomerSearch();
                    break;
            }
        }

        function highlightSearchResult(results) {
            // Remove previous highlights
            results.forEach((result, index) => {
                if (index === selectedSearchIndex) {
                    result.style.backgroundColor = '#4ecdc4';
                    result.style.color = 'white';
                } else {
                    result.style.backgroundColor = 'white';
                    result.style.color = 'inherit';
                }
            });
        }

        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchContainer = document.getElementById('customerSearch').parentElement;
            const resultsContainer = document.getElementById('customer-search-results');

            if (!searchContainer.contains(event.target)) {
                resultsContainer.style.display = 'none';
            }
        });

        // Calculate profit automatically
        function calculateProfit() {
            // Call the comprehensive calculateTotal function instead
            calculateTotal();
        }

        // Legacy calculateProfit function for backward compatibility
        function calculateProfitLegacy() {
            try {
                const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
                const sellingPrice = parseFloat(document.getElementById('sellingPrice').value) || 0;
                const profit = sellingPrice - costPrice;

                const profitField = document.getElementById('profit');
                const profitDisplay = document.getElementById('profit-display');
                const profitMargin = document.getElementById('profit-margin');

                // Safe toFixed with fallback
                profitField.value = (profit && !isNaN(profit) && isFinite(profit)) ? profit.toFixed(2) : '0.00';

            // Calculate profit margin percentage
            let marginPercentage = 0;
            if (sellingPrice > 0) {
                marginPercentage = ((profit / sellingPrice) * 100);
            }

            // Update profit margin display
            if (profitMargin) {
                profitMargin.textContent = (marginPercentage && !isNaN(marginPercentage) && isFinite(marginPercentage)) ? marginPercentage.toFixed(1) + '%' : '0.0%';
            }

            // Show/hide profit display
            if (costPrice > 0 && sellingPrice > 0) {
                profitDisplay.style.display = 'block';
            } else {
                profitDisplay.style.display = 'none';
            }

            // Enhanced color coding based on profit
            if (profit > 0) {
                profitField.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                profitField.style.color = '#065f46';
                profitField.style.fontWeight = '600';
                profitField.style.borderColor = '#34d399';

                // Color code the margin based on percentage
                if (marginPercentage >= 30) {
                    profitMargin.style.color = '#065f46'; // Excellent
                    profitMargin.style.background = '#d1fae5';
                } else if (marginPercentage >= 20) {
                    profitMargin.style.color = '#047857'; // Good
                    profitMargin.style.background = '#ecfdf5';
                } else if (marginPercentage >= 10) {
                    profitMargin.style.color = '#d97706'; // Fair
                    profitMargin.style.background = '#fef3c7';
                } else {
                    profitMargin.style.color = '#dc2626'; // Low
                    profitMargin.style.background = '#fee2e2';
                }

            } else if (profit < 0) {
                profitField.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
                profitField.style.color = '#dc2626';
                profitField.style.fontWeight = '600';
                profitField.style.borderColor = '#f87171';

                if (profitMargin) {
                    profitMargin.style.color = '#dc2626';
                    profitMargin.style.background = '#fee2e2';
                }
            } else {
                profitField.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
                profitField.style.color = '#6b7280';
                profitField.style.fontWeight = 'normal';
                profitField.style.borderColor = '#d1d5db';

                if (profitMargin) {
                    profitMargin.style.color = '#6b7280';
                    profitMargin.style.background = '#f3f4f6';
                }
            }

            // Add visual feedback animation
            profitField.style.transform = 'scale(1.02)';
            setTimeout(() => {
                profitField.style.transform = 'scale(1)';
            }, 200);

            } catch (error) {
                console.error('Error calculating profit:', error);
                // Set default values on error
                document.getElementById('profit').value = '0.00';
                if (document.getElementById('profit-margin')) {
                    document.getElementById('profit-margin').textContent = '0.0%';
                }
            }
        }

        // Calculate total including shipping
        function calculateTotal() {
            try {
                const costPriceElement = document.getElementById('costPrice');
                const sellingPriceElement = document.getElementById('sellingPrice');
                const shippingAmountElement = document.getElementById('shippingAmount');

                if (!costPriceElement || !sellingPriceElement || !shippingAmountElement) {
                    console.warn('Some price elements not found, skipping calculation');
                    return;
                }

                const costPrice = parseFloat(costPriceElement.value) || 0;
                const sellingPrice = parseFloat(sellingPriceElement.value) || 0;
                const shippingAmount = parseFloat(shippingAmountElement.value) || 0;

                // Calculate profit (without shipping in profit calculation)
                const profit = sellingPrice - costPrice;
                const totalAmount = sellingPrice + shippingAmount;

                const profitField = document.getElementById('profit');
                const profitDisplay = document.getElementById('profit-display');
                const profitMargin = document.getElementById('profit-margin');

                // Update profit field (shipping doesn't affect profit margin calculation)
                profitField.value = (profit && !isNaN(profit) && isFinite(profit)) ? profit.toFixed(2) : '0.00';

                // Calculate profit margin percentage (based on selling price, not total)
                let marginPercentage = 0;
                if (sellingPrice > 0) {
                    marginPercentage = ((profit / sellingPrice) * 100);
                }

                // Update profit margin display
                if (profitMargin) {
                    profitMargin.textContent = (marginPercentage && !isNaN(marginPercentage) && isFinite(marginPercentage)) ? marginPercentage.toFixed(1) + '%' : '0.0%';
                }

                // Show/hide profit display
                if (costPrice > 0 && sellingPrice > 0) {
                    profitDisplay.style.display = 'block';
                } else {
                    profitDisplay.style.display = 'none';
                }

                // Enhanced color coding based on profit
                if (profit > 0) {
                    profitField.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                    profitField.style.color = '#065f46';
                    profitField.style.fontWeight = '600';
                    profitField.style.borderColor = '#34d399';

                    // Color code the margin based on percentage
                    if (marginPercentage >= 30) {
                        profitMargin.style.color = '#065f46';
                        profitMargin.style.background = '#d1fae5';
                    } else if (marginPercentage >= 20) {
                        profitMargin.style.color = '#047857';
                        profitMargin.style.background = '#ecfdf5';
                    } else if (marginPercentage >= 10) {
                        profitMargin.style.color = '#d97706';
                        profitMargin.style.background = '#fef3c7';
                    } else {
                        profitMargin.style.color = '#dc2626';
                        profitMargin.style.background = '#fee2e2';
                    }

                } else if (profit < 0) {
                    profitField.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
                    profitField.style.color = '#dc2626';
                    profitField.style.fontWeight = '600';
                    profitField.style.borderColor = '#f87171';

                    if (profitMargin) {
                        profitMargin.style.color = '#dc2626';
                        profitMargin.style.background = '#fee2e2';
                    }
                } else {
                    profitField.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
                    profitField.style.color = '#6b7280';
                    profitField.style.fontWeight = 'normal';
                    profitField.style.borderColor = '#d1d5db';

                    if (profitMargin) {
                        profitMargin.style.color = '#6b7280';
                        profitMargin.style.background = '#f3f4f6';
                    }
                }

                // Visual feedback for shipping
                const shippingField = document.getElementById('shippingAmount');
                if (shippingField) {
                    if (shippingAmount > 0) {
                        shippingField.style.borderColor = '#10B981';
                        shippingField.style.background = '#f0fdf4';
                    } else {
                        shippingField.style.borderColor = '#d1d5db';
                        shippingField.style.background = 'white';
                    }
                }

            } catch (error) {
                console.error('Error calculating total:', error);
            }
        }

        // Barcode scanning function
        function scanBarcode() {
            // Check if the browser supports camera access
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Camera access is not supported in this browser. Please enter the tracking ID manually.');
                return;
            }

            // For now, we'll use a simple prompt as a placeholder
            // In a production app, you would use a barcode scanning library like QuaggaJS or ZXing
            const scannedCode = prompt('Barcode Scanner\n\nFor demonstration: Please enter the barcode manually.\n\nIn production, this would open camera scanner:');

            if (scannedCode && scannedCode.trim()) {
                document.getElementById('trackingId').value = scannedCode.trim();
                showSuccess('Tracking ID captured successfully!');
            }
        }

        // Note: For production use, you can implement camera-based barcode scanning
        // using libraries like QuaggaJS or ZXing-JS-Library

        // Add sale record function
        function addSaleRecord() {
            try {
                // Get form values with safe parsing
                const itemName = document.getElementById('itemName').value.trim();
                const costPriceValue = document.getElementById('costPrice').value;
                const sellingPriceValue = document.getElementById('sellingPrice').value;
                const costPrice = parseFloat(costPriceValue) || 0;
                const sellingPrice = parseFloat(sellingPriceValue) || 0;
                const saleDate = document.getElementById('saleDate').value;
                const customerName = document.getElementById('customerName').value.trim();
                const customerPhone = document.getElementById('customerPhone').value.trim();

                // Debug log for troubleshooting
                console.log('Form values:', {
                    itemName,
                    costPriceValue,
                    sellingPriceValue,
                    costPrice,
                    sellingPrice,
                    saleDate,
                    customerName
                });
                const customerAddress = document.getElementById('customerAddress').value.trim();

                // Safely get new fields with defaults
                const shippingAmountElement = document.getElementById('shippingAmount');
                const shippingAmount = shippingAmountElement ? parseFloat(shippingAmountElement.value) || 0 : 0;

                const paymentModeElement = document.getElementById('paymentMode');
                const paymentMode = paymentModeElement ? paymentModeElement.value : 'UPI';

                const trackingIdElement = document.getElementById('trackingId');
                const trackingId = trackingIdElement ? trackingIdElement.value.trim() : '';

                // Validate required fields with alerts
                if (!itemName) {
                    showError('Please enter item name');
                    alert(' Validation Error:\nPlease enter the item name to proceed.');
                    document.getElementById('itemName').focus();
                    return;
                }
                if (selectedCategories.length === 0) {
                    showError('Please select at least one category');
                    alert(' Validation Error:\nPlease select at least one category for the item.');
                    document.getElementById('category-error').style.display = 'flex';
                    return;
                }
                if (!costPriceValue || isNaN(costPrice) || costPrice <= 0) {
                    showError('Please enter a valid cost price');
                    alert(' Validation Error:\nPlease enter a valid cost price (must be greater than 0).');
                    document.getElementById('costPrice').focus();
                    return;
                }
                if (!sellingPriceValue || isNaN(sellingPrice) || sellingPrice <= 0) {
                    showError('Please enter a valid selling price');
                    alert(' Validation Error:\nPlease enter a valid selling price (must be greater than 0).');
                    document.getElementById('sellingPrice').focus();
                    return;
                }
                if (sellingPrice < costPrice) {
                    showError('Selling price cannot be less than cost price');
                    alert(' Validation Error:\nSelling price cannot be less than cost price.\nThis would result in a loss!');
                    document.getElementById('sellingPrice').focus();
                    return;
                }
                if (!saleDate) {
                    showError('Please select a sale date');
                    alert(' Validation Error:\nPlease select the sale date.');
                    document.getElementById('saleDate').focus();
                    return;
                }
                if (!customerName) {
                    showError('Please enter customer name');
                    alert(' Validation Error:\nPlease enter the customer name to proceed.');
                    document.getElementById('customerName').focus();
                    return;
                }

                // Save customer to database automatically when adding sale
                saveCustomerFromSale(customerName, customerPhone, customerAddress);

                // Create sale record with multiple categories
                const calculatedProfit = (sellingPrice && costPrice) ? sellingPrice - costPrice : 0;

                // Ensure all numeric values are valid
                const safeRecord = {
                    id: Date.now(),
                    itemName: itemName,
                    category: selectedCategories.join(', '), // Join multiple categories with comma
                    categories: selectedCategories, // Keep array for advanced filtering
                    costPrice: parseFloat(costPrice) || 0,
                    sellingPrice: parseFloat(sellingPrice) || 0,
                    profit: parseFloat(calculatedProfit) || 0,
                    shippingAmount: parseFloat(shippingAmount) || 0,
                    paymentMode: paymentMode || 'UPI',
                    saleDate: saleDate,
                    customerName: customerName,
                    customerPhone: customerPhone || 'Not provided',
                    trackingId: trackingId || '', // Add tracking ID (optional)
                    customerAddress: customerAddress || 'Not provided',
                    createdAt: new Date().toISOString()
                };

                const saleRecord = safeRecord;

                // Add to array
                salesData.push(saleRecord);

                // Save to localStorage (fallback)
                try {
                    localStorage.setItem('jewelrySales', JSON.stringify(salesData));

                    // Show success message with sale details
                    showSuccess(` Sale Added Successfully!\n Item: ${itemName}\n Selling Price: ${sellingPrice.toFixed(2)}\n Profit: ${calculatedProfit.toFixed(2)}`);

                } catch (storageError) {
                    showError('Error saving data: ' + storageError.message);
                    alert(' Storage Error!\n\nFailed to save the sale record to local storage:\n\n' + storageError.message + '\n\nThis might be due to storage limits or browser settings. Please try clearing some browser data or contact support.');
                    return;
                }

                // Save to database (Firebase/Google Sheets)
                saveToDatabase(saleRecord).then(result => {
                    if (result.success) {
                        console.log(' Sale saved to database:', result.message);
                    } else {
                        console.error(' Database save failed:', result.error);
                        showError('Database save failed: ' + result.error);
                    }
                }).catch(error => {
                    console.error(' Database save error:', error);
                    showError('Database save error: ' + error.message);
                });

                // Clear form
                document.getElementById('sales-form').reset();
                document.getElementById('profit').value = '';
                document.getElementById('customerAddress').value = '';
                document.getElementById('customerSearch').value = '';
                document.getElementById('customer-search-results').style.display = 'none';
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                document.getElementById('saleDate').value = dateString;

                // Clear selected categories
                clearAllCategories();

                // Reset sales display to show latest sales
                resetSalesDisplay();

                // Refresh displays with error handling
                try {
                    loadSalesRecords();
                    updateDashboard();
                    loadCustomers();
                    updateCustomerCount();

                    // Update sales summary statistics
                    updateSalesSummary();

                    // Update sales summary table
                    if (typeof loadSalesSummaryTable === 'function') {
                        loadSalesSummaryTable();
                    }

                    // Stay on current tab after adding sales
                    // Auto-switch removed as per user request

                    // Regenerate AI insights with new data
                    setTimeout(() => {
                        generateAIInsights();
                    }, 100);
                } catch (displayError) {
                    console.error(' Display refresh error:', displayError);
                    console.error(' Error stack:', displayError.stack);
                    // Continue with success message even if display refresh fails
                }

                // Show success message
                showSuccess(' Sale record added successfully! Customer saved to database.');

                // Calculate profit safely
                const profit = (sellingPrice && costPrice) ? sellingPrice - costPrice : 0;
                const profitText = (!isNaN(profit) && isFinite(profit)) ? profit.toFixed(2) : '0.00';

                console.log(' About to show success alert...');
                alert(' Success!\n\nSale record has been added successfully!\n\n Details:\n Item: ' + itemName + '\n Categories: ' + selectedCategories.join(', ') + '\n Customer: ' + customerName + '\n Profit: ' + profitText);
                console.log(' Success alert shown successfully');

                // Reset the form after successful submission
                try {
                    const salesForm = document.getElementById('sales-form');
                    if (salesForm) salesForm.reset();

                    const trackingIdField = document.getElementById('trackingId');
                    if (trackingIdField) trackingIdField.value = '';

                    const shippingAmountField = document.getElementById('shippingAmount');
                    if (shippingAmountField) shippingAmountField.value = '0';

                    const paymentModeField = document.getElementById('paymentMode');
                    if (paymentModeField) paymentModeField.value = 'UPI';

                    // Reset category selection safely
                    selectedCategories = [];
                    const selectedCategoriesElement = document.getElementById('selected-categories');
                    if (selectedCategoriesElement) selectedCategoriesElement.innerHTML = '';

                    const categoryErrorElement = document.getElementById('category-error');
                    if (categoryErrorElement) categoryErrorElement.style.display = 'none';

                    // Hide profit display safely
                    const profitDisplayElement = document.getElementById('profit-display');
                    if (profitDisplayElement) profitDisplayElement.style.display = 'none';
                } catch (resetError) {
                    console.error('Error during form reset:', resetError);
                    // Continue execution even if reset fails
                }

                console.log(' Form reset completed');

            } catch (error) {
                console.error('Error adding sale:', error);
                showError('Error adding sale record: ' + error.message);
                alert(' Error!\n\nAn unexpected error occurred while adding the sale record:\n\n' + error.message + '\n\nPlease try again or contact support if the problem persists.');
            }
        }

        // Save customer from sale entry automatically
        function saveCustomerFromSale(customerName, customerPhone, customerAddress) {
            try {
                if (!customerName.trim()) return;

                // Check if customer already exists by name or phone
                const existingCustomerIndex = customersData.findIndex(customer =>
                    customer.name.toLowerCase() === customerName.toLowerCase() ||
                    (customerPhone && customer.phone === customerPhone)
                );

                if (existingCustomerIndex !== -1) {
                    // Update existing customer with any new information
                    const existingCustomer = customersData[existingCustomerIndex];
                    let updated = false;

                    if (customerPhone && customerPhone !== existingCustomer.phone && existingCustomer.phone === 'Not provided') {
                        existingCustomer.phone = customerPhone;
                        updated = true;
                    }

                    if (customerAddress && customerAddress !== existingCustomer.address && existingCustomer.address === 'Not provided') {
                        existingCustomer.address = customerAddress;
                        updated = true;
                    }

                    // Update last purchase date
                    existingCustomer.lastPurchase = new Date().toISOString();
                    updated = true;

                    if (updated) {
                        customersData[existingCustomerIndex] = existingCustomer;
                        localStorage.setItem('jewelryCustomers', JSON.stringify(customersData));
                    }
                } else {
                    // Add new customer
                    const newCustomer = {
                        id: Date.now(),
                        name: customerName,
                        phone: customerPhone || 'Not provided',
                        address: customerAddress || 'Not provided',
                        email: 'Not provided',
                        status: 'active',
                        notes: `Auto-added from sale entry on ${new Date().toLocaleDateString()}`,
                        createdAt: new Date().toISOString(),
                        lastPurchase: new Date().toISOString()
                    };

                    customersData.push(newCustomer);
                    localStorage.setItem('jewelryCustomers', JSON.stringify(customersData));
                }
            } catch (error) {
                console.error('Error saving customer from sale:', error);
                // Don't throw error to not interrupt sale process
            }
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            const errorDiv = document.getElementById('error-message');

            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';

            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');

            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';

            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }



        // Load sales records
        function loadSalesRecords() {
            console.log(' Loading sales records...');
            console.log(' Current salesData length:', salesData.length);

            // Ensure salesData is loaded from localStorage if empty
            if (!salesData || salesData.length === 0) {
                console.log(' salesData is empty, loading from localStorage...');
                const savedData = localStorage.getItem('jewelrySales');
                if (savedData) {
                    try {
                        const rawData = JSON.parse(savedData);
                        salesData = cleanSalesData(rawData);
                        console.log(' Loaded', salesData.length, 'sales records from localStorage');
                    } catch (error) {
                        console.error(' Error parsing localStorage data:', error);
                        salesData = [];
                    }
                } else {
                    console.log(' No saved data found in localStorage');
                    salesData = [];
                }
            }

            const container = document.getElementById('sales-records');
            const countElement = document.getElementById('sales-count');
            const summaryDiv = document.getElementById('sales-summary');
            const dailyReportDiv = document.getElementById('daily-sales-report');
            const noSalesMessage = document.getElementById('no-sales-message');

            if (!container) {
                console.error(' sales-records container not found');
                return;
            }

            if (countElement) {
                countElement.textContent = salesData.length;
            }

            console.log(' Final salesData length after loading:', salesData.length);

            // Add a subtle loading animation
            container.style.opacity = '0.7';
            container.style.transform = 'translateY(10px)';

            setTimeout(() => {
                container.style.opacity = '1';
                container.style.transform = 'translateY(0)';
            }, 100);

            if (salesData.length === 0) {
                console.log(' No sales data found, showing empty message');
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>No sales records found</h3><p>Add your first sale to see it here!</p></div>';
                if (summaryDiv) summaryDiv.style.display = 'none';
                if (dailyReportDiv) dailyReportDiv.style.display = 'none';
                if (noSalesMessage) noSalesMessage.style.display = 'block';
                return;
            }

            // Hide no-sales message when we have data
            noSalesMessage.style.display = 'none';

            // Ensure the sales section is expanded when we have data
            const salesContentContainer = document.getElementById('sales-content-container');
            if (salesContentContainer) {
                salesContentContainer.classList.remove('collapsed');
            }

            // Update summary
            const totalSales = salesData.length;
            const totalCost = salesData.reduce((sum, sale) => sum + (sale.costPrice || 0), 0);
            const totalSelling = salesData.reduce((sum, sale) => sum + (sale.sellingPrice || 0), 0);
            const totalProfit = salesData.reduce((sum, sale) => sum + (sale.profit || 0), 0);

            document.getElementById('summary-total-sales').textContent = totalSales;
            document.getElementById('summary-total-cost').textContent = `${(totalCost || 0).toFixed(2)}`;
            document.getElementById('summary-total-selling').textContent = `${(totalSelling || 0).toFixed(2)}`;
            document.getElementById('summary-total-profit').textContent = `${(totalProfit || 0).toFixed(2)}`;
            summaryDiv.style.display = 'block';

            // Update daily sales report
            updateDailySalesReport();
            dailyReportDiv.style.display = 'block';

            // Show sales with pagination
            const recentSales = salesData.slice().reverse(); // All sales in reverse order
            const salesToShow = recentSales.slice(0, displayedSalesCount);
            const loadMoreContainer = document.getElementById('load-more-container');

            // Create enhanced table format

            const tableHTML = `
                <div class="table-container" style="overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <table class="sales-table" style="width: 100%; border-collapse: collapse; background: white; font-family: 'Inter', sans-serif;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; position: sticky; top: 0; z-index: 10;">
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 14px; min-width: 150px; text-transform: uppercase; letter-spacing: 0.5px;"> Item</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 14px; min-width: 120px; text-transform: uppercase; letter-spacing: 0.5px;"> Category</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 14px; min-width: 140px; text-transform: uppercase; letter-spacing: 0.5px;"> Customer</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 14px; min-width: 120px; text-transform: uppercase; letter-spacing: 0.5px;"> Phone</th>
                                <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 14px; min-width: 110px; text-transform: uppercase; letter-spacing: 0.5px;"> Date</th>
                                <th style="padding: 16px 12px; text-align: right; font-weight: 600; font-size: 14px; min-width: 100px; text-transform: uppercase; letter-spacing: 0.5px;"> Cost</th>
                                <th style="padding: 16px 12px; text-align: right; font-weight: 600; font-size: 14px; min-width: 100px; text-transform: uppercase; letter-spacing: 0.5px;"> Selling</th>
                                <th style="padding: 16px 12px; text-align: right; font-weight: 600; font-size: 14px; min-width: 100px; text-transform: uppercase; letter-spacing: 0.5px;"> Profit</th>
                                <th style="padding: 16px 12px; text-align: center; font-weight: 600; font-size: 14px; min-width: 100px; text-transform: uppercase; letter-spacing: 0.5px;"> Actions</th>
    </tr>
                        </thead>
                        <tbody>
                            ${salesToShow.map((sale, index) => {
                                                        const isNewest = index === 0; // First item is the newest
                                const baseColor = isNewest ? '#e8f5e8' : (index % 2 === 0 ? '#ffffff' : '#f8f9fa');
                                return `
                                <tr id="sale-item-${sale.id}" style="border-bottom: 1px solid #e9ecef; transition: all 0.3s ease; background: ${baseColor}; animation: slideInUp 0.5s ease ${index * 0.1}s both; ${isNewest ? 'border-left: 4px solid #4CAF50;' : ''}"
                                    onmouseover="this.style.background='#e3f2fd'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                                    onmouseout="this.style.background='${baseColor}'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <td style="padding: 14px 12px; border-right: 1px solid #f0f0f0; font-weight: 600; color: #333; font-size: 14px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 8px; height: 8px; background: linear-gradient(45deg, #4CAF50, #45a049); border-radius: 50%;"></div>
                                            ${sale.itemName}
                                        </div>
                                    </td>
                                    <td style="padding: 14px 12px; border-right: 1px solid #f0f0f0; color: #666; font-size: 13px;">
                                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                            ${sale.category}
                                        </span>
                                    </td>
                                    <td style="padding: 14px 12px; border-right: 1px solid #f0f0f0; color: #333; font-size: 13px;">
                                        <div style="font-weight: 600; color: #333; margin-bottom: 2px;">${sale.customerName}</div>
                                        ${sale.customerAddress && sale.customerAddress !== 'Not provided' ?
                                            `<div style="font-size: 11px; color: #888; display: flex; align-items: center; gap: 4px;"><span></span> ${sale.customerAddress}</div>` : ''}
                                    </td>
                                    <td style="padding: 14px 12px; border-right: 1px solid #f0f0f0; color: #666; font-size: 13px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 14px;"></span>
                                            ${sale.customerPhone}
                                        </div>
                                    </td>
                                    <td style="padding: 14px 12px; border-right: 1px solid #f0f0f0; color: #666; font-size: 13px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 14px;"></span>
                                            ${new Date(sale.saleDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}
                                        </div>
                                    </td>
                                    <td style="padding: 14px 12px; border-right: 1px solid #f0f0f0; text-align: right; color: #333; font-size: 13px; font-weight: 600;">
                                        <span style="color: #ff6b6b;">${(sale.costPrice || 0).toFixed(2)}</span>
                                    </td>
                                    <td style="padding: 14px 12px; border-right: 1px solid #f0f0f0; text-align: right; color: #333; font-size: 13px; font-weight: 600;">
                                        <span style="color: #4CAF50;">${(sale.sellingPrice || 0).toFixed(2)}</span>
                                    </td>
                                    <td style="padding: 14px 12px; border-right: 1px solid #f0f0f0; text-align: right; font-size: 13px; font-weight: 700;">
                                        <span style="color: ${(sale.profit || 0) >= 0 ? '#4CAF50' : '#f44336'}; background: ${(sale.profit || 0) >= 0 ? '#e8f5e8' : '#ffebee'}; padding: 4px 8px; border-radius: 6px;">
                                            ${(sale.profit || 0).toFixed(2)}
                                        </span>
                                    </td>
                                    <td style="padding: 14px 12px; text-align: center;">
                                        <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                                            <button onclick="editSale(${sale.id})" title="Edit Sale"
                                                style="background: #2196F3; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(33,150,243,0.3);"
                                                onmouseover="this.style.background='#1976D2'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(33,150,243,0.4)'"
                                                onmouseout="this.style.background='#2196F3'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(33,150,243,0.3)'"></button>
                                            <button onclick="deleteSale(${sale.id})" title="Delete Sale"
                                                style="background: #f44336; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(244,67,54,0.3);"
                                                onmouseover="this.style.background='#d32f2f'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(244,67,54,0.4)'"
                                                onmouseout="this.style.background='#f44336'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(244,67,54,0.3)'"></button>
                                        </div>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHTML;

            // Show/hide Load More button
            if (recentSales.length > displayedSalesCount) {
                loadMoreContainer.style.display = 'block';
                const remainingCount = recentSales.length - displayedSalesCount;
                document.getElementById('load-more-btn').innerHTML = ` Load More Sales (${remainingCount} remaining)`;
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        // Daily Sales Report variables
        let isDailyViewDetailed = false;

        // Update Daily Sales Report
        function updateDailySalesReport() {
            const dailyStats = calculateDailyStats();
            const contentDiv = document.getElementById('daily-sales-content');

            if (Object.keys(dailyStats).length === 0) {
                contentDiv.innerHTML = '<p>No daily sales data available.</p>';
                return;
            }

            // Always show detailed view
            contentDiv.innerHTML = generateDetailedDailyView(dailyStats);
        }

        // Calculate Daily Statistics
        function calculateDailyStats() {
            const dailyStats = {};

            salesData.forEach(sale => {
                const saleDate = sale.saleDate;

                if (!dailyStats[saleDate]) {
                    dailyStats[saleDate] = {
                        date: saleDate,
                        totalSales: 0,
                        totalRevenue: 0,
                        totalCost: 0,
                        totalProfit: 0,
                        categories: {},
                        customers: new Set(),
                        avgOrderValue: 0,
                        profitMargin: 0,
                        topCategory: '',
                        topCustomer: ''
                    };
                }

                const dayData = dailyStats[saleDate];
                dayData.totalSales++;
                dayData.totalRevenue += sale.sellingPrice;
                dayData.totalCost += sale.costPrice;
                dayData.totalProfit += sale.profit;
                dayData.customers.add(sale.customerName);

                // Category breakdown
                if (!dayData.categories[sale.category]) {
                    dayData.categories[sale.category] = {
                        count: 0,
                        revenue: 0,
                        profit: 0
                    };
                }
                dayData.categories[sale.category].count++;
                dayData.categories[sale.category].revenue += sale.sellingPrice;
                dayData.categories[sale.category].profit += sale.profit;
            });

            // Calculate derived stats
            Object.values(dailyStats).forEach(day => {
                day.avgOrderValue = day.totalRevenue / day.totalSales;
                day.profitMargin = (day.totalProfit / day.totalRevenue) * 100;
                day.uniqueCustomers = day.customers.size;

                // Find top category by revenue
                let topCategoryRevenue = 0;
                Object.entries(day.categories).forEach(([category, data]) => {
                    if (data.revenue > topCategoryRevenue) {
                        topCategoryRevenue = data.revenue;
                        day.topCategory = category;
                    }
                });
            });

            return dailyStats;
        }

        // Generate Compact Daily View
        function generateCompactDailyView(dailyStats) {
            const sortedDays = Object.values(dailyStats).sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentDays = sortedDays.slice(0, 7); // Show last 7 days

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${recentDays.map(day => `
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; cursor: pointer;" onclick="showDayDetails('${day.date}')">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                                <h5 style="margin: 0; font-size: 14px; opacity: 0.9;">${new Date(day.date).toLocaleDateString()}</h5>
                                <span style="font-size: 12px; opacity: 0.8;"></span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="font-size: 20px; font-weight: bold; margin-bottom: 2px;">${day.totalSales}</div>
                                <div style="font-size: 11px; opacity: 0.8;">Sales</div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="font-size: 16px; font-weight: bold; margin-bottom: 2px;">${day.totalRevenue.toFixed(0)}</div>
                                <div style="font-size: 11px; opacity: 0.8;">Revenue</div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="font-size: 14px; font-weight: bold; margin-bottom: 2px; color: ${day.profitMargin >= 20 ? '#4ade80' : day.profitMargin >= 10 ? '#fbbf24' : '#f87171'};">
                                    ${day.profitMargin.toFixed(1)}%
                                </div>
                                <div style="font-size: 11px; opacity: 0.8;">Profit Margin</div>
                            </div>
                            <div style="font-size: 11px; opacity: 0.7; margin-top: 8px;">
                                Top: ${day.topCategory}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${sortedDays.length > 7 ? `
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="showAllDays()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                             View All ${sortedDays.length} Days
                        </button>
                    </div>
                ` : ''}
            `;
        }

        // Generate Detailed Daily View
        function generateDetailedDailyView(dailyStats) {
            const sortedDays = Object.values(dailyStats).sort((a, b) => new Date(b.date) - new Date(a.date));

            return `
                <div style="max-height: 500px; overflow-y: auto;">
                    ${sortedDays.map(day => {
                        const salesForDay = salesData.filter(sale => sale.saleDate === day.date);

                        return `
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h5 style="margin: 0; font-size: 16px;">${new Date(day.date).toLocaleDateString('en-US', {
                                        weekday: 'long',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    })}</h5>
                                    <div style="font-size: 12px; opacity: 0.8;">
                                        ${day.totalSales} sales  ${day.totalRevenue.toFixed(0)} revenue  ${day.totalProfit.toFixed(0)} profit
                                    </div>
                                </div>

                                <!-- Individual Sales Records -->
                                <div style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 10px;">
                                    <h6 style="margin: 0 0 10px 0; font-size: 12px; opacity: 0.9;"> Sales Records:</h6>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        ${salesForDay.map((sale, index) => `
                                            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; font-size: 12px;">
                                                <div style="font-weight: bold;">
                                                    <div style="font-size: 13px; margin-bottom: 2px;">${sale.itemName}</div>
                                                    <div style="font-size: 10px; opacity: 0.8;"> ${sale.customerName}</div>
                                                </div>
                                                <div style="text-align: center;">
                                                    <div style="font-size: 10px; opacity: 0.8;">Category</div>
                                                    <div style="font-weight: bold;">${sale.category}</div>
                                                </div>
                                                <div style="text-align: center;">
                                                    <div style="font-size: 10px; opacity: 0.8;">Cost</div>
                                                    <div style="font-weight: bold;">${sale.costPrice.toFixed(0)}</div>
                                                </div>
                                                <div style="text-align: center;">
                                                    <div style="font-size: 10px; opacity: 0.8;">Selling</div>
                                                    <div style="font-weight: bold;">${sale.sellingPrice.toFixed(0)}</div>
                                                </div>
                                                <div style="text-align: center;">
                                                    <div style="font-size: 10px; opacity: 0.8;">Profit</div>
                                                    <div style="font-weight: bold; color: ${sale.profit >= 0 ? '#4ade80' : '#f87171'};">${sale.profit.toFixed(0)}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Toggle Daily Sales View (function kept for compatibility)
        function toggleDailySalesView() {
            // Function removed - always show detailed view
        }

        // Show specific day details (future enhancement)
        function showDayDetails(date) {
            const dailyStats = calculateDailyStats();
            const dayData = dailyStats[date];

            if (!dayData) return;

            const salesForDay = salesData.filter(sale => sale.saleDate === date);

            alert(` Sales Details for ${new Date(date).toLocaleDateString()}

 Summary:
 Total Sales: ${dayData.totalSales}
 Revenue: ${dayData.totalRevenue.toFixed(2)}
 Profit: ${dayData.totalProfit.toFixed(2)}
 Profit Margin: ${dayData.profitMargin.toFixed(1)}%
 Unique Customers: ${dayData.uniqueCustomers}
 Average Order Value: ${dayData.avgOrderValue.toFixed(2)}

 Categories:
${Object.entries(dayData.categories).map(([cat, data]) =>
` ${cat}: ${data.count} sales (${data.revenue.toFixed(2)})`
).join('\n')}

 Customers:
${[...dayData.customers].join(', ')}`);
        }

        // Show all days (future enhancement)
        function showAllDays() {
            isDailyViewDetailed = true;
            updateDailySalesReport();
            document.getElementById('daily-view-toggle').textContent = ' Compact View';
        }

        // Export Daily Sales Report
        function exportDailySalesReport() {
            if (salesData.length === 0) {
                alert('No sales data available to export!');
                return;
            }

            try {
                const dailyStats = calculateDailyStats();
                const sortedDays = Object.values(dailyStats).sort((a, b) => new Date(b.date) - new Date(a.date));

                // Prepare data for export
                const reportData = sortedDays.map(day => ({
                    'Date': new Date(day.date).toLocaleDateString(),
                    'Day of Week': new Date(day.date).toLocaleDateString('en-US', { weekday: 'long' }),
                    'Total Sales': day.totalSales,
                    'Total Revenue ()': day.totalRevenue.toFixed(2),
                    'Total Cost ()': day.totalCost.toFixed(2),
                    'Total Profit ()': day.totalProfit.toFixed(2),
                    'Profit Margin (%)': day.profitMargin.toFixed(2),
                    'Average Order Value ()': day.avgOrderValue.toFixed(2),
                    'Unique Customers': day.uniqueCustomers,
                    'Top Category': day.topCategory,
                    'Categories Count': Object.keys(day.categories).length
                }));

                // Create detailed category breakdown sheet
                const categoryData = [];
                sortedDays.forEach(day => {
                    Object.entries(day.categories).forEach(([category, data]) => {
                        categoryData.push({
                            'Date': new Date(day.date).toLocaleDateString(),
                            'Category': category,
                            'Sales Count': data.count,
                            'Revenue ()': data.revenue.toFixed(2),
                            'Profit ()': data.profit.toFixed(2),
                            'Avg Sale Value ()': (data.revenue / data.count).toFixed(2)
                        });
                    });
                });

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Add main daily report sheet
                const ws1 = XLSX.utils.json_to_sheet(reportData);
                XLSX.utils.book_append_sheet(wb, ws1, 'Daily Sales Summary');

                // Add category breakdown sheet
                const ws2 = XLSX.utils.json_to_sheet(categoryData);
                XLSX.utils.book_append_sheet(wb, ws2, 'Daily Category Breakdown');

                // Export file
                const fileName = `Daily_Sales_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert(' Daily Sales Report exported successfully!');

            } catch (error) {
                console.error('Error exporting daily sales report:', error);
                alert('Error exporting report: ' + error.message);
            }
        }

        // Delete sale
        function deleteSale(id) {
            if (confirm('Are you sure you want to delete this sale record?')) {
                salesData = salesData.filter(sale => sale.id !== id);
                localStorage.setItem('jewelrySales', JSON.stringify(salesData));
                loadSalesRecords();
                updateDashboard();
                loadCustomers();
                updateCustomerCount();

                // Update sales summary statistics
                updateSalesSummary();

                // Update sales summary table
                if (typeof loadSalesSummaryTable === 'function') {
                    loadSalesSummaryTable();
                }

                showSuccess('Sale record deleted successfully!');
            }
        }

        // Delete all sales
        function deleteAllSales() {
            if (salesData.length === 0) {
                showError('No sales records to delete!');
                return;
            }

            const salesCount = salesData.length;
            const totalValue = salesData.reduce((sum, sale) => sum + sale.sellingPrice, 0);
            const confirmMessage = `Are you sure you want to delete ALL ${salesCount} sales record${salesCount > 1 ? 's' : ''}?\n\nTotal value: ${totalValue.toFixed(2)}\n\nThis action cannot be undone!`;

            if (confirm(confirmMessage)) {
                const doubleConfirm = confirm(' FINAL WARNING: This will permanently delete all sales data!\n\nThis includes all profit calculations and customer purchase history.\n\nContinue?');
                if (doubleConfirm) {
                    const userInput = prompt('Type "DELETE ALL SALES" (exact text) to confirm deletion:');
                    if (userInput === 'DELETE ALL SALES') {
                        salesData = [];
                        localStorage.setItem('jewelrySales', JSON.stringify(salesData));
                        loadSalesRecords();
                        updateDashboard();
                        loadCustomers();

                        // Update sales summary statistics
                        updateSalesSummary();

                        // Update sales summary table
                        if (typeof loadSalesSummaryTable === 'function') {
                            loadSalesSummaryTable();
                        }

                        showSuccess(` All ${salesCount} sales record${salesCount > 1 ? 's' : ''} deleted successfully!`);
                    } else {
                        showError('Deletion cancelled. Type "DELETE ALL SALES" exactly to confirm.');
                    }
                } else {
                    showError('Deletion cancelled.');
                }
            }
        }

        // Edit sale functionality
        let currentEditingSaleId = null;

        function editSale(id) {
            // Check if another sale is being edited
            if (currentEditingSaleId && currentEditingSaleId !== id) {
                showError('Please finish editing the current sale before editing another one.');
                return;
            }

            const sale = salesData.find(s => s.id === id);
            if (!sale) {
                showError('Sale not found!');
                return;
            }

            const saleItem = document.getElementById(`sale-item-${id}`);
            if (!saleItem) {
                showError('Sale item not found in DOM!');
                return;
            }

            currentEditingSaleId = id;

            // Create edit form
            const editForm = `
                <div class="edit-form">
                    <h4> Edit Sale Record</h4>
                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label for="edit-itemName-${id}">Item Name *</label>
                            <input type="text" id="edit-itemName-${id}" value="${sale.itemName}" required>
                        </div>
                        <div class="edit-form-group">
                            <label for="edit-category-${id}">Category *</label>
                            <select id="edit-category-${id}" required>
                                <option value="Necklaces" ${sale.category === 'Necklaces' ? 'selected' : ''}>Necklaces</option>
                                <option value="Earrings" ${sale.category === 'Earrings' ? 'selected' : ''}>Earrings</option>
                                <option value="Bracelets" ${sale.category === 'Bracelets' ? 'selected' : ''}>Bracelets</option>
                                <option value="Rings" ${sale.category === 'Rings' ? 'selected' : ''}>Rings</option>
                                <option value="Anklets" ${sale.category === 'Anklets' ? 'selected' : ''}>Anklets</option>
                                <option value="Sets" ${sale.category === 'Sets' ? 'selected' : ''}>Sets</option>
                                <option value="Bangles" ${sale.category === 'Bangles' ? 'selected' : ''}>Bangles</option>
                                <option value="Chains" ${sale.category === 'Chains' ? 'selected' : ''}>Chains</option>
                            </select>
                        </div>
                    </div>
                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label for="edit-costPrice-${id}">Cost Price () *</label>
                            <input type="number" id="edit-costPrice-${id}" value="${sale.costPrice}" required min="0" step="0.01" oninput="calculateEditProfit(${id})">
                        </div>
                        <div class="edit-form-group">
                            <label for="edit-sellingPrice-${id}">Selling Price () *</label>
                            <input type="number" id="edit-sellingPrice-${id}" value="${sale.sellingPrice}" required min="0" step="0.01" oninput="calculateEditProfit(${id})">
                        </div>
                    </div>
                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label for="edit-profit-${id}">Profit ()</label>
                            <input type="number" id="edit-profit-${id}" value="${sale.profit}" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                        </div>
                        <div class="edit-form-group">
                            <label for="edit-saleDate-${id}">Sale Date *</label>
                            <input type="date" id="edit-saleDate-${id}" value="${sale.saleDate}" required>
                        </div>
                    </div>
                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label for="edit-customerName-${id}">Customer Name *</label>
                            <input type="text" id="edit-customerName-${id}" value="${sale.customerName}" required>
                        </div>
                        <div class="edit-form-group">
                            <label for="edit-customerPhone-${id}">Customer Phone</label>
                            <input type="tel" id="edit-customerPhone-${id}" value="${sale.customerPhone}">
                        </div>
                    </div>
                    <div class="edit-form-group">
                        <label for="edit-customerAddress-${id}">Customer Address</label>
                        <textarea id="edit-customerAddress-${id}" rows="2">${sale.customerAddress || ''}</textarea>
                    </div>
                    <div class="edit-form-buttons">
                        <button class="save-edit-btn" onclick="saveSaleEdit(${id})"> Save Changes</button>
                        <button class="cancel-edit-btn" onclick="cancelSaleEdit(${id})"> Cancel</button>
                    </div>
                </div>
            `;

            saleItem.innerHTML = editForm;

            // Scroll the edited item into view
            saleItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function calculateEditProfit(id) {
            const costPrice = parseFloat(document.getElementById(`edit-costPrice-${id}`).value) || 0;
            const sellingPrice = parseFloat(document.getElementById(`edit-sellingPrice-${id}`).value) || 0;
            const profit = sellingPrice - costPrice;
            document.getElementById(`edit-profit-${id}`).value = profit.toFixed(2);
        }

        function saveSaleEdit(id) {
            const itemName = document.getElementById(`edit-itemName-${id}`).value.trim();
            const category = document.getElementById(`edit-category-${id}`).value;
            const costPrice = parseFloat(document.getElementById(`edit-costPrice-${id}`).value);
            const sellingPrice = parseFloat(document.getElementById(`edit-sellingPrice-${id}`).value);
            const saleDate = document.getElementById(`edit-saleDate-${id}`).value;
            const customerName = document.getElementById(`edit-customerName-${id}`).value.trim();
            const customerPhone = document.getElementById(`edit-customerPhone-${id}`).value.trim();
            const customerAddress = document.getElementById(`edit-customerAddress-${id}`).value.trim();

            // Validation
            if (!itemName || !category || !costPrice || !sellingPrice || !saleDate || !customerName) {
                showError('Please fill in all required fields marked with *');
                return;
            }

            if (costPrice < 0 || sellingPrice < 0) {
                showError('Cost price and selling price must be positive numbers');
                return;
            }

            // Find and update the sale
            const saleIndex = salesData.findIndex(s => s.id === id);
            if (saleIndex === -1) {
                showError('Sale not found!');
                return;
            }

            const profit = sellingPrice - costPrice;

            // Update the sale data
            salesData[saleIndex] = {
                ...salesData[saleIndex],
                itemName,
                category,
                costPrice,
                sellingPrice,
                profit,
                saleDate,
                customerName,
                customerPhone: customerPhone || 'Not provided',
                customerAddress: customerAddress || 'Not provided'
            };

            // Save to localStorage
            localStorage.setItem('jewelrySales', JSON.stringify(salesData));

            // Reset editing state
            currentEditingSaleId = null;

            // Refresh displays
            loadSalesRecords();
            updateDashboard();
            loadCustomers();

            // Update sales summary statistics
            updateSalesSummary();

            // Update sales summary table
            if (typeof loadSalesSummaryTable === 'function') {
                loadSalesSummaryTable();
            }

            showSuccess('Sale record updated successfully!');
        }

        function cancelSaleEdit(id) {
            currentEditingSaleId = null;
            loadSalesRecords();
        }

        // Load more sales functionality
        function loadMoreSales() {
            displayedSalesCount += 20; // Load 20 more sales
            loadSalesRecords();

            // Smooth scroll to maintain position
            const loadMoreBtn = document.getElementById('load-more-btn');
            setTimeout(() => {
                loadMoreBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // Reset displayed sales count when needed
        function resetSalesDisplay() {
            displayedSalesCount = 20;
        }

        // Update dashboard
        function updateDashboard() {
            const totalSales = salesData.length;
            const totalRevenue = salesData.reduce((sum, sale) => sum + sale.sellingPrice, 0);
            const totalProfit = salesData.reduce((sum, sale) => sum + sale.profit, 0);
            const avgProfit = totalSales > 0 ? totalProfit / totalSales : 0;

            document.getElementById('total-sales').textContent = totalSales;
            document.getElementById('total-revenue').textContent = `${totalRevenue.toFixed(2)}`;
            document.getElementById('total-profit').textContent = `${totalProfit.toFixed(2)}`;
            document.getElementById('avg-profit').textContent = `${avgProfit.toFixed(2)}`;

            // Update charts
            updateCharts();

            loadMonthlySales();
        }

        // Update charts
        function updateCharts() {
            if (salesData.length === 0) {
                const ctx1 = document.getElementById('salesChart').getContext('2d');
                const ctx2 = document.getElementById('categoryChart').getContext('2d');

                ctx1.clearRect(0, 0, ctx1.canvas.width, ctx1.canvas.height);
                ctx2.clearRect(0, 0, ctx2.canvas.width, ctx2.canvas.height);

                ctx1.font = "20px Arial";
                ctx1.fillStyle = "#999";
                ctx1.textAlign = "center";
                ctx1.fillText("No sales data available", ctx1.canvas.width/2, ctx1.canvas.height/2);

                ctx2.font = "20px Arial";
                ctx2.fillStyle = "#999";
                ctx2.textAlign = "center";
                ctx2.fillText("No category data available", ctx2.canvas.width/2, ctx2.canvas.height/2);

                return;
            }

            try {
                // Sales trend chart
                const ctx1 = document.getElementById('salesChart').getContext('2d');
                const last7Days = [];
                const salesByDate = {};

                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    last7Days.push(dateStr);
                    salesByDate[dateStr] = 0;
                }

                salesData.forEach(sale => {
                    if (salesByDate.hasOwnProperty(sale.saleDate)) {
                        salesByDate[sale.saleDate] += sale.sellingPrice;
                    }
                });

                if (salesChart) salesChart.destroy();
                salesChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(date => new Date(date).toLocaleDateString()),
                        datasets: [{
                            label: 'Daily Sales ()',
                            data: last7Days.map(date => salesByDate[date]),
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Sales Trend (Last 7 Days)',
                                font: { size: 16 }
                            }
                        }
                    }
                });

                // Category chart
                const ctx2 = document.getElementById('categoryChart').getContext('2d');
                const categoryData = {};

                salesData.forEach(sale => {
                    categoryData[sale.category] = (categoryData[sale.category] || 0) + 1;
                });

                if (categoryChart) categoryChart.destroy();
                categoryChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categoryData),
                        datasets: [{
                            data: Object.values(categoryData),
                            backgroundColor: [
                                '#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731',
                                '#5f27cd', '#00d2d3', '#ff9ff3', '#54a0ff'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Sales by Category',
                                font: { size: 16 }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        // Add customer function
        function addCustomer() {
            try {
                const name = document.getElementById('newCustomerName').value.trim();
                const phone = document.getElementById('newCustomerPhone').value.trim();
                const address = document.getElementById('newCustomerAddress').value.trim();
                const email = document.getElementById('newCustomerEmail').value.trim();

                if (!name) {
                    showCustomerError('Please enter customer name');
                    return;
                }

                // Check if customer already exists
                const existingCustomer = customersData.find(customer =>
                    customer.name.toLowerCase() === name.toLowerCase()
                );

                if (existingCustomer) {
                    showCustomerError('Customer with this name already exists');
                    return;
                }

                // Create customer record
                const customerRecord = {
                    id: Date.now(),
                    name: name,
                    phone: phone || 'Not provided',
                    address: address || 'Not provided',
                    email: email || 'Not provided',
                    createdAt: new Date().toISOString()
                };

                // Add to array
                customersData.push(customerRecord);

                // Save to localStorage
                try {
                    localStorage.setItem('jewelryCustomers', JSON.stringify(customersData));
                } catch (storageError) {
                    showCustomerError('Error saving customer data: ' + storageError.message);
                    return;
                }

                // Clear form
                document.getElementById('customer-form').reset();

                // Refresh display
                loadCustomers();

                // Show success message
                showCustomerSuccess(' Customer added successfully!');

            } catch (error) {
                console.error('Error adding customer:', error);
                showCustomerError('Error adding customer: ' + error.message);
            }
        }

        // Show customer success message
        function showCustomerSuccess(message) {
            const successDiv = document.getElementById('customer-success-message');
            const errorDiv = document.getElementById('customer-error-message');

            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';

            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Show customer error message
        function showCustomerError(message) {
            const errorDiv = document.getElementById('customer-error-message');
            const successDiv = document.getElementById('customer-success-message');

            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';

            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        // Delete customer
        function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                customersData = customersData.filter(customer => customer.id !== id);
                localStorage.setItem('jewelryCustomers', JSON.stringify(customersData));
                loadCustomers();
                showCustomerSuccess('Customer deleted successfully!');
            }
        }

        // Delete all customers
        function deleteAllCustomers() {
            if (customersData.length === 0) {
                showCustomerError('No customers to delete!');
                return;
            }

            const customerCount = customersData.length;
            const confirmMessage = `Are you sure you want to delete ALL ${customerCount} customer${customerCount > 1 ? 's' : ''}?\n\nThis action cannot be undone!`;

            if (confirm(confirmMessage)) {
                const doubleConfirm = confirm(' FINAL WARNING: This will permanently delete all customer data!\n\nType "DELETE" in the next prompt to confirm.');
                if (doubleConfirm) {
                    const userInput = prompt('Type "DELETE" (in capital letters) to confirm deletion:');
                    if (userInput === 'DELETE') {
                        customersData = [];
                        localStorage.setItem('jewelryCustomers', JSON.stringify(customersData));
                        loadCustomers();
                        showCustomerSuccess(` All ${customerCount} customer${customerCount > 1 ? 's' : ''} deleted successfully!`);
                    } else {
                        showCustomerError('Deletion cancelled. Type "DELETE" exactly to confirm.');
                    }
                } else {
                    showCustomerError('Deletion cancelled.');
                }
            }
        }

        // Load customers with enhanced display
        function loadCustomers() {
            const countElement = document.getElementById('customers-count');
            countElement.textContent = customersData.length;

            // Reset pagination and filters when loading fresh data
            currentCustomerPage = 1;
            isCustomerSearchActive = false;
            filteredCustomers = [];

            // Clear search and sort inputs
            document.getElementById('customer-database-search').value = '';
            document.getElementById('customer-sort-select').value = 'name-asc';
            currentCustomerSort = 'name-asc';

            // Display the enhanced customer database
            displayCustomerDatabase();
        }

        // Download customers Excel report
        function downloadCustomersExcel() {
            if (customersData.length === 0) {
                showError('No customers to export! Please add some customers first.');
                return;
            }

            try {
                const customersWithStats = customersData.map(customer => {
                    const customerSales = salesData.filter(sale => sale.customerName === customer.name);
                    const totalPurchases = customerSales.length;
                    const totalSpent = customerSales.reduce((sum, sale) => sum + sale.sellingPrice, 0);
                    const lastPurchase = customerSales.length > 0 ?
                        new Date(Math.max(...customerSales.map(sale => new Date(sale.saleDate)))).toLocaleDateString() : 'Never';

                    return {
                        'Customer Name': customer.name,
                        'Phone': customer.phone || 'Not provided',
                        'Email': customer.email || 'Not provided',
                        'Address': customer.address || 'Not provided',
                        'Total Purchases': totalPurchases,
                        'Total Spent ()': totalSpent.toFixed(2),
                        'Average Order Value ()': totalPurchases > 0 ? (totalSpent / totalPurchases).toFixed(2) : 0,
                        'Last Purchase Date': lastPurchase,
                        'Customer Status': totalPurchases > 0 ? 'Active' : 'Inactive',
                        'Date Added': new Date(customer.createdAt).toLocaleDateString()
                    };
                });

                const ws = XLSX.utils.json_to_sheet(customersWithStats);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Customer Database');

                const fileName = `Customer_Database_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showSuccess(' Customer database exported successfully!');

            } catch (error) {
                console.error('Error exporting customers:', error);
                showError('Error exporting customer data: ' + error.message);
            }
        }

        // Delete all customers
        function deleteAllCustomers() {
            if (customersData.length === 0) {
                showError('No customers to delete!');
                return;
            }

            const customerCount = customersData.length;
            const confirmMessage = `Are you sure you want to delete ALL ${customerCount} customer${customerCount > 1 ? 's' : ''}?\n\nThis action cannot be undone!`;

            if (confirm(confirmMessage)) {
                const doubleConfirm = confirm(' FINAL WARNING: This will permanently delete all customer data!\n\nThis will NOT affect sales records, but customer search functionality will be limited.\n\nContinue?');
                if (doubleConfirm) {
                    const userInput = prompt('Type "DELETE ALL CUSTOMERS" (exact text) to confirm deletion:');
                    if (userInput === 'DELETE ALL CUSTOMERS') {
                        customersData = [];
                        localStorage.setItem('jewelryCustomers', JSON.stringify(customersData));
                        loadCustomers();
                        updateCustomerCount();
                        showSuccess(` All ${customerCount} customer${customerCount > 1 ? 's' : ''} deleted successfully!`);
                    } else {
                        showError('Deletion cancelled. Type "DELETE ALL CUSTOMERS" exactly to confirm.');
                    }
                } else {
                    showError('Deletion cancelled.');
                }
            }
        }

        // Download Excel
        function downloadExcel() {
            if (salesData.length === 0) {
                showError('No data to export! Please add some sales records first.');
                return;
            }

            try {
                const ws = XLSX.utils.json_to_sheet(salesData.map(sale => ({
                    'Item Name': sale.itemName,
                    'Category': sale.category,
                    'Cost Price ()': sale.costPrice,
                    'Selling Price ()': sale.sellingPrice,
                    'Profit ()': sale.profit,
                    'Sale Date': sale.saleDate,
                    'Customer Name': sale.customerName,
                    'Customer Phone': sale.customerPhone,
                    'Customer Address': sale.customerAddress,
                    'Created At': sale.createdAt
                })));

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Jewelry Sales');

                const fileName = `Jewelry_Sales_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showSuccess(' Excel report downloaded successfully!');

            } catch (error) {
                console.error('Error downloading Excel:', error);
                showError('Error downloading Excel file: ' + error.message);
            }
        }

        // Download customers Excel
        function downloadCustomersExcel() {
            if (customersData.length === 0) {
                showCustomerError('No customers to export! Please add some customers first.');
                return;
            }

            try {
                // Calculate purchase statistics for each customer
                const customersWithStats = customersData.map(customer => {
                    let totalPurchases = 0;
                    let totalSpent = 0;
                    let lastPurchase = 'No purchases';

                    // Check sales data for this customer
                    salesData.forEach(sale => {
                        if (sale.customerName.toLowerCase() === customer.name.toLowerCase()) {
                            totalPurchases++;
                            totalSpent += sale.sellingPrice;
                            if (lastPurchase === 'No purchases' || sale.saleDate > lastPurchase) {
                                lastPurchase = sale.saleDate;
                            }
                        }
             });

                    return {
                               'Customer Name': customer.name,
                        'Phone': customer.phone,
                        'Address': customer.address,
                        'Email': customer.email,
                        'Total Purchases': totalPurchases,
                        'Total Spent ()': totalSpent.toFixed(2),
                        'Last Purchase Date': lastPurchase,
                        'Date Added': new Date(customer.createdAt).toLocaleDateString()
                    };
                });

                const ws = XLSX.utils.json_to_sheet(customersWithStats);

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Customers');

                const fileName = `Jewelry_Customers_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showCustomerSuccess(' Customer list exported successfully!');

            } catch (error) {
                console.error('Error downloading customers Excel:', error);
                showCustomerError('Error downloading Excel file: ' + error.message);
            }
        }

        // Load Monthly Sales
        function loadMonthlySales() {
            const container = document.getElementById('monthly-sales-list');

            if (salesData.length === 0) {
                container.innerHTML = '<div class="no-data" style="text-align: center; padding: 40px; color: #666; font-style: italic;">No sales data available. Add some sales records to see monthly breakdown.</div>';
                return;
            }

            // Calculate monthly statistics
            const monthlyStats = {};

            salesData.forEach(sale => {
                const date = new Date(sale.saleDate);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = {
                        month: monthKey,
                        monthName: date.toLocaleString('default', { month: 'long', year: 'numeric' }),
                        totalSales: 0,
                        totalRevenue: 0,
                        totalCost: 0,
                        totalProfit: 0,
                        avgOrderValue: 0,
                        profitMargin: 0,
                        topCategory: {},
                        topCustomer: {},
                        salesByCategory: {},
                        dailySales: {}
                    };
                }

                const month = monthlyStats[monthKey];
                month.totalSales++;
                month.totalRevenue += sale.sellingPrice;
                month.totalCost += sale.costPrice;
                month.totalProfit += sale.profit;

                // Track categories
                if (!month.salesByCategory[sale.category]) {
                    month.salesByCategory[sale.category] = 0;
                }
                month.salesByCategory[sale.category]++;

                if (!month.topCategory[sale.category]) {
                    month.topCategory[sale.category] = 0;
                }
                month.topCategory[sale.category]++;

                // Track customers
                if (!month.topCustomer[sale.customerName]) {
                    month.topCustomer[sale.customerName] = 0;
                }
                month.topCustomer[sale.customerName]++;

                // Track daily sales
                const dayKey = sale.saleDate;
                if (!month.dailySales[dayKey]) {
                    month.dailySales[dayKey] = 0;
                }
                month.dailySales[dayKey]++;
            });

            // Process final calculations
            Object.values(monthlyStats).forEach(month => {
                month.avgOrderValue = month.totalRevenue / month.totalSales;
                month.profitMargin = (month.totalProfit / month.totalRevenue) * 100;

                // Find top category
                let maxCategoryCount = 0;
                let topCategoryName = 'N/A';
                Object.entries(month.topCategory).forEach(([category, count]) => {
                    if (count > maxCategoryCount) {
                        maxCategoryCount = count;
                        topCategoryName = category;
                    }
                });
                month.topCategoryName = topCategoryName;
                month.topCategoryCount = maxCategoryCount;

                // Find top customer
                let maxCustomerCount = 0;
                let topCustomerName = 'N/A';
                Object.entries(month.topCustomer).forEach(([customer, count]) => {
                    if (count > maxCustomerCount) {
                        maxCustomerCount = count;
                        topCustomerName = customer;
                    }
                });
                month.topCustomerName = topCustomerName;
                month.topCustomerCount = maxCustomerCount;

                // Find best sales day
                let maxDayCount = 0;
                let bestSalesDay = 'N/A';
                Object.entries(month.dailySales).forEach(([day, count]) => {
                    if (count > maxDayCount) {
                        maxDayCount = count;
                        bestSalesDay = day;
                    }
                });
                month.bestSalesDay = bestSalesDay;
                month.bestSalesDayCount = maxDayCount;
            });

            // Sort by month (newest first)
            const sortedMonths = Object.values(monthlyStats).sort((a, b) => b.month.localeCompare(a.month));

            container.innerHTML = sortedMonths.map((month, index) => `
                <div class="customer-item" style="margin-bottom: 25px; border: 1px solid #ddd; padding: 20px; border-radius: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #2c3e50; margin: 0;"> ${month.monthName}</h4>
                        <span style="background: ${index === 0 ? '#28a745' : '#6c757d'}; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                            ${index === 0 ? 'LATEST' : `${index + 1} MONTHS AGO`}
                        </span>
                    </div>

                    <!-- Key Metrics Row -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #007bff;">${month.totalSales}</div>
                            <div style="color: #6c757d; font-size: 12px;">Total Sales</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: #28a745;">${month.totalRevenue.toFixed(2)}</div>
                            <div style="color: #6c757d; font-size: 12px;">Total Revenue</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: ${month.totalProfit >= 0 ? '#28a745' : '#dc3545'};">${month.totalProfit.toFixed(2)}</div>
                            <div style="color: #6c757d; font-size: 12px;">Total Profit</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 18px; font-weight: bold; color: #17a2b8;">${month.profitMargin.toFixed(1)}%</div>
                            <div style="color: #6c757d; font-size: 12px;">Profit Margin</div>
                        </div>
                    </div>

                    <!-- Additional Details -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <p><strong> Average Order Value:</strong> ${month.avgOrderValue.toFixed(2)}</p>
                            <p><strong> Top Category:</strong> ${month.topCategoryName} (${month.topCategoryCount} sales)</p>
                        </div>
                        <div>
                            <p><strong> Top Customer:</strong> ${month.topCustomerName} (${month.topCustomerCount} purchases)</p>
                            <p><strong> Best Sales Day:</strong> ${new Date(month.bestSalesDay).toLocaleDateString()} (${month.bestSalesDayCount} sales)</p>
                        </div>
                    </div>

                    <!-- Performance Indicator -->
                    <div style="margin-top: 15px; padding: 12px; background: ${month.profitMargin > 20 ? '#d4edda' : month.profitMargin > 10 ? '#fff3cd' : '#f8d7da'}; border-radius: 8px; border-left: 4px solid ${month.profitMargin > 20 ? '#28a745' : month.profitMargin > 10 ? '#ffc107' : '#dc3545'};">
                        <strong>Performance:</strong>
                        ${month.profitMargin > 20 ? ' Excellent Month!' :
                          month.profitMargin > 10 ? ' Good Performance' :
                          ' Needs Improvement'}
                        ${month.totalSales > 10 ? '  High Volume' : month.totalSales > 5 ? '  Medium Volume' : '  Low Volume'}
                    </div>
                </div>
            `).join('');
        }

        // Download Monthly Sales Report
        function downloadMonthlySales() {
            if (salesData.length === 0) {
                alert('No sales data available for monthly report!');
                return;
            }

            try {
                // Calculate monthly statistics (same logic as loadMonthlySales)
                const monthlyStats = {};

                salesData.forEach(sale => {
                    const date = new Date(sale.saleDate);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyStats[monthKey]) {
                        monthlyStats[monthKey] = {
                            month: monthKey,
                            monthName: date.toLocaleString('default', { month: 'long', year: 'numeric' }),
                            totalSales: 0,
                            totalRevenue: 0,
                            totalCost: 0,
                            totalProfit: 0,
                            topCategory: {},
                            topCustomer: {}
                        };
                    }

                    const month = monthlyStats[monthKey];
                    month.totalSales++;
                    month.totalRevenue += sale.sellingPrice;
                    month.totalCost += sale.costPrice;
                    month.totalProfit += sale.profit;

                    if (!month.topCategory[sale.category]) {
                        month.topCategory[sale.category] = 0;
                    }
                    month.topCategory[sale.category]++;

                    if (!month.topCustomer[sale.customerName]) {
                        month.topCustomer[sale.customerName] = 0;
                    }
                    month.topCustomer[sale.customerName]++;
                });

                // Process final calculations
                Object.values(monthlyStats).forEach(month => {
                    month.avgOrderValue = month.totalRevenue / month.totalSales;
                    month.profitMargin = (month.totalProfit / month.totalRevenue) * 100;


                    let maxCategoryCount = 0;
                    let topCategoryName = 'N/A';
                    Object.entries(month.topCategory).forEach(([category, count]) => {
                        if (count > maxCategoryCount) {
                            maxCategoryCount = count;
                            topCategoryName = category;
                        }
                    });
                    month.topCategoryName = topCategoryName;
                    month.topCategoryCount = maxCategoryCount;

                    // Find top customer
                    let maxCustomerCount = 0;
                    let topCustomerName = 'N/A';
                    Object.entries(month.topCustomer).forEach(([customer, count]) => {
                        if (count > maxCustomerCount) {
                            maxCustomerCount = count;
                            topCustomerName = customer;
                        }
                    });
                    month.topCustomerName = topCustomerName;
                    month.topCustomerCount = maxCustomerCount;
                });

                // Sort by month (newest first)
                const sortedMonths = Object.values(monthlyStats).sort((a, b) => b.month.localeCompare(a.month));

                // Prepare data for Excel
                const monthlyData = sortedMonths.map(month => ({
                    'Month': month.monthName,
                    'Total Sales': month.totalSales,
                    'Total Revenue ()': month.totalRevenue.toFixed(2),
                    'Total Cost ()': month.totalCost.toFixed(2),
                    'Total Profit ()': month.totalProfit.toFixed(2),
                    'Profit Margin (%)': month.profitMargin.toFixed(1),
                    'Average Order Value ()': month.avgOrderValue.toFixed(2),
                    'Top Category': month.topCategoryName,
                    'Top Category Sales': month.topCategoryCount,
                    'Top Customer': month.topCustomerName,
                    'Top Customer Purchases': month.topCustomerCount,
                    'Performance Status': month.profitMargin > 20 ? 'Excellent' :
                                         month.profitMargin > 10 ? 'Good' :
                                         'Needs Improvement'
                }));

                const ws = XLSX.utils.json_to_sheet(monthlyData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Monthly Sales Report');

                const fileName = `Monthly_Sales_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert(' Monthly Sales Report exported successfully!');

            } catch (error) {
                console.error('Error downloading monthly sales report:', error);
                alert('Error downloading monthly report: ' + error.message);
            }
        }

        // Load Analytics
        function loadAnalytics() {
            loadCustomerAnalytics();
            loadCategoryAnalytics();
            loadSalesTrends();
        }

        // Load Customer Analytics
        function loadCustomerAnalytics() {
            const container = document.getElementById('customer-analytics-list');

            if (salesData.length === 0) {
                container.innerHTML = '<div class="no-data">No sales data available for customer analytics.</div>';
                return;
            }

            // Calculate customer analytics
            const customerStats = {};

            salesData.forEach(sale => {
                const customerName = sale.customerName;
                if (!customerStats[customerName]) {
                    customerStats[customerName] = {
                        name: customerName,
                        phone: sale.customerPhone,
                        address: sale.customerAddress,
                        totalPurchases: 0,
                        totalSpent: 0,
                        lastPurchaseDate: null,
                        firstPurchaseDate: null,
                        purchaseDates: [],
                        avgOrderValue: 0,
                        favoriteCategory: {},
                        daysSinceLastPurchase: 0
                    };
                }

                const customer = customerStats[customerName];
                customer.totalPurchases++;
                customer.totalSpent += sale.sellingPrice;
                customer.purchaseDates.push(sale.saleDate);

                // Track categories
                if (!customer.favoriteCategory[sale.category]) {
                    customer.favoriteCategory[sale.category] = 0;
                }
                customer.favoriteCategory[sale.category]++;

                // Update dates
                if (!customer.lastPurchaseDate || sale.saleDate > customer.lastPurchaseDate) {
                    customer.lastPurchaseDate = sale.saleDate;
                }
                if (!customer.firstPurchaseDate || sale.saleDate < customer.firstPurchaseDate) {
                    customer.firstPurchaseDate = sale.saleDate;
                }
            });

            // Process final calculations
            Object.values(customerStats).forEach(customer => {
                customer.avgOrderValue = customer.totalSpent / customer.totalPurchases;

                // Find favorite category
                let maxCount = 0;
                let favCategory = 'N/A';
                Object.entries(customer.favoriteCategory).forEach(([category, count]) => {
                    if (count > maxCount) {
                        maxCount = count;
                        favCategory = category;
                    }
                });
                customer.favoriteCategory = favCategory;

                // Calculate days since last purchase
                if (customer.lastPurchaseDate) {
                    const lastDate = new Date(customer.lastPurchaseDate);
                    const today = new Date();
                    customer.daysSinceLastPurchase = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                }
            });

            // Sort by total spent (highest first)
            const sortedCustomers = Object.values(customerStats).sort((a, b) => b.totalSpent - a.totalSpent);

            container.innerHTML = sortedCustomers.map(customer => `
                <div class="customer-item" style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                    <h4> ${customer.name}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-top: 10px;">
                        <p><strong> Phone:</strong> ${customer.phone}</p>
                        <p><strong> Total Purchases:</strong> ${customer.totalPurchases}</p>
                        <p><strong> Total Spent:</strong> ${customer.totalSpent.toFixed(2)}</p>
                        <p><strong> Avg Order Value:</strong> ${customer.avgOrderValue.toFixed(2)}</p>
                        <p><strong> Last Purchase:</strong> ${new Date(customer.lastPurchaseDate).toLocaleDateString()}</p>
                        <p><strong> Days Since Last Purchase:</strong> ${customer.daysSinceLastPurchase} days</p>
                        <p><strong> Favorite Category:</strong> ${customer.favoriteCategory}</p>
                        <p><strong> Customer Since:</strong> ${new Date(customer.firstPurchaseDate).toLocaleDateString()}</p>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: ${customer.daysSinceLastPurchase > 30 ? '#fff3cd' : customer.daysSinceLastPurchase > 7 ? '#d1ecf1' : '#d4edda'}; border-radius: 5px;">
                        <strong>Status:</strong>
                        ${customer.daysSinceLastPurchase > 30 ? ' Inactive Customer (30+ days)' :
                          customer.daysSinceLastPurchase > 7 ? ' Needs Attention (7+ days)' :
                          ' Active Customer'}
                    </div>
                </div>
            `).join('');
        }

        // Load Category Analytics
        function loadCategoryAnalytics() {
            const container = document.getElementById('category-analytics-list');

            if (salesData.length === 0) {
                container.innerHTML = '<div class="no-data">No sales data available for category analytics.</div>';
                return;
            }

            // Calculate category statistics
            const categoryStats = {};

            salesData.forEach(sale => {
                if (!categoryStats[sale.category]) {
                    categoryStats[sale.category] = {
                        category: sale.category,
                        totalSales: 0,
                        totalRevenue: 0,
                        totalProfit: 0,
                        avgSellingPrice: 0,
                        avgProfit: 0,
                        items: []
                    };
                }

                const cat = categoryStats[sale.category];
                cat.totalSales++;
                cat.totalRevenue += sale.sellingPrice;
                cat.totalProfit += sale.profit;
                cat.items.push(sale.itemName);
            });

            // Calculate averages and percentages
            const totalSales = salesData.length;
            const totalRevenue = salesData.reduce((sum, sale) => sum + sale.sellingPrice, 0);

            Object.values(categoryStats).forEach(cat => {
                cat.avgSellingPrice = cat.totalRevenue / cat.totalSales;
                cat.avgProfit = cat.totalProfit / cat.totalSales;
                cat.salesPercentage = (cat.totalSales / totalSales) * 100;
                cat.revenuePercentage = (cat.totalRevenue / totalRevenue) * 100;
            });

            // Sort by total sales (highest first)
            const sortedCategories = Object.values(categoryStats).sort((a, b) => b.totalSales - a.totalSales);

            container.innerHTML = sortedCategories.map((cat, index) => `
                <div class="customer-item" style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <h4>${index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : ''} ${cat.category}</h4>
                        <span style="background: ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#e9ecef'}; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                            Rank #${index + 1}
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <p><strong> Total Sales:</strong> ${cat.totalSales} (${cat.salesPercentage.toFixed(1)}%)</p>
                        <p><strong> Total Revenue:</strong> ${cat.totalRevenue.toFixed(2)} (${cat.revenuePercentage.toFixed(1)}%)</p>
                        <p><strong> Total Profit:</strong> ${cat.totalProfit.toFixed(2)}</p>
                        <p><strong> Avg Selling Price:</strong> ${cat.avgSellingPrice.toFixed(2)}</p>
                        <p><strong> Avg Profit per Item:</strong> ${cat.avgProfit.toFixed(2)}</p>
                        <p><strong> Profit Margin:</strong> ${((cat.avgProfit / cat.avgSellingPrice) * 100).toFixed(1)}%</p>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>Demand Level:</strong>
                        ${cat.salesPercentage > 30 ? ' Very High Demand' :
                          cat.salesPercentage > 20 ? ' High Demand' :
                          cat.salesPercentage > 10 ? ' Medium Demand' :
                          ' Low Demand'}
                    </div>
                </div>
            `).join('');
        }

        // Load Sales Trends
        function loadSalesTrends() {
            const container = document.getElementById('sales-trends-list');

            if (salesData.length === 0) {
                container.innerHTML = '<div class="no-data">No sales data available for trends analysis.</div>';
                return;
            }

            // Monthly trends
            const monthlyStats = {};
            const dailyStats = {};

            salesData.forEach(sale => {
                const date = new Date(sale.saleDate);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const dayKey = sale.saleDate;

                // Monthly stats
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = {
                        month: monthKey,
                        sales: 0,
                        revenue: 0,
                        profit: 0
                    };
                }
                monthlyStats[monthKey].sales++;
                monthlyStats[monthKey].revenue += sale.sellingPrice;
                monthlyStats[monthKey].profit += sale.profit;

                // Daily stats
                if (!dailyStats[dayKey]) {
                    dailyStats[dayKey] = {
                        date: dayKey,
                        sales: 0,
                        revenue: 0,
                        profit: 0
                    };
                }
                dailyStats[dayKey].sales++;
                dailyStats[dayKey].revenue += sale.sellingPrice;
                dailyStats[dayKey].profit += sale.profit;
            });

            // Sort monthly and daily data
            const sortedMonthly = Object.values(monthlyStats).sort((a, b) => b.month.localeCompare(a.month));
            const sortedDaily = Object.values(dailyStats).sort((a, b) => b.date.localeCompare(a.date)).slice(0, 10);

            container.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h4> Monthly Trends</h4>
                    ${sortedMonthly.map(month => `
                        <div style="padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                            <strong>${new Date(month.month + '-01').toLocaleString('default', { month: 'long', year: 'numeric' })}</strong><br>
                            Sales: ${month.sales} | Revenue: ${month.revenue.toFixed(2)} | Profit: ${month.profit.toFixed(2)}
                        </div>
                    `).join('')}
                </div>

                <div>
                    <h4> Top 10 Sales Days</h4>
                    ${sortedDaily.map((day, index) => `
                        <div style="padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                            <strong>#${index + 1} - ${new Date(day.date).toLocaleDateString()}</strong><br>
                            Sales: ${day.sales} | Revenue: ${day.revenue.toFixed(2)} | Profit: ${day.profit.toFixed(2)}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Download Customer Analytics
        function downloadCustomerAnalytics() {
            if (salesData.length === 0) {
                alert('No sales data available for customer analytics!');
                return;
            }

            try {
                // Calculate customer analytics (same logic as loadCustomerAnalytics)
                const customerStats = {};

                salesData.forEach(sale => {
                    const customerName = sale.customerName;
                    if (!customerStats[customerName]) {
                        customerStats[customerName] = {
                            name: customerName,
                            phone: sale.customerPhone,
                            totalPurchases: 0,
                            totalSpent: 0,
                            lastPurchaseDate: null,
                            firstPurchaseDate: null,
                            avgOrderValue: 0,
                            favoriteCategory: {},
                            daysSinceLastPurchase: 0
                        };
                    }

                    const customer = customerStats[customerName];
                    customer.totalPurchases++;
                    customer.totalSpent += sale.sellingPrice;

                    if (!customer.favoriteCategory[sale.category]) {
                        customer.favoriteCategory[sale.category] = 0;
                    }
                    customer.favoriteCategory[sale.category]++;

                    if (!customer.lastPurchaseDate || sale.saleDate > customer.lastPurchaseDate) {
                        customer.lastPurchaseDate = sale.saleDate;
                    }
                    if (!customer.firstPurchaseDate || sale.saleDate < customer.firstPurchaseDate) {
                        customer.firstPurchaseDate = sale.saleDate;
                    }
                });

                // Process final calculations
                Object.values(customerStats).forEach(customer => {
                    customer.avgOrderValue = customer.totalSpent / customer.totalPurchases;

                    let maxCount = 0;
                    let favCategory = 'N/A';
                    Object.entries(customer.favoriteCategory).forEach(([category, count]) => {
                        if (count > maxCount) {
                            maxCount = count;
                            favCategory = category;
                        }
                    });
                    customer.favoriteCategory = favCategory;

                    if (customer.lastPurchaseDate) {
                        const lastDate = new Date(customer.lastPurchaseDate);
                        const today = new Date();
                        customer.daysSinceLastPurchase = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                    }
                });

                const sortedCustomers = Object.values(customerStats).sort((a, b) => b.totalSpent - a.totalSpent);

                const analyticsData = sortedCustomers.map(customer => ({
                    'Customer Name': customer.name,
                    'Phone': customer.phone,
                    'Total Purchases': customer.totalPurchases,
                    'Total Spent ()': customer.totalSpent.toFixed(2),
                    'Average Order Value ()': customer.avgOrderValue.toFixed(2),
                    'Last Purchase Date': customer.lastPurchaseDate,
                    'Days Since Last Purchase': customer.daysSinceLastPurchase,
                    'Favorite Category': customer.favoriteCategory,
                    'Customer Since': customer.firstPurchaseDate,
                    'Status': customer.daysSinceLastPurchase > 30 ? 'Inactive (30+ days)' :
                             customer.daysSinceLastPurchase > 7 ? 'Needs Attention (7+ days)' :
                             'Active Customer'
                }));

                const ws = XLSX.utils.json_to_sheet(analyticsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Customer Analytics');

                const fileName = `Customer_Analytics_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert(' Customer Analytics exported successfully!');

            } catch (error) {
                console.error('Error downloading customer analytics:', error);
                alert('Error downloading analytics: ' + error.message);
            }
        }

        // Download Category Analytics
        function downloadCategoryAnalytics() {
            if (salesData.length === 0) {
                alert('No sales data available for category analytics!');
                return;
            }

            try {
                const categoryStats = {};

                salesData.forEach(sale => {
                    if (!categoryStats[sale.category]) {
                        categoryStats[sale.category] = {
                            category: sale.category,
                            totalSales: 0,
                            totalRevenue: 0,
                            totalProfit: 0
                        };
                    }

                    const cat = categoryStats[sale.category];
                    cat.totalSales++;
                    cat.totalRevenue += sale.sellingPrice;
                    cat.totalProfit += sale.profit;
                });

                const totalSales = salesData.length;
                const totalRevenue = salesData.reduce((sum, sale) => sum + sale.sellingPrice, 0);

                Object.values(categoryStats).forEach(cat => {
                    cat.avgSellingPrice = cat.totalRevenue / cat.totalSales;
                    cat.avgProfit = cat.totalProfit / cat.totalSales;
                    cat.salesPercentage = (cat.totalSales / totalSales) * 100;
                    cat.revenuePercentage = (cat.totalRevenue / totalRevenue) * 100;
                });

                const sortedCategories = Object.values(categoryStats).sort((a, b) => b.totalSales - a.totalSales);

                const analyticsData = sortedCategories.map((cat, index) => ({
                    'Rank': index + 1,
                    'Category': cat.category,
                    'Total Sales': cat.totalSales,
                    'Sales Percentage': cat.salesPercentage.toFixed(1) + '%',
                    'Total Revenue ()': cat.totalRevenue.toFixed(2),
                    'Revenue Percentage': cat.revenuePercentage.toFixed(1) + '%',
                    'Total Profit ()': cat.totalProfit.toFixed(2),
                    'Average Selling Price ()': cat.avgSellingPrice.toFixed(2),
                    'Average Profit ()': cat.avgProfit.toFixed(2),
                    'Profit Margin': ((cat.avgProfit / cat.avgSellingPrice) * 100).toFixed(1) + '%',
                    'Demand Level': cat.salesPercentage > 30 ? 'Very High Demand' :
                                   cat.salesPercentage > 20 ? 'High Demand' :
                                   cat.salesPercentage > 10 ? 'Medium Demand' :
                                   'Low Demand'
                }));

                const ws = XLSX.utils.json_to_sheet(analyticsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Category Analytics');

                const fileName = `Category_Analytics_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert(' Category Analytics exported successfully!');

            } catch (error) {
                console.error('Error downloading category analytics:', error);
                alert('Error downloading analytics: ' + error.message);
            }
        }

        // Download Sales Trends
        function downloadSalesTrends() {
            if (salesData.length === 0) {
                alert('No sales data available for trends analysis!');
                return;
            }

            try {
                const monthlyStats = {};
                const dailyStats = {};

                salesData.forEach(sale => {
                    const date = new Date(sale.saleDate);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const dayKey = sale.saleDate;

                    if (!monthlyStats[monthKey]) {
                        monthlyStats[monthKey] = { month: monthKey, sales: 0, revenue: 0, profit: 0 };
                    }
                    monthlyStats[monthKey].sales++;
                    monthlyStats[monthKey].revenue += sale.sellingPrice;
                    monthlyStats[monthKey].profit += sale.profit;

                    if (!dailyStats[dayKey]) {
                        dailyStats[dayKey] = { date: dayKey, sales: 0, revenue: 0, profit: 0 };
                    }
                    dailyStats[dayKey].sales++;
                    dailyStats[dayKey].revenue += sale.sellingPrice;
                    dailyStats[dayKey].profit += sale.profit;
                });

                // Create workbook with multiple sheets
                const wb = XLSX.utils.book_new();

                // Monthly trends sheet
                const monthlyData = Object.values(monthlyStats).sort((a, b) => b.month.localeCompare(a.month)).map(month => ({
                    'Month': new Date(month.month + '-01').toLocaleString('default', { month: 'long', year: 'numeric' }),
                    'Total Sales': month.sales,
                    'Total Revenue ()': month.revenue.toFixed(2),
                    'Total Profit ()': month.profit.toFixed(2),
                    'Average Revenue per Sale ()': (month.revenue / month.sales).toFixed(2),
                    'Average Profit per Sale ()': (month.profit / month.sales).toFixed(2)
                }));

                const monthlyWs = XLSX.utils.json_to_sheet(monthlyData);
                XLSX.utils.book_append_sheet(wb, monthlyWs, 'Monthly Trends');

                // Daily trends sheet (top performing days)
                const dailyData = Object.values(dailyStats).sort((a, b) => b.revenue - a.revenue).slice(0, 30).map((day, index) => ({
                    'Rank': index + 1,
                    'Date': new Date(day.date).toLocaleDateString(),
                    'Total Sales': day.sales,
                    'Total Revenue ()': day.revenue.toFixed(2),
                    'Total Profit ()': day.profit.toFixed(2),
                    'Average Revenue per Sale ()': (day.revenue / day.sales).toFixed(2)
                }));

                const dailyWs = XLSX.utils.json_to_sheet(dailyData);
                XLSX.utils.book_append_sheet(wb, dailyWs, 'Top 30 Sales Days');

                const fileName = `Sales_Trends_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert(' Sales Trends exported successfully!');

            } catch (error) {
                console.error('Error downloading sales trends:', error);
                alert('Error downloading trends: ' + error.message);
            }
        }

        // Mobile-friendly alert function
        function mobileAlert(title, message, type = 'info') {
            // For now, use native alert but this can be enhanced with custom modal
            if (type === 'error') {
                alert(' ' + title + '\n\n' + message);
            } else if (type === 'success') {
                alert(' ' + title + '\n\n' + message);
            } else if (type === 'warning') {
                alert(' ' + title + '\n\n' + message);
            } else {
                alert(' ' + title + '\n\n' + message);
            }
        }



        // ======== PURCHASE HISTORY FUNCTIONS ========

        // Purchase history data
        let purchaseData = [];

        // Initialize purchase data from localStorage
        function initializePurchaseData() {
            const savedPurchases = localStorage.getItem('jewelryPurchases');
            if (savedPurchases) {
                purchaseData = JSON.parse(savedPurchases);
            } else {
                purchaseData = [];
            }
        }

        // Save purchase data to localStorage
        function savePurchaseData() {
            localStorage.setItem('jewelryPurchases', JSON.stringify(purchaseData));
        }

        // Toggle purchase history section
        function togglePurchaseSection() {
            const container = document.getElementById('purchase-content-container');
            const toggleBtn = document.getElementById('purchase-toggle-btn');

            if (container.classList.contains('collapsed')) {
                container.classList.remove('collapsed');
                toggleBtn.title = 'Collapse Purchase History';
                container.classList.add('expanded');
                toggleBtn.textContent = '';
                toggleBtn.classList.remove('collapsed');
                loadPurchaseHistory();
            } else {
                container.classList.remove('expanded');
                container.classList.add('collapsed');
                toggleBtn.title = 'Expand Purchase History';
                toggleBtn.textContent = '';
                toggleBtn.classList.add('collapsed');
            }
        }

        // Load and display purchase history
        function loadPurchaseHistory() {
            initializePurchaseData();
            updatePurchaseSummary();
            displayPurchaseRecords();
            updatePurchaseCount();
        }

        // Update purchase summary statistics
        function updatePurchaseSummary() {
            const totalPurchases = purchaseData.length;
            const totalPurchaseCost = purchaseData.reduce((sum, item) => sum + item.purchaseCost, 0);
            const totalSellingValue = purchaseData.reduce((sum, item) => sum + item.sellingPrice, 0);
            const potentialProfit = totalSellingValue - totalPurchaseCost;

            document.getElementById('summary-total-purchases').textContent = totalPurchases;
            document.getElementById('summary-total-purchase-cost').textContent = `${totalPurchaseCost.toFixed(2)}`;
            document.getElementById('summary-total-selling-value').textContent = `${totalSellingValue.toFixed(2)}`;
            document.getElementById('summary-potential-profit').textContent = `${potentialProfit.toFixed(2)}`;
        }

        // Update purchase count
        function updatePurchaseCount() {
            document.getElementById('purchase-count').textContent = purchaseData.length;
        }

        // Display purchase records
        function displayPurchaseRecords() {
            const container = document.getElementById('purchase-records');
            const noDataMessage = document.getElementById('no-purchase-message');

            if (purchaseData.length === 0) {
                container.innerHTML = '';
                noDataMessage.style.display = 'block';
                return;
            }

            noDataMessage.style.display = 'none';

            // Sort by purchase date (newest first)
            const sortedPurchases = [...purchaseData].sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate));

            container.innerHTML = sortedPurchases.map((item, index) => {
                const profitMargin = ((item.sellingPrice - item.purchaseCost) / item.sellingPrice * 100).toFixed(1);
                const profit = item.sellingPrice - item.purchaseCost;
                const profitColor = profit >= 0 ? '#10B981' : '#EF4444';
                const statusColor = item.status === 'sold' ? '#10B981' : item.status === 'reserved' ? '#F59E0B' : '#6B7280';

                return `
                    <div class="purchase-record-item">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h4 style="color: #333; margin: 0 0 5px 0; font-size: 16px;">${item.itemName}</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                    <span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                                        ${getCategoryIcon(item.category)} ${item.category}
                                    </span>
                                    <span style="background: ${statusColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; text-transform: uppercase;">
                                        ${item.status || 'Available'}
                                    </span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="editPurchaseRecord(${index})" style="background: #4ecdc4; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Edit">
                                        
                                    </button>
                                    <button onclick="deletePurchaseRecord(${index})" style="background: #ff6b6b; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Delete">
                                        
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 12px;">
                            <div>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Purchase Cost:</strong> ${item.purchaseCost.toFixed(2)}
                                </p>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Selling Price:</strong> ${item.sellingPrice.toFixed(2)}
                                </p>
                                <p style="margin: 5px 0; color: ${profitColor}; font-size: 14px;">
                                    <strong> Potential Profit:</strong> ${profit.toFixed(2)} (${profitMargin}%)
                                </p>
                            </div>
                            <div>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Purchase Date:</strong> ${new Date(item.purchaseDate).toLocaleDateString()}
                                </p>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Supplier:</strong> ${item.supplier || 'Not specified'}
                                </p>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Quantity:</strong> ${item.quantity || 1}
                                </p>
                            </div>
                        </div>

                        ${item.notes ? `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <p style="margin: 0; color: #666; font-size: 13px;">
                                    <strong> Notes:</strong> ${item.notes}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Add new purchase record - Show form instead of prompts
        function addToPurchaseHistory() {
            const form = document.getElementById('add-purchase-form');
            if (form.style.display === 'none' || form.style.display === '') {
                // Show the form and scroll to it
                form.style.display = 'block';
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Clear any previous values
                document.getElementById('supplier-name').value = '';
                document.getElementById('purchase-name').value = '';
                document.getElementById('purchase-cost').value = '';
                document.getElementById('purchase-category').value = '';
                document.getElementById('selling-price').value = '';
                document.getElementById('purchase-quantity').value = '1';
                document.getElementById('purchase-notes').value = '';
                } else {
                // Hide the form if it's already shown
                form.style.display = 'none';
            }
        }

        // Cancel adding purchase - Hide the form
        function cancelAddPurchase() {
            const form = document.getElementById('add-purchase-form');
            form.style.display = 'none';
        }

        // Save purchase from form data
        function savePurchaseFromForm() {
            const supplierName = document.getElementById('supplier-name').value.trim();
            const purchaseName = document.getElementById('purchase-name').value.trim();
            const purchaseCost = parseFloat(document.getElementById('purchase-cost').value);
            const category = document.getElementById('purchase-category').value.trim();
                // Focus on the first input
                document.getElementById('supplier-name').focus();

            const sellingPrice = parseFloat(document.getElementById('selling-price').value);
            const quantity = parseInt(document.getElementById('purchase-quantity').value) || 1;
            const notes = document.getElementById('purchase-notes').value.trim();

            // Validation
            if (!supplierName) {
                alert(' Please enter supplier name.');
                document.getElementById('supplier-name').focus();
                return;
            }

            if (!purchaseName) {
                alert(' Please enter purchase name (item name).');
                document.getElementById('purchase-name').focus();
                return;
            }

            if (isNaN(purchaseCost) || purchaseCost <= 0) {
                alert(' Please enter a valid purchase cost.');
                document.getElementById('purchase-cost').focus();
                return;
            }

            if (sellingPrice && (isNaN(sellingPrice) || sellingPrice <= 0)) {
                alert(' Please enter a valid selling price or leave it empty.');
                document.getElementById('selling-price').focus();
                return;
            }

            // Create purchase record
            const purchaseRecord = {
                id: Date.now().toString(),
                itemName: purchaseName,
                category: category || 'General',
                purchaseCost: purchaseCost,
                sellingPrice: sellingPrice || 0,
                supplier: supplierName,
                quantity: quantity,
                status: 'available',
                purchaseDate: new Date().toISOString().split('T')[0],
                notes: notes
            };

            // Add to data and save
            purchaseData.unshift(purchaseRecord);
            savePurchaseData();
            loadPurchaseHistory();

            // Hide form and show success message
            document.getElementById('add-purchase-form').style.display = 'none';
            alert(' Purchase record added successfully!');
        }

        // Handle Enter key in purchase form
        document.addEventListener('DOMContentLoaded', function() {
            const purchaseFormInputs = document.querySelectorAll('#add-purchase-form input, #add-purchase-form textarea');
            purchaseFormInputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        // If it's the last input or textarea, save the form
                        if (input.id === 'purchase-notes') {
                            savePurchaseFromForm();
                        } else {
                            // Move to next input
                            const inputs = Array.from(purchaseFormInputs);
                            const currentIndex = inputs.indexOf(input);
                            if (currentIndex < inputs.length - 1) {
                                inputs[currentIndex + 1].focus();
                            }
                        }
                    }
                });
            });
        });

        // Edit purchase record
        function editPurchaseRecord(index) {
            const item = purchaseData[index];
            if (!item) return;

            const newItemName = prompt('Edit item name:', item.itemName);
            if (newItemName === null) return;

            const newCategory = prompt('Edit category:', item.category);
            if (newCategory === null) return;

            const newPurchaseCost = parseFloat(prompt('Edit purchase cost:', item.purchaseCost));
            if (isNaN(newPurchaseCost)) return;

            const newSellingPrice = parseFloat(prompt('Edit selling price:', item.sellingPrice));
            if (isNaN(newSellingPrice)) return;

            const newSupplier = prompt('Edit supplier:', item.supplier || '');
            const newQuantity = parseInt(prompt('Edit quantity:', item.quantity || 1));
            const newNotes = prompt('Edit notes:', item.notes || '');

            purchaseData[index] = {
                ...item,
                itemName: newItemName.trim(),
                category: newCategory.trim(),
                purchaseCost: newPurchaseCost,
                sellingPrice: newSellingPrice,
                supplier: (newSupplier || '').trim() || 'Not specified',
                quantity: isNaN(newQuantity) ? 1 : newQuantity,
                notes: (newNotes || '').trim()
            };

            savePurchaseData();
            loadPurchaseHistory();
            alert(' Purchase record updated successfully!');
        }

        // Delete purchase record
        function deletePurchaseRecord(index) {
            const item = purchaseData[index];
            if (!item) return;

            if (confirm(`Are you sure you want to delete "${item.itemName}"?`)) {
                purchaseData.splice(index, 1);
                savePurchaseData();
                loadPurchaseHistory();
                alert(' Purchase record deleted successfully!');
            }
        }

        // Filter purchases based on search
        function filterPurchases() {
            const searchTerm = document.getElementById('purchase-search').value.toLowerCase();

            if (!searchTerm) {
                displayPurchaseRecords();
                return;
            }

            const filteredPurchases = purchaseData.filter(item =>
                item.itemName.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm) ||
                (item.supplier && item.supplier.toLowerCase().includes(searchTerm))
            );

            const container = document.getElementById('purchase-records');
            const noDataMessage = document.getElementById('no-purchase-message');

            if (filteredPurchases.length === 0) {
                container.innerHTML = '';
                noDataMessage.style.display = 'block';
                noDataMessage.innerHTML = `
                    <h3 style="color: #999;"> No Purchase Records Found</h3>
                    <p>No purchases match your search term "${searchTerm}"</p>
                `;
                return;
            }

            noDataMessage.style.display = 'none';
            // Display filtered results (reuse the same display logic)
            const sortedPurchases = [...filteredPurchases].sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate));

            container.innerHTML = sortedPurchases.map((item, index) => {
                const originalIndex = purchaseData.findIndex(p => p.id === item.id);
                const profitMargin = ((item.sellingPrice - item.purchaseCost) / item.sellingPrice * 100).toFixed(1);
                const profit = item.sellingPrice - item.purchaseCost;
                const profitColor = profit >= 0 ? '#10B981' : '#EF4444';
                const statusColor = item.status === 'sold' ? '#10B981' : item.status === 'reserved' ? '#F59E0B' : '#6B7280';

                return `
                    <div class="purchase-record-item">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h4 style="color: #333; margin: 0 0 5px 0; font-size: 16px;">${item.itemName}</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                    <span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px;">
                                        ${getCategoryIcon(item.category)} ${item.category}
                                    </span>
                                    <span style="background: ${statusColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; text-transform: uppercase;">
                                        ${item.status || 'Available'}
                                    </span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="editPurchaseRecord(${originalIndex})" style="background: #4ecdc4; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Edit">
                                        
                                    </button>
                                    <button onclick="deletePurchaseRecord(${originalIndex})" style="background: #ff6b6b; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Delete">
                                        
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 12px;">
                            <div>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Purchase Cost:</strong> ${item.purchaseCost.toFixed(2)}
                                </p>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Selling Price:</strong> ${item.sellingPrice.toFixed(2)}
                                </p>
                                <p style="margin: 5px 0; color: ${profitColor}; font-size: 14px;">
                                    <strong> Potential Profit:</strong> ${profit.toFixed(2)} (${profitMargin}%)
                                </p>
                            </div>
                            <div>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Purchase Date:</strong> ${new Date(item.purchaseDate).toLocaleDateString()}
                                </p>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Supplier:</strong> ${item.supplier || 'Not specified'}
                                </p>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong> Quantity:</strong> ${item.quantity || 1}
                                </p>
                            </div>
                        </div>

                        ${item.notes ? `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <p style="margin: 0; color: #666; font-size: 13px;">
                                    <strong> Notes:</strong> ${item.notes}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Clear purchase search filter
        function clearPurchaseFilter() {
            document.getElementById('purchase-search').value = '';
            displayPurchaseRecords();
        }

        // Export purchase history to Excel
        function exportPurchaseHistory() {
            if (purchaseData.length === 0) {
                alert('No purchase records to export!');
                return;
            }

            try {
                const dataToExport = purchaseData.map(item => ({
                    'Item Name': item.itemName,
                    'Category': item.category,
                    'Purchase Cost ()': item.purchaseCost.toFixed(2),
                    'Selling Price ()': item.sellingPrice.toFixed(2),
                    'Potential Profit ()': (item.sellingPrice - item.purchaseCost).toFixed(2),
                    'Profit Margin (%)': (((item.sellingPrice - item.purchaseCost) / item.sellingPrice) * 100).toFixed(1),
                    'Purchase Date': item.purchaseDate,
                    'Supplier': item.supplier || 'Not specified',
                    'Quantity': item.quantity || 1,
                    'Status': item.status || 'Available',
                    'Notes': item.notes || ''
                }));

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Purchase History');

                const fileName = `Purchase_History_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert(` Purchase history exported successfully!\n\nFile: ${fileName}\nRecords: ${purchaseData.length}`);

            } catch (error) {
                console.error('Error exporting purchase history:', error);
                alert('Error exporting purchase history: ' + error.message);
            }
        }

        // Initialize purchase data when the app loads
        document.addEventListener('DOMContentLoaded', function() {
            initializePurchaseData();
            updatePurchaseCount();
            loadSalesSummaryTable();
        });

        // ======== SALES SUMMARY TABLE FUNCTIONS ========

        // Global variables for summary table pagination
        let currentSummaryPage = 1;
        let summaryItemsPerPage = 10;
        let filteredSummaryData = [];
        let originalSummaryData = [];

        // Load Sales Summary Table
        function loadSalesSummaryTable() {
            try {
                // Get all sales data and transform for summary table
                originalSummaryData = salesData.map((sale, index) => ({
                    id: sale.id || index,
                    customerName: sale.customerName || 'N/A',
                    phone: sale.customerPhone || '',
                    email: sale.customerEmail || '', // This might not exist, keeping for future use
                    date: sale.saleDate || '',
                    sellingPrice: sale.sellingPrice || 0,
                    itemName: sale.itemName || '',
                    category: sale.category || '',
                    costPrice: sale.costPrice || 0,
                    profit: sale.profit || 0,
                    customerAddress: sale.customerAddress || '',
                    originalIndex: index
                }));

                // Sort by date (newest first)
                originalSummaryData.sort((a, b) => new Date(b.date) - new Date(a.date));

                filteredSummaryData = [...originalSummaryData];
                currentSummaryPage = 1;
                renderSummaryTable();
                updateSummaryPagination();

                // Update the sales statistics summary
                updateSalesSummary();

            } catch (error) {
                console.error('Error loading sales summary table:', error);
                showError('Error loading sales summary table');
            }
        }

        // Render Summary Table
        function renderSummaryTable() {
            const tableBody = document.getElementById('summary-table-body');
            const noDataRow = document.getElementById('no-summary-data');

            if (!tableBody) return;

            // Clear existing rows except no-data row
            tableBody.innerHTML = '<tr id="no-summary-data" style="display: none;"><td colspan="6" style="padding: 60px 20px; text-align: center; color: #999; font-style: italic;"><div style="display: flex; flex-direction: column; align-items: center; gap: 15px;"><i class="fas fa-inbox" style="font-size: 48px; color: #ddd;"></i><div><h4 style="margin: 0 0 8px 0; color: #666;">No Sales Data Found</h4><p style="margin: 0; font-size: 14px;">Add your first sale or adjust the search filters</p></div></div></td></tr>';

            if (filteredSummaryData.length === 0) {
                document.getElementById('no-summary-data').style.display = 'table-row';
                return;
            }

            // Calculate pagination
            const startIndex = (currentSummaryPage - 1) * summaryItemsPerPage;
            const endIndex = startIndex + summaryItemsPerPage;
            const pageData = filteredSummaryData.slice(startIndex, endIndex);

            // Generate table rows
            const rows = pageData.map(sale => {
                const formattedDate = sale.date ? new Date(sale.date).toLocaleDateString('en-IN') : 'N/A';
                const formattedPrice = `${sale.sellingPrice.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;

                return `
                    <tr class="summary-row" style="transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                        <td style="padding: 15px; border-bottom: 1px solid #e9ecef; font-weight: 500;">
                            <div style="display: flex; flex-direction: column;">
                                <span style="color: #333; font-size: 14px;">${sale.customerName}</span>
                                <small style="color: #666; font-size: 12px; margin-top: 2px;">
                                    <i class="fas fa-gem" style="color: #667eea;"></i> ${sale.itemName}
                                </small>
                            </div>
                        </td>
                        <td style="padding: 15px; border-bottom: 1px solid #e9ecef; color: #555;">
                            ${sale.phone ? `<i class="fas fa-phone" style="color: #10B981; margin-right: 5px;"></i>${sale.phone}` : '<span style="color: #999; font-style: italic;">Not provided</span>'}
                        </td>
                        <td style="padding: 15px; border-bottom: 1px solid #e9ecef; color: #555;">
                            ${sale.email ? `<i class="fas fa-envelope" style="color: #667eea; margin-right: 5px;"></i>${sale.email}` : '<span style="color: #999; font-style: italic;">Not provided</span>'}
                        </td>
                        <td style="padding: 15px; border-bottom: 1px solid #e9ecef; text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <span style="color: #333; font-weight: 500; font-size: 14px;">${formattedDate}</span>
                                <small style="color: #666; font-size: 11px; margin-top: 2px;">${sale.category}</small>
                            </div>
                        </td>
                        <td style="padding: 15px; border-bottom: 1px solid #e9ecef; text-align: right;">
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <span style="color: #10B981; font-weight: 600; font-size: 15px;">${formattedPrice}</span>
                                <small style="color: ${sale.profit >= 0 ? '#10B981' : '#DC2626'}; font-size: 11px; margin-top: 2px;">
                                    Profit: ${sale.profit.toLocaleString('en-IN', { maximumFractionDigits: 2 })}
                                </small>
                            </div>
                        </td>
                        <td style="padding: 15px; border-bottom: 1px solid #e9ecef; text-align: center;">
                            <div style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="generatePDFReceipt(${sale.id})"
                                        style="background: #10B981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;"
                                        onmouseover="this.style.background='#059669'"
                                        onmouseout="this.style.background='#10B981'"
                                        title="Generate PDF receipt">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button onclick="editSummaryRecord(${sale.id})"
                                        style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;"
                                        onmouseover="this.style.background='#5a67d8'"
                                        onmouseout="this.style.background='#667eea'"
                                        title="Edit this sale record">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="deleteSummaryRecord(${sale.id})"
                                        style="background: #DC2626; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;"
                                        onmouseover="this.style.background='#B91C1C'"
                                        onmouseout="this.style.background='#DC2626'"
                                        title="Delete this sale record">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = '<tr id="no-summary-data" style="display: none;"><td colspan="6" style="padding: 60px 20px; text-align: center; color: #999; font-style: italic;"><div style="display: flex; flex-direction: column; align-items: center; gap: 15px;"><i class="fas fa-inbox" style="font-size: 48px; color: #ddd;"></i><div><h4 style="margin: 0 0 8px 0; color: #666;">No Sales Data Found</h4><p style="margin: 0; font-size: 14px;">Add your first sale or adjust the search filters</p></div></div></td></tr>' + rows;
        }

        // Filter Sales Summary
        function filterSalesSummary() {
            const searchTerm = document.getElementById('summary-search').value.toLowerCase();
            const dateFilter = document.getElementById('date-filter').value;

            filteredSummaryData = originalSummaryData.filter(sale => {
                // Text search
                const matchesSearch = !searchTerm ||
                    sale.customerName.toLowerCase().includes(searchTerm) ||
                    sale.phone.toLowerCase().includes(searchTerm) ||
                    sale.email.toLowerCase().includes(searchTerm) ||
                    sale.itemName.toLowerCase().includes(searchTerm) ||
                    sale.category.toLowerCase().includes(searchTerm);

                // Date filter
                let matchesDate = true;
                if (dateFilter !== 'all' && sale.date) {
                    const saleDate = new Date(sale.date);
                    const today = new Date();

                    switch (dateFilter) {
                        case 'today':
                            matchesDate = saleDate.toDateString() === today.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                            matchesDate = saleDate >= weekAgo;
                            break;
                        case 'month':
                            matchesDate = saleDate.getMonth() === today.getMonth() &&
                                         saleDate.getFullYear() === today.getFullYear();
                            break;
                        case 'year':
                            matchesDate = saleDate.getFullYear() === today.getFullYear();
                            break;
                    }
                }

                return matchesSearch && matchesDate;
            });

            currentSummaryPage = 1;
            renderSummaryTable();
            updateSummaryPagination();

            // Update sales statistics with filtered data
            updateSalesSummaryWithFilteredData();
        }

        // Update Sales Summary with Filtered Data
        function updateSalesSummaryWithFilteredData() {
            const totalSales = filteredSummaryData.length;
            const totalCost = filteredSummaryData.reduce((sum, sale) => sum + (sale.costPrice || 0), 0);
            const totalSelling = filteredSummaryData.reduce((sum, sale) => sum + (sale.sellingPrice || 0), 0);
            const totalProfit = totalSelling - totalCost;

            document.getElementById('summary-total-sales').textContent = totalSales;
            document.getElementById('summary-total-cost').textContent = `${(totalCost || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('summary-total-selling').textContent = `${(totalSelling || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('summary-total-profit').textContent = `${(totalProfit || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Clear Summary Filter
        function clearSummaryFilter() {
            document.getElementById('summary-search').value = '';
            document.getElementById('date-filter').value = 'all';
            filterSalesSummary();
        }

        // Update Summary Pagination
        function updateSummaryPagination() {
            const totalItems = filteredSummaryData.length;
            const totalPages = Math.ceil(totalItems / summaryItemsPerPage);
            const startItem = (currentSummaryPage - 1) * summaryItemsPerPage + 1;
            const endItem = Math.min(currentSummaryPage * summaryItemsPerPage, totalItems);

            document.getElementById('summary-showing-start').textContent = totalItems > 0 ? startItem : 0;
            document.getElementById('summary-showing-end').textContent = totalItems > 0 ? endItem : 0;
            document.getElementById('summary-total-count').textContent = totalItems;
            document.getElementById('summary-page-info').textContent = `Page ${totalPages > 0 ? currentSummaryPage : 0} of ${totalPages}`;

            // Update button states
            const prevBtn = document.getElementById('summary-prev-btn');
            const nextBtn = document.getElementById('summary-next-btn');

            if (prevBtn) {
                prevBtn.disabled = currentSummaryPage <= 1;
                prevBtn.style.opacity = currentSummaryPage <= 1 ? '0.5' : '1';
                prevBtn.style.cursor = currentSummaryPage <= 1 ? 'not-allowed' : 'pointer';
            }

            if (nextBtn) {
                nextBtn.disabled = currentSummaryPage >= totalPages;
                nextBtn.style.opacity = currentSummaryPage >= totalPages ? '0.5' : '1';
                nextBtn.style.cursor = currentSummaryPage >= totalPages ? 'not-allowed' : 'pointer';
            }
        }

        // Change Summary Page
        function changeSummaryPage(direction) {
            const totalPages = Math.ceil(filteredSummaryData.length / summaryItemsPerPage);
            const newPage = currentSummaryPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                currentSummaryPage = newPage;
                renderSummaryTable();
                updateSummaryPagination();
            }
        }

        // Edit Summary Record
        function editSummaryRecord(saleId) {
            // Find the sale in the original sales data
            const saleIndex = salesData.findIndex(sale => (sale.id || salesData.indexOf(sale)) === saleId);
            if (saleIndex !== -1) {
                editSale(saleId);
                // After editing, refresh the summary table
                setTimeout(() => {
                    loadSalesSummaryTable();
                }, 100);
            } else {
                showError('Sale record not found!');
            }
        }

        // Delete Summary Record
        function deleteSummaryRecord(saleId) {
            if (confirm('Are you sure you want to delete this sale record? This action cannot be undone.')) {
                // Find the sale in the original sales data
                const saleIndex = salesData.findIndex(sale => (sale.id || salesData.indexOf(sale)) === saleId);
                if (saleIndex !== -1) {
                    deleteSale(saleId);
                    // After deleting, refresh the summary table
                    setTimeout(() => {
                        loadSalesSummaryTable();
                    }, 100);
                } else {
                    showError('Sale record not found!');
                }
            }
        }

        // Generate PDF Receipt
        function generatePDFReceipt(saleId) {
            try {
                // Find the sale data
                const sale = salesData.find(s => (s.id || salesData.indexOf(s)) === saleId);
                if (!sale) {
                    showError('Sale record not found!');
                    return;
                }

                // Create PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Add logo or header
                doc.setFontSize(24);
                doc.setTextColor(102, 126, 234);
                doc.setFont(undefined, 'bold');
                doc.text('Theia Jewelz', 20, 25);

                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.setFont(undefined, 'normal');
                doc.text('Premium Jewelry Collection', 20, 35);

                // Add a line
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.5);
                doc.line(20, 45, 190, 45);

                // Format date as requested (e.g., "22 July 2025")
                const saleDate = sale.saleDate ? new Date(sale.saleDate) : new Date();
                const formattedDate = saleDate.toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                // Receipt details
                let yPos = 60;
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');

                doc.text(`Date: ${formattedDate}`, 20, yPos);
                yPos += 10;
                doc.text(`Customer Name: ${sale.customerName || 'N/A'}`, 20, yPos);
                yPos += 10;
                doc.text(`Shipping Address: ${sale.customerAddress || 'Not provided'}`, 20, yPos);
                yPos += 20;

                // Table header
                doc.setFont(undefined, 'bold');
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);

                // Table headers
                doc.text('Sr.', 25, yPos);
                doc.text('Item', 40, yPos);
                doc.text('Qty', 120, yPos);
                doc.text('Price', 140, yPos);
                doc.text('Total', 165, yPos);

                // Header line
                doc.line(20, yPos + 3, 190, yPos + 3);
                yPos += 15;

                // Table content
                doc.setFont(undefined, 'normal');
                const quantity = sale.quantity || 1;
                const unitPrice = sale.sellingPrice || 0;
                const totalPrice = unitPrice * quantity;

                doc.text('1', 25, yPos);
                doc.text(sale.itemName || 'N/A', 40, yPos);
                doc.text(quantity.toString(), 120, yPos);
                doc.text(`${unitPrice.toLocaleString('en-IN')}`, 140, yPos);
                doc.text(`${totalPrice.toLocaleString('en-IN')}`, 165, yPos);

                yPos += 15;

                // Bottom line of table
                doc.line(20, yPos, 190, yPos);
                yPos += 20;

                // Summary section
                const subtotal = totalPrice;
                const discount = 0; // Can be made dynamic later
                const shipping = sale.shippingAmount || 0; // Get shipping from sale data
                const finalTotal = subtotal - discount + shipping;

                doc.setFont(undefined, 'normal');
                doc.text(`Subtotal: ${subtotal.toLocaleString('en-IN')}`, 120, yPos);
                yPos += 10;
                doc.text(`Discount: ${discount.toLocaleString('en-IN')}`, 120, yPos);
                yPos += 10;

                // Show shipping amount and free/paid status
                const shippingText = shipping === 0 ?
                    `Shipping: ${shipping.toLocaleString('en-IN')} (Free Shipping)` :
                    `Shipping: ${shipping.toLocaleString('en-IN')}`;
                doc.text(shippingText, 120, yPos);
                yPos += 15;

                // Total amount in a box
                doc.setDrawColor(102, 126, 234);
                doc.setFillColor(240, 245, 255);
                doc.rect(115, yPos - 5, 75, 15, 'FD');

                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.setTextColor(102, 126, 234);
                doc.text(`Total Amount: ${finalTotal.toLocaleString('en-IN')}`, 120, yPos + 5);

                yPos += 25;

                // Payment details
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const paymentMode = sale.paymentMode || 'UPI';
                const paymentText = paymentMode === 'UPI' ?
                    `Payment Mode: ${paymentMode} (PhonePe/GPay/Paytm)` :
                    `Payment Mode: ${paymentMode}`;
                doc.text(paymentText, 20, yPos);
                yPos += 10;
                doc.text('Status: Paid', 20, yPos);

                yPos += 20;

                // Footer
                doc.setDrawColor(200, 200, 200);
                doc.line(20, yPos, 190, yPos);
                yPos += 15;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text('Thank you for choosing Theia Jewelz!', 20, yPos);
                doc.text('For any queries, please contact us.', 20, yPos + 8);
                doc.text(`Receipt generated on: ${new Date().toLocaleDateString('en-IN')} at ${new Date().toLocaleTimeString('en-IN')}`, 20, yPos + 16);

                if (sale.trackingId) {
                    doc.text(`Tracking ID: ${sale.trackingId}`, 20, yPos + 24);
                }

                // Generate filename
                const customerName = (sale.customerName || 'Customer').replace(/[^a-zA-Z0-9]/g, '_');
                const dateStr = formattedDate.replace(/[^a-zA-Z0-9]/g, '_');
                const filename = `Receipt_${customerName}_${dateStr}.pdf`;

                // Save the PDF
                doc.save(filename);

                showSuccess(`Receipt generated successfully! File: ${filename}`);

            } catch (error) {
                console.error('Error generating PDF receipt:', error);
                showError('Error generating PDF receipt: ' + error.message);
            }
        }

        // Refresh Sales Summary
        function refreshSalesSummary() {
            showSuccess('Refreshing sales summary...');
            loadSalesSummaryTable();
        }

        // Export Sales Summary
        function exportSalesSummary() {
            if (filteredSummaryData.length === 0) {
                alert('No sales data to export!');
                return;
            }

            try {
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();

                // Prepare data for export
                const exportData = filteredSummaryData.map((sale, index) => ({
                    'Sr. No.': index + 1,
                    'Customer Name': sale.customerName,
                    'Phone Number': sale.phone || 'Not provided',
                    'Email': sale.email || 'Not provided',
                    'Date': sale.date ? new Date(sale.date).toLocaleDateString('en-IN') : 'N/A',
                    'Item Name': sale.itemName,
                    'Category': sale.category,
                    'Cost Price ()': sale.costPrice,
                    'Selling Price ()': sale.sellingPrice,
                    'Profit ()': sale.profit,
                    'Customer Address': sale.customerAddress || 'Not provided'
                }));

                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Set column widths
                const colWidths = [
                    { wch: 8 },   // Sr. No.
                    { wch: 20 },  // Customer Name
                    { wch: 15 },  // Phone Number
                    { wch: 25 },  // Email
                    { wch: 12 },  // Date
                    { wch: 25 },  // Item Name
                    { wch: 12 },  // Category
                    { wch: 12 },  // Cost Price
                    { wch: 12 },  // Selling Price
                    { wch: 12 },  // Profit
                    { wch: 30 }   // Customer Address
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Sales Summary');

                // Generate filename with current date
                const today = new Date();
                const fileName = `Sales_Summary_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}.xlsx`;

                // Write and download file
                XLSX.writeFile(wb, fileName);

                showSuccess(`Sales summary exported successfully! File: ${fileName}`);

            } catch (error) {
                console.error('Error exporting sales summary:', error);
                showError('Error exporting sales summary: ' + error.message);
            }
        }

        // Initialize summary table when recent-sales tab is shown
        function initializeSummaryOnTabShow() {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const recentSalesTab = document.getElementById('recent-sales');
                        if (recentSalesTab && recentSalesTab.classList.contains('active')) {
                            // Tab is now active, load the summary table
                            setTimeout(() => {
                                loadSalesSummaryTable();
                            }, 100);
                        }
                    }
                });
            });

            const recentSalesTab = document.getElementById('recent-sales');
            if (recentSalesTab) {
                observer.observe(recentSalesTab, { attributes: true });
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeSummaryOnTabShow();
        });

    </script>

    <!-- Mobile-friendly modal for alerts (future enhancement) -->
    <div id="mobile-modal" class="mobile-modal">
        <div class="mobile-modal-content">
            <div id="mobile-modal-header" class="mobile-modal-header"></div>
            <div id="mobile-modal-body" class="mobile-modal-body"></div>
            <div class="mobile-modal-buttons">
                <button id="mobile-modal-ok" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>



    <!-- Enhanced loading overlay -->
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
         background: rgba(102, 126, 234, 0.9); z-index: 9999; align-items: center; justify-content: center;">
        <div style="text-align: center; color: white;">
            <div class="loading-spinner" style="width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3);
                 border-top: 4px solid white; margin: 0 auto 20px;"></div>
            <h3 style="margin: 0; font-weight: 300;">Processing...</h3>
            <p style="margin: 10px 0 0; opacity: 0.8;">Please wait while we save your data</p>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div id="shortcuts-help" class="shortcuts-help">
        <h4><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h4>
        <ul>
            <li><span>New Sale</span> <span class="key">Ctrl+N</span></li>
            <li><span>Recent Sales</span> <span class="key">Ctrl+R</span></li>
            <li><span>Save Sale</span> <span class="key">Ctrl+S</span></li>
            <li><span>Help</span> <span class="key">F1</span></li>
            <li><span>Close Help</span> <span class="key">Esc</span></li>
        </ul>
        <div style="text-align: center; margin-top: 10px;">
            <button onclick="toggleShortcutsHelp()" style="background: var(--primary-600); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </div>
</body>
</html>
